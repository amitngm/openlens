# Public IP Allocation Flow
# 
# This flow tests the public IP allocation workflow including:
# - UI: Allocating a public IP and verifying status transitions
# - API: Verifying TCPWave record and NAT state
# - K8s: Verifying related services are reachable
#
# Required variables:
#   - testTenant: true (required by TEST_ACCOUNT_GUARD)
#   - region: Target region for IP allocation
#
# Placeholders:
#   - TCPWave API endpoints are placeholders - replace with actual endpoints
#   - NAT API endpoints are placeholders - replace with actual endpoints

name: public-ip-allocation
description: "Test public IP allocation workflow with status verification"
version: "1.0.0"
author: "QA Agent Team"
tags:
  - smoke
  - ip-allocation
  - network

allowed_environments:
  - dev
  - staging
  - qa

required_variables:
  - testTenant
  - region

default_variables:
  testTenant: true
  region: "us-east-1"
  ipCount: 1
  ipName: "qa-test-ip"
  waitForAllocation: true

timeout_ms: 600000  # 10 minutes
capture_screenshots: true
capture_video: false
capture_har: true

# Setup steps - run before main flow
setup:
  - name: "Login to CMP"
    description: "Authenticate to the CMP UI using test credentials"
    type: ui
    ui:
      action: navigate
      url: "${UI_BASE_URL}/login"
      timeout_ms: 30000

  - name: "Enter username"
    type: ui
    ui:
      action: fill
      selector: "input[name='username'], input[type='email'], #username"
      value: "${UI_USERNAME}"

  - name: "Enter password"
    type: ui
    ui:
      action: fill
      selector: "input[name='password'], input[type='password'], #password"
      value: "${UI_PASSWORD}"

  - name: "Submit login form"
    type: ui
    ui:
      action: click
      selector: "button[type='submit'], .login-button, #login-submit"
      wait_for: ".dashboard, .home, [data-testid='dashboard']"
      wait_timeout_ms: 30000
      screenshot: true

  - name: "Verify login success"
    type: ui
    ui:
      action: wait_for_text
      value: "Dashboard"
      timeout_ms: 10000

# Main test steps
steps:
  # Step 1: Navigate to IP Allocation
  - name: "Navigate to Network section"
    description: "Go to the Network/IP Management section"
    type: ui
    ui:
      action: click
      selector: "[data-testid='nav-network'], .nav-network, a[href*='network']"
      wait_for: ".ip-management, .network-panel"
      timeout_ms: 15000
      screenshot: true

  - name: "Open IP Allocation"
    type: ui
    ui:
      action: click
      selector: "[data-testid='ip-allocation'], .ip-allocation-link, a[href*='ip-allocation']"
      wait_for: ".allocation-form, .ip-form"
      timeout_ms: 15000

  # Step 2: Allocate Public IP via UI
  - name: "Click Allocate New IP"
    type: ui
    ui:
      action: click
      selector: "button.allocate-ip, [data-testid='allocate-ip-btn'], .btn-allocate"
      wait_for: ".allocation-modal, .ip-allocation-dialog"
      timeout_ms: 10000
      screenshot: true

  - name: "Enter IP Name"
    type: ui
    ui:
      action: fill
      selector: "input[name='ipName'], #ip-name, [data-testid='ip-name-input']"
      value: "${ipName}-${RUN_ID}"

  - name: "Select Region"
    type: ui
    ui:
      action: select
      selector: "select[name='region'], #region-select, [data-testid='region-select']"
      value: "${region}"

  - name: "Select IP Type - Public"
    type: ui
    ui:
      action: click
      selector: "input[value='public'], [data-testid='ip-type-public'], label:has-text('Public')"

  - name: "Submit IP Allocation Request"
    type: ui
    ui:
      action: click
      selector: "button[type='submit'].allocate, [data-testid='submit-allocation'], .btn-submit-allocation"
      screenshot: true
      wait_for: ".allocation-status, .ip-status"
      timeout_ms: 30000

  # Step 3: Verify status transitions (Allocating -> Created)
  - name: "Verify Allocating Status"
    description: "Check that IP shows 'Allocating' status initially"
    type: ui
    ui:
      action: wait_for_text
      value: "Allocating"
      timeout_ms: 30000
      screenshot: true
    continue_on_failure: true

  - name: "Wait for Allocation"
    type: ui
    ui:
      action: wait
      timeout_ms: 5000

  - name: "Wait for Created Status"
    description: "Wait for IP allocation to complete"
    type: ui
    ui:
      action: wait_for_text
      value: "Created"
      timeout_ms: 120000
      screenshot: true

  - name: "Capture allocated IP address"
    type: ui
    ui:
      action: screenshot
      screenshot: true

  # Step 4: Get IP details via API
  - name: "Get Allocated IP Details"
    description: "Fetch IP details from CMP API"
    type: api
    api:
      method: GET
      url: "${API_BASE_URL}/api/v1/network/public-ips"
      bearer_token: "${API_TOKEN}"
      query_params:
        name: "${ipName}-${RUN_ID}"
        tenant: "${tenant}"
      expected_status: 200
      timeout_ms: 30000
      assertions:
        - type: exists
          target: "$.data"
          message: "IP data should exist in response"
        - type: greater_than
          target: "$.data.length"
          expected: 0
          message: "Should have at least one IP"
      extract:
        allocatedIpId: "$.data[0].id"
        allocatedIpAddress: "$.data[0].address"
        tcpwaveRecordId: "$.data[0].tcpwaveRecordId"

  # Step 5: Verify TCPWave record (PLACEHOLDER - replace with actual endpoint)
  - name: "Verify TCPWave Record"
    description: "Verify IP is registered in TCPWave IPAM"
    type: api
    api:
      method: GET
      # PLACEHOLDER: Replace with actual TCPWave API endpoint
      url: "${API_BASE_URL}/api/v1/integrations/tcpwave/records/${tcpwaveRecordId}"
      bearer_token: "${API_TOKEN}"
      expected_status: 200
      timeout_ms: 30000
      retries: 2
      retry_delay_ms: 5000
      assertions:
        - type: equals
          target: "$.status"
          expected: "active"
          message: "TCPWave record should be active"
        - type: equals
          target: "$.ipAddress"
          expected: "${allocatedIpAddress}"
          message: "TCPWave record should have correct IP"
      log_response: true

  # Step 6: Verify NAT state (PLACEHOLDER - replace with actual endpoint)
  - name: "Check NAT State - Initial"
    description: "Verify NAT state is Creating initially"
    type: api
    api:
      method: GET
      # PLACEHOLDER: Replace with actual NAT state endpoint
      url: "${API_BASE_URL}/api/v1/network/nat/${allocatedIpId}/state"
      bearer_token: "${API_TOKEN}"
      expected_status: 200
      timeout_ms: 30000
      assertions:
        - type: contains
          target: "$.state"
          expected: "Creating"
          message: "NAT state should be Creating initially"
    continue_on_failure: true
    wait_after_ms: 5000

  - name: "Wait for NAT Provisioning"
    type: ui
    ui:
      action: wait
      timeout_ms: 10000

  - name: "Check NAT State - Created"
    description: "Verify NAT state transitions to Created"
    type: api
    api:
      method: GET
      url: "${API_BASE_URL}/api/v1/network/nat/${allocatedIpId}/state"
      bearer_token: "${API_TOKEN}"
      expected_status: 200
      timeout_ms: 30000
      retries: 3
      retry_delay_ms: 10000
      assertions:
        - type: equals
          target: "$.state"
          expected: "Created"
          message: "NAT state should be Created after provisioning"

  # Step 7: Optional K8s checks
  - name: "Verify Network Service Reachable"
    description: "Check that the network service is available in the cluster"
    type: k8s
    k8s:
      check_type: service_available
      resource_name: "network-service"
      namespace: "${NAMESPACE}"
      timeout_ms: 30000
    continue_on_failure: true

  - name: "Verify IP Controller Pod Ready"
    description: "Check that IP controller pod is running"
    type: k8s
    k8s:
      check_type: pod_ready
      label_selector: "app=ip-controller"
      namespace: "${NAMESPACE}"
      timeout_ms: 30000
    continue_on_failure: true

  # Step 8: Final verification via UI
  - name: "Verify IP in UI List"
    type: ui
    ui:
      action: navigate
      url: "${UI_BASE_URL}/network/public-ips"
      wait_for: ".ip-list, .ip-table"
      timeout_ms: 15000

  - name: "Search for Allocated IP"
    type: ui
    ui:
      action: fill
      selector: "input[type='search'], .search-input, [data-testid='ip-search']"
      value: "${ipName}-${RUN_ID}"

  - name: "Verify IP Appears in List"
    type: ui
    ui:
      action: wait_for_text
      value: "${allocatedIpAddress}"
      timeout_ms: 30000
      screenshot: true

# Teardown steps - always run, even on failure
teardown:
  - name: "Cleanup - Delete Test IP"
    description: "Remove the test IP allocation"
    type: api
    api:
      method: DELETE
      url: "${API_BASE_URL}/api/v1/network/public-ips/${allocatedIpId}"
      bearer_token: "${API_TOKEN}"
      expected_status: 200
      timeout_ms: 30000
    continue_on_failure: true

  - name: "Logout"
    type: ui
    ui:
      action: click
      selector: ".logout-btn, [data-testid='logout'], a[href*='logout']"
      timeout_ms: 10000
    continue_on_failure: true

  - name: "Final Screenshot"
    type: ui
    ui:
      action: screenshot
      screenshot: true
    continue_on_failure: true
