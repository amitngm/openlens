<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive QA Buddy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .main-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .app-panel {
            width: 60%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 2px solid #ddd;
        }

        .buddy-panel {
            width: 40%;
            height: 100vh;
            overflow-y: auto;
            background: #fafafa;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafafa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: auto;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover:not(:disabled) {
            background: #229954;
        }

        .status-panel {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .status-item {
            margin-bottom: 8px;
        }

        .status-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .status-value {
            color: #34495e;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .question-panel {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 6px;
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 15px;
            color: #856404;
            font-weight: 500;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            background: white;
            border: 2px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .option-button:hover {
            background: #fff9e6;
            border-color: #ff9800;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .text-input-group {
            display: flex;
            gap: 10px;
        }

        .text-input-group input {
            flex: 1;
        }

        .screenshot {
            margin-top: 15px;
            text-align: center;
        }

        .screenshot img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .report-section {
            text-align: center;
        }

        .app-iframe-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
        }

        .app-iframe-header {
            padding: 10px 15px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-iframe-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        .app-iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }

        .iframe-blocked {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            padding: 40px;
            text-align: center;
        }

        .iframe-blocked p {
            color: #6c757d;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.6;
        }

        .iframe-blocked .info-text {
            color: #495057;
            font-size: 14px;
            margin-top: 15px;
            max-width: 400px;
        }

        .free-text-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .free-text-section h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .free-text-input-group {
            display: flex;
            gap: 10px;
        }

        .free-text-input-group textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .free-text-input-group button {
            padding: 10px 20px;
            white-space: nowrap;
        }

        .discovery-feed {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .discovery-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .discovery-log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .discovery-log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .discovery-log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #999;
            margin-right: 10px;
        }

        .log-type {
            font-weight: bold;
            margin-right: 10px;
        }

        .log-type.page_discovered {
            color: #27ae60;
        }

        .log-type.dropdowns_discovered {
            color: #3498db;
        }

        .log-type.navigation_discovered {
            color: #9b59b6;
        }

        .pages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .page-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-item:hover {
            background: #f0f0f0;
            border-color: #3498db;
        }

        .page-item.selected {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .page-item-title {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .page-item-url {
            font-size: 12px;
            color: #7f8c8d;
            word-break: break-all;
        }

        .page-details {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }

        .detail-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .field-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            border-radius: 3px;
        }

        .field-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .field-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .action-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .action-item.dangerous {
            background: #fee;
            border-left: 3px solid #e74c3c;
        }

        .action-item.safe {
            background: #efe;
            border-left: 3px solid #27ae60;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Left Panel: Application UI -->
        <div class="app-panel">
            <div class="app-iframe-container">
                <div class="app-iframe-header">
                    <h3>üì± Application UI</h3>
                    <button id="open_app_tab_btn" class="hidden" style="padding: 6px 12px; font-size: 12px; background: #27ae60;">
                        Open in New Tab
                    </button>
                </div>
                <iframe id="app_iframe" class="app-iframe" src="about:blank" title="Application"></iframe>
                <div id="iframe_blocked" class="iframe-blocked hidden">
                    <p>‚ö†Ô∏è Application cannot be embedded (X-Frame-Options blocked)</p>
                    <p class="info-text">
                        This is a security feature that prevents embedding. The QA Buddy will still work - 
                        it uses Playwright in the background to interact with your application.
                    </p>
                    <button id="open_app_tab_btn2" style="padding: 10px 20px; margin-top: 10px;">
                        Open Application in New Tab
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel: QA Buddy -->
        <div class="buddy-panel">
            <div class="container">
                <h1>üîç Interactive QA Buddy</h1>
                <p class="subtitle">Automated testing with interactive guidance</p>

        <!-- Configuration Section -->
        <div class="section">
            <h2>Configuration</h2>
            <div class="form-group">
                <label for="base_url">Base URL *</label>
                <input type="text" id="base_url" placeholder="https://your-app.example.com" value="">
            </div>
            <div class="form-group">
                <label for="env">Environment</label>
                <select id="env">
                    <option value="dev">Development</option>
                    <option value="staging">Staging</option>
                    <option value="prod">Production</option>
                </select>
            </div>
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="headless" checked>
                    <label for="headless">Run in headless mode</label>
                </div>
            </div>
            <div class="form-group">
                <label for="auth_type">Authentication Type</label>
                <select id="auth_type">
                    <option value="none">None</option>
                    <option value="keycloak" selected>Keycloak</option>
                </select>
            </div>
            <div class="form-group" id="auth_fields">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter username">
                <label for="password" style="margin-top: 10px;">Password</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button id="start_btn" onclick="startRun()">Start Run</button>
            <button id="stop_btn" class="btn-danger hidden" onclick="stopRun()">Stop Polling</button>
        </div>

        <!-- Free Text Input Section -->
        <div class="free-text-section" id="free_text_section" style="display: none;">
            <h3>üí¨ Ask QA Buddy</h3>
            <div class="free-text-input-group">
                <textarea id="free_text_input" placeholder="What should I test / check / skip?"></textarea>
                <button id="submit_free_text_btn" onclick="submitFreeText()">Send</button>
            </div>
        </div>

        <!-- Status Section -->
        <div class="section" id="status_section" style="display: none;">
            <h2>Run Status</h2>
            <div id="status_panel" class="status-panel">
                <div class="status-item">
                    <span class="status-label">Run ID:</span>
                    <span class="status-value" id="run_id_display">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">State:</span>
                    <span class="status-value" id="state_display">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current URL:</span>
                    <span class="status-value" id="current_url_display">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Step:</span>
                    <span class="status-value" id="last_step_display">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Progress:</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress_fill" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Section -->
        <div class="section hidden" id="question_section">
            <h2>Action Required</h2>
            <div id="question_panel" class="question-panel">
                <div class="question-text" id="question_text"></div>
                <div id="question_content"></div>
                <div id="question_screenshot" class="screenshot"></div>
            </div>
        </div>

        <!-- Discovery Live Feed Section -->
        <div class="section hidden" id="discovery_section">
            <h2>üîç Live Discovery</h2>
            <div id="discovery_feed" class="discovery-feed">
                <div class="discovery-stats">
                    <div class="stat-item">
                        <span class="stat-label">Pages:</span>
                        <span class="stat-value" id="discovery_pages_count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Forms:</span>
                        <span class="stat-value" id="discovery_forms_count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Actions:</span>
                        <span class="stat-value" id="discovery_actions_count">0</span>
                    </div>
                </div>
                <div id="discovery_log" class="discovery-log"></div>
            </div>
        </div>

        <!-- Discovered Pages Section -->
        <div class="section hidden" id="pages_section">
            <h2>üìÑ Discovered Pages</h2>
            <div id="pages_list" class="pages-list"></div>
        </div>

        <!-- Page Details Section -->
        <div class="section hidden" id="page_details_section">
            <h2>üìã Page Details</h2>
            <div id="page_details_content" class="page-details"></div>
        </div>

        <!-- Report Section -->
        <div class="section hidden" id="report_section">
            <h2>Test Report</h2>
            <div class="report-section">
                <button id="open_report_btn" class="btn-success" onclick="openReport()">Open Report</button>
                <button id="toggle_report_btn" class="btn-success hidden" onclick="toggleReport()">Show/Hide Report</button>
                <iframe id="report_frame" class="hidden" style="display: none;"></iframe>
            </div>
        </div>

        <!-- Messages -->
        <div id="message_area"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin; // Use same origin, or set to 'http://localhost:8000' for different host

        // State
        let currentRunId = null;
        let pollingInterval = null;
        let eventsPollingInterval = null;
        let currentQuestion = null;
        let currentAppUrl = null; // Track current application URL
        let eventsCursor = 0;
        let discoveredPages = [];
        let selectedPageIndex = null;

        // Initialize
        document.getElementById('auth_type').addEventListener('change', function() {
            const authFields = document.getElementById('auth_fields');
            if (this.value === 'none') {
                authFields.style.display = 'none';
            } else {
                authFields.style.display = 'block';
            }
        });

        // Start run
        async function startRun() {
            const baseUrl = document.getElementById('base_url').value.trim();
            if (!baseUrl) {
                showMessage('Please enter a base URL', 'error');
                return;
            }

            const env = document.getElementById('env').value;
            const headless = document.getElementById('headless').checked;
            const authType = document.getElementById('auth_type').value;

            const payload = {
                base_url: baseUrl,
                env: env,
                headless: headless
            };

            if (authType === 'keycloak') {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                if (username && password) {
                    payload.auth = {
                        type: 'keycloak',
                        username: username,
                        password: password
                    };
                }
            }

            try {
                showMessage('Starting run...', 'success');
                document.getElementById('start_btn').disabled = true;

                const response = await fetch(`${API_BASE}/runs/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                currentRunId = data.run_id;

                showMessage(`Run started: ${currentRunId}`, 'success');
                document.getElementById('status_section').style.display = 'block';
                document.getElementById('free_text_section').style.display = 'block';
                document.getElementById('stop_btn').classList.remove('hidden');
                
                // Load application in iframe
                loadAppInIframe(baseUrl, data.current_url);
                
                updateStatus(data);
                startPolling();
                startEventsPolling();

            } catch (error) {
                showMessage(`Failed to start run: ${error.message}`, 'error');
                document.getElementById('start_btn').disabled = false;
            }
        }

        // Start polling
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            pollingInterval = setInterval(async () => {
                if (!currentRunId) return;

                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/status`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    updateStatus(data);

                    // Check if done
                    if (data.state === 'DONE' || data.state === 'FAILED') {
                        stopPolling();
                        stopEventsPolling();
                        checkReportAvailable();
                    }
                    
                    // Show discovery section when discovery starts
                    if (data.state === 'DISCOVERY_RUN' || data.state === 'DISCOVERY_SUMMARY') {
                        document.getElementById('discovery_section').classList.remove('hidden');
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Stop polling
        function stopRun() {
            stopPolling();
            document.getElementById('start_btn').disabled = false;
            document.getElementById('stop_btn').classList.add('hidden');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            if (eventsPollingInterval) {
                clearInterval(eventsPollingInterval);
                eventsPollingInterval = null;
            }
        }

        // Start polling events
        function startEventsPolling() {
            if (eventsPollingInterval) {
                clearInterval(eventsPollingInterval);
            }

            eventsPollingInterval = setInterval(async () => {
                if (!currentRunId) return;

                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/events?after=${eventsCursor}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.events && data.events.length > 0) {
                        processEvents(data.events);
                        eventsCursor = data.next_cursor;
                    }

                } catch (error) {
                    console.error('Events polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Process discovery events
        function processEvents(events) {
            events.forEach(event => {
                addEventToLog(event);
                
                if (event.type === 'page_discovered') {
                    addPageToList(event.data);
                } else if (event.type === 'discovery_completed') {
                    updateDiscoveryStats(event.data);
                    stopEventsPolling();
                }
            });
        }

        // Add event to discovery log
        function addEventToLog(event) {
            const log = document.getElementById('discovery_log');
            const entry = document.createElement('div');
            entry.className = 'discovery-log-entry';
            
            const timestamp = new Date(event.timestamp).toLocaleTimeString();
            const type = event.type.replace(/_/g, ' ');
            
            let message = '';
            if (event.type === 'page_discovered') {
                message = `Discovered page: ${event.data.title || event.data.url}`;
            } else if (event.type === 'dropdowns_discovered') {
                message = `Found ${event.data.count} dropdown(s)`;
            } else if (event.type === 'navigation_discovered') {
                message = `Found ${event.data.count} navigation item(s)`;
            } else if (event.type === 'discovery_completed') {
                message = `Discovery completed: ${event.data.pages_count} pages, ${event.data.forms_count} forms`;
            } else {
                message = JSON.stringify(event.data);
            }
            
            entry.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-type ${event.type}">${type}</span>
                <span>${message}</span>
            `;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Add page to pages list
        function addPageToList(pageData) {
            const page = {
                url: pageData.url,
                title: pageData.title || pageData.url,
                nav_path: pageData.nav_path || '',
                forms_count: pageData.forms_count || 0,
                actions_count: pageData.actions_count || 0
            };
            
            // Check if already exists
            const exists = discoveredPages.find(p => p.url === page.url);
            if (exists) return;
            
            discoveredPages.push(page);
            renderPagesList();
        }

        // Render pages list
        function renderPagesList() {
            const list = document.getElementById('pages_list');
            list.innerHTML = '';
            
            discoveredPages.forEach((page, index) => {
                const item = document.createElement('div');
                item.className = `page-item ${selectedPageIndex === index ? 'selected' : ''}`;
                item.onclick = () => selectPage(index);
                
                item.innerHTML = `
                    <div class="page-item-title">${page.title}</div>
                    <div class="page-item-url">${page.url}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                        ${page.forms_count} forms, ${page.actions_count} actions
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            if (discoveredPages.length > 0) {
                document.getElementById('pages_section').classList.remove('hidden');
            }
        }

        // Select a page to show details
        async function selectPage(index) {
            selectedPageIndex = index;
            renderPagesList();
            
            // Load page details from discovery.json
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/status`);
                const status = await response.json();
                
                // For now, show basic info. In production, you'd fetch from discovery.json
                const page = discoveredPages[index];
                showPageDetails(page);
            } catch (error) {
                console.error('Error loading page details:', error);
            }
        }

        // Show page details
        function showPageDetails(page) {
            const details = document.getElementById('page_details_content');
            details.innerHTML = `
                <div class="detail-section">
                    <h3>Page Information</h3>
                    <div class="detail-item">
                        <strong>Title:</strong> ${page.title}
                    </div>
                    <div class="detail-item">
                        <strong>URL:</strong> ${page.url}
                    </div>
                    <div class="detail-item">
                        <strong>Navigation Path:</strong> ${page.nav_path || 'N/A'}
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Summary</h3>
                    <div class="detail-item">
                        <strong>Forms:</strong> ${page.forms_count}
                    </div>
                    <div class="detail-item">
                        <strong>Actions:</strong> ${page.actions_count}
                    </div>
                </div>
            `;
            
            document.getElementById('page_details_section').classList.remove('hidden');
        }

        // Update discovery stats
        function updateDiscoveryStats(data) {
            document.getElementById('discovery_pages_count').textContent = data.pages_count || 0;
            document.getElementById('discovery_forms_count').textContent = data.forms_count || 0;
            document.getElementById('discovery_actions_count').textContent = data.actions_count || 0;
            
            document.getElementById('discovery_section').classList.remove('hidden');
        }

        function stopEventsPolling() {
            if (eventsPollingInterval) {
                clearInterval(eventsPollingInterval);
                eventsPollingInterval = null;
            }
        }

        // Update status display
        function updateStatus(data) {
            document.getElementById('run_id_display').textContent = data.run_id || '-';
            document.getElementById('state_display').textContent = data.state || '-';
            document.getElementById('current_url_display').textContent = data.current_url || '-';
            document.getElementById('last_step_display').textContent = data.last_step || '-';

            const progress = data.progress || 0;
            const progressFill = document.getElementById('progress_fill');
            progressFill.style.width = `${progress}%`;
            progressFill.textContent = `${progress}%`;

            // Update app URL if changed (e.g., after login)
            if (data.current_url && data.current_url !== currentAppUrl) {
                currentAppUrl = data.current_url;
                // Try to reload iframe with new URL (if not blocked)
                const iframe = document.getElementById('app_iframe');
                const iframeBlocked = document.getElementById('iframe_blocked');
                if (iframeBlocked.classList.contains('hidden')) {
                    iframe.src = data.current_url;
                }
                // Update "Open in New Tab" button to use current URL
                const openTabBtn = document.getElementById('open_app_tab_btn');
                const openTabBtn2 = document.getElementById('open_app_tab_btn2');
                const openInNewTab = () => window.open(data.current_url, '_blank');
                if (openTabBtn) openTabBtn.onclick = openInNewTab;
                if (openTabBtn2) openTabBtn2.onclick = openInNewTab;
            }

            // Show test execution status in app panel
            updateTestExecutionStatus(data);

            // Check for report when done
            if (data.state === 'DONE' || data.state === 'REPORT_GENERATE') {
                checkReportAvailable();
            }

            // Handle question
            if (data.question) {
                currentQuestion = data.question;
                showQuestion(data.question);
            } else {
                hideQuestion();
            }
        }

        // Update test execution status in app panel
        function updateTestExecutionStatus(data) {
            const appHeader = document.querySelector('.app-iframe-header h3');
            if (!appHeader) return;

            let statusText = 'üì± Application UI';
            
            // Show test execution status
            if (data.state === 'TEST_EXECUTE') {
                statusText = 'üß™ Running Tests...';
            } else if (data.state === 'TEST_PLAN_BUILD') {
                statusText = 'üìã Building Test Plan...';
            } else if (data.state === 'DISCOVERY_RUN') {
                statusText = 'üîç Discovering Application...';
            } else if (data.state === 'LOGIN_ATTEMPT' || data.state === 'POST_LOGIN_VALIDATE') {
                statusText = 'üîê Logging In...';
            } else if (data.state === 'DONE') {
                statusText = '‚úÖ Tests Complete';
            } else if (data.state === 'FAILED') {
                statusText = '‚ùå Tests Failed';
            } else if (data.current_url) {
                statusText = 'üì± Application UI';
            }

            appHeader.textContent = statusText;
        }

        // Show question
        function showQuestion(question) {
            const questionSection = document.getElementById('question_section');
            const questionText = document.getElementById('question_text');
            const questionContent = document.getElementById('question_content');
            const questionScreenshot = document.getElementById('question_screenshot');

            questionSection.classList.remove('hidden');
            questionText.textContent = question.text || '';

            // Clear previous content
            questionContent.innerHTML = '';
            questionScreenshot.innerHTML = '';

            // Render based on type
            if (question.type === 'select_one' && question.options) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'question-options';
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option.label || option.id;
                    button.onclick = () => submitAnswer(question.id, option.id);
                    optionsDiv.appendChild(button);
                });
                questionContent.appendChild(optionsDiv);
            } else if (question.type === 'confirm') {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'confirm-buttons';
                
                const yesBtn = document.createElement('button');
                yesBtn.className = 'btn-success';
                yesBtn.textContent = 'Yes';
                yesBtn.onclick = () => submitAnswer(question.id, 'yes');
                
                const noBtn = document.createElement('button');
                noBtn.className = 'btn-danger';
                noBtn.textContent = 'No';
                noBtn.onclick = () => submitAnswer(question.id, 'no');
                
                buttonsDiv.appendChild(yesBtn);
                buttonsDiv.appendChild(noBtn);
                questionContent.appendChild(buttonsDiv);
            } else if (question.type === 'text') {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'text-input-group';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'answer_input';
                input.placeholder = 'Enter your answer...';
                
                const submitBtn = document.createElement('button');
                submitBtn.textContent = 'Submit';
                submitBtn.onclick = () => {
                    const answer = document.getElementById('answer_input').value.trim();
                    if (answer) {
                        submitAnswer(question.id, answer);
                    }
                };
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitBtn.onclick();
                    }
                });
                
                inputGroup.appendChild(input);
                inputGroup.appendChild(submitBtn);
                questionContent.appendChild(inputGroup);
            }

            // Show screenshot if available
            if (question.screenshot_path) {
                const img = document.createElement('img');
                img.src = question.screenshot_path;
                img.alt = 'Screenshot';
                img.onerror = () => {
                    questionScreenshot.innerHTML = '<p style="color: #999;">Screenshot not available</p>';
                };
                questionScreenshot.appendChild(img);
            }
        }

        // Hide question
        function hideQuestion() {
            document.getElementById('question_section').classList.add('hidden');
            currentQuestion = null;
        }

        // Submit answer
        async function submitAnswer(questionId, answer) {
            if (!currentRunId) return;

            try {
                showMessage('Submitting answer...', 'success');
                
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: questionId,
                        answer: answer
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                showMessage('Answer submitted successfully', 'success');
                updateStatus(data);

            } catch (error) {
                showMessage(`Failed to submit answer: ${error.message}`, 'error');
            }
        }

        // Check if report is available
        async function checkReportAvailable() {
            if (!currentRunId) return;

            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/report`);
                if (response.ok) {
                    document.getElementById('report_section').style.display = 'block';
                    document.getElementById('open_report_btn').disabled = false;
                    document.getElementById('toggle_report_btn').style.display = 'inline-block';
                    showMessage('üìä Test report is now available!', 'success');
                }
            } catch (error) {
                // Report not ready yet
            }
        }


        // Open report
        function openReport() {
            if (!currentRunId) return;
            window.open(`${API_BASE}/runs/${currentRunId}/report`, '_blank');
        }

        // Toggle report inline
        function toggleReport() {
            const frame = document.getElementById('report_frame');
            if (frame.style.display === 'none') {
                frame.src = `${API_BASE}/runs/${currentRunId}/report`;
                frame.style.display = 'block';
            } else {
                frame.style.display = 'none';
            }
        }

        // Load application in iframe
        function loadAppInIframe(baseUrl, currentUrl = null) {
            const iframe = document.getElementById('app_iframe');
            const iframeBlocked = document.getElementById('iframe_blocked');
            const openTabBtn = document.getElementById('open_app_tab_btn');
            const openTabBtn2 = document.getElementById('open_app_tab_btn2');
            
            // Use current URL if available (logged-in page), otherwise use base URL
            const urlToLoad = currentUrl || baseUrl;
            currentAppUrl = urlToLoad;
            
            // Set up open in new tab buttons - use current URL (logged-in page)
            const openInNewTab = () => {
                const url = currentAppUrl || baseUrl;
                window.open(url, '_blank');
            };
            openTabBtn.onclick = openInNewTab;
            openTabBtn2.onclick = openInNewTab;
            
            // Reset visibility
            iframeBlocked.classList.add('hidden');
            iframe.classList.remove('hidden');
            openTabBtn.classList.add('hidden');
            
            // Try to load in iframe - use current URL if available
            iframe.src = urlToLoad;
            
            let checkAttempts = 0;
            const maxAttempts = 3;
            
            // Check for X-Frame-Options blocking
            const checkIfBlocked = () => {
                checkAttempts++;
                try {
                    // Try to access iframe content (will fail if blocked by X-Frame-Options)
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    // If we can access it, it's not blocked
                    if (iframeDoc && iframeDoc.location) {
                        iframeBlocked.classList.add('hidden');
                        iframe.classList.remove('hidden');
                        openTabBtn.classList.add('hidden');
                        return; // Success - not blocked
                    }
                } catch (e) {
                    // Cross-origin or X-Frame-Options blocked
                    // This is expected for most applications
                }
                
                // If we've tried enough times, assume it's blocked
                if (checkAttempts >= maxAttempts) {
                    // Check if iframe actually loaded something
                    try {
                        // If we can't access content, it's likely blocked
                        iframeBlocked.classList.remove('hidden');
                        iframe.classList.add('hidden');
                        openTabBtn.classList.remove('hidden');
                    } catch (e) {
                        // Definitely blocked
                        iframeBlocked.classList.remove('hidden');
                        iframe.classList.add('hidden');
                        openTabBtn.classList.remove('hidden');
                    }
                } else {
                    // Try again after a delay
                    setTimeout(checkIfBlocked, 1000);
                }
            };
            
            // Start checking after iframe starts loading
            iframe.onload = () => {
                setTimeout(checkIfBlocked, 500);
            };
            
            // Also check after initial delay
            setTimeout(checkIfBlocked, 1500);
            
            // Listen for load error
            iframe.onerror = () => {
                iframeBlocked.classList.remove('hidden');
                iframe.classList.add('hidden');
                openTabBtn.classList.remove('hidden');
            };
        }

        // Submit free text
        async function submitFreeText() {
            if (!currentRunId) {
                showMessage('No active run. Please start a run first.', 'error');
                return;
            }

            const input = document.getElementById('free_text_input');
            const text = input.value.trim();
            
            if (!text) {
                showMessage('Please enter a question or command.', 'error');
                return;
            }

            try {
                showMessage('Sending message to QA Buddy...', 'success');
                
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: 'free_text',
                        answer: text
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                showMessage('Message sent successfully', 'success');
                input.value = ''; // Clear input
                updateStatus(data);

            } catch (error) {
                showMessage(`Failed to send message: ${error.message}`, 'error');
            }
        }

        // Allow Enter key to submit free text (Shift+Enter for new line)
        document.addEventListener('DOMContentLoaded', () => {
            const freeTextInput = document.getElementById('free_text_input');
            if (freeTextInput) {
                freeTextInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitFreeText();
                    }
                });
            }
        });

        // Show message
        function showMessage(message, type) {
            const messageArea = document.getElementById('message_area');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error' : 'success';
            messageDiv.textContent = message;
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
