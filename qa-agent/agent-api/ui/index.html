<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Buddy - AI-Powered Test Discovery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-dark: #0f172a;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-info: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .app-panel {
            width: 60%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .buddy-panel {
            width: 40%;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            padding: 0;
        }

        .buddy-header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 28px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        .buddy-header h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .buddy-header h1::before {
            content: "ü§ñ";
            font-size: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .buddy-header .subtitle {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .buddy-content {
            padding: 24px;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .file-upload-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .file-upload-hint {
            color: var(--text-secondary);
            font-size: 12px;
        }

        input[type="file"] {
            display: none;
        }

        .file-preview {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-preview-item {
            position: relative;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .file-preview-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .file-preview-item video {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .file-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        button:hover:not(:disabled)::before {
            opacity: 1;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -2px rgba(99, 102, 241, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0px);
        }

        button:disabled {
            background: var(--border);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            box-shadow: var(--shadow);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            letter-spacing: 0.3px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-badge.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.25) 100%);
            color: var(--success);
            border: 1.5px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge.active::before {
            animation: pulse-success 2s ease-in-out infinite;
        }

        @keyframes pulse-success {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-badge.running {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.25) 100%);
            color: var(--info);
            border: 1.5px solid rgba(59, 130, 246, 0.3);
        }

        .status-badge.running::before {
            animation: pulse-running 1s ease-in-out infinite;
        }

        @keyframes pulse-running {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .status-badge.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.25) 100%);
            color: var(--danger);
            border: 1.5px solid rgba(239, 68, 68, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .question-panel {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid var(--warning);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 16px;
            color: #856404;
            font-weight: 500;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            background: white;
            border: 2px solid var(--warning);
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 14px;
        }

        .option-button:hover {
            background: #fff9e6;
            border-color: #f59e0b;
            transform: translateX(4px);
        }

        .discovery-feed {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-light);
            box-shadow: var(--shadow-md);
        }

        .discovery-feed::-webkit-scrollbar {
            width: 8px;
        }

        .discovery-feed::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .discovery-feed::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .discovery-feed::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .discovery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--border-light);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-card.success::before {
            background: var(--gradient-success);
        }

        .stat-card.success .stat-value {
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.info::before {
            background: var(--gradient-info);
        }

        .stat-card.info .stat-value {
            background: var(--gradient-info);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
            box-shadow: var(--shadow);
        }

        .app-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -2px;
            border-radius: 6px 6px 0 0;
        }

        .app-tab:hover {
            background: var(--bg-tertiary);
        }

        .app-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg-primary);
            font-weight: 600;
        }

        .app-view {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .app-view.active {
            display: flex;
            flex-direction: column;
        }

        .app-iframe-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--bg-tertiary);
        }

        .app-iframe-header {
            padding: 12px 20px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .app-iframe-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .app-iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .future-discovery-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .future-discovery-section h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .future-discovery-section p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Health Check Dashboard Styles */
        .health-check-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .health-check-table th {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 2px solid #d1d5db;
            white-space: nowrap;
        }

        .health-check-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
        }

        .health-check-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .health-check-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .health-check-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            min-width: 60px;
        }

        .health-check-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .health-check-status.running {
            background: #dbeafe;
            color: #1e40af;
            animation: pulse-health 2s infinite;
        }

        .health-check-status.passed {
            background: #d1fae5;
            color: #065f46;
        }

        .health-check-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .health-check-status.skipped {
            background: #f3f4f6;
            color: #6b7280;
        }

        @keyframes pulse-health {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .health-page-title {
            font-weight: 500;
            color: #111827;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .health-page-url {
            font-size: 11px;
            color: #9ca3af;
            display: block;
            margin-top: 2px;
        }

        .health-duration {
            font-size: 12px;
            color: #6b7280;
            font-family: 'Monaco', 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Left Panel: Application UI -->
        <div class="app-panel">
            <!-- App Panel Tabs -->
            <div class="app-tabs">
                <button class="app-tab active" onclick="switchAppTab('app')">üì± Application</button>
                <button class="app-tab" onclick="switchAppTab('testcases')">‚úÖ Test Cases</button>
                <button class="app-tab" onclick="switchAppTab('progress')">üìä Live Progress</button>
            </div>

            <!-- Application View -->
            <div id="app-view" class="app-view active">
                <div class="app-iframe-container">
                    <div class="app-iframe-header">
                        <h3>üì± Application UI</h3>
                        <button id="open_app_tab_btn" class="btn-sm hidden" style="background: var(--success);">
                            Open in New Tab
                        </button>
                    </div>
                    <iframe id="app_iframe" class="app-iframe" src="about:blank" title="Application"></iframe>
                    <div id="iframe_blocked" class="hidden" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: var(--bg-tertiary);">
                        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 16px;">‚ö†Ô∏è Application cannot be embedded (X-Frame-Options blocked)</p>
                        <p style="color: var(--text-secondary); font-size: 14px; max-width: 400px; margin-bottom: 20px;">
                            This is a security feature. QA Buddy uses Playwright in the background to interact with your application.
                        </p>
                        <button id="open_app_tab_btn2" onclick="window.open(currentAppUrl || document.getElementById('base_url').value, '_blank')">
                            Open Application in New Tab
                        </button>
                    </div>
                </div>
            </div>

            <!-- Test Cases View -->
            <div id="testcases-view" class="app-view">
                <div style="padding: 20px; height: 100%; overflow-y: auto; background: var(--bg-secondary);">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span>‚úÖ</span> Test Cases
                        </h2>
                        <div id="testcases_summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px;">
                            <!-- Summary stats will be populated here -->
                        </div>
                    </div>
                    <div id="testcases_list" style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                            <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">No test cases available yet</p>
                            <p style="font-size: 14px;">Start a discovery run to see test cases with their status</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Progress View -->
            <div id="progress-view" class="app-view">
                <div style="padding: 20px; height: 100%; overflow-y: auto; background: var(--bg-secondary);">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span>üìä</span> Live Discovery Progress
                        </h2>
                        <div class="discovery-stats" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="app_progress_pages">0</div>
                                <div class="stat-label">Pages</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="app_progress_forms">0</div>
                                <div class="stat-label">Forms</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="app_progress_actions">0</div>
                                <div class="stat-label">Actions</div>
                            </div>
                        </div>
                    </div>
                    <div id="app_progress_feed" class="discovery-feed" style="max-height: calc(100vh - 280px); background: white; border-radius: 12px; padding: 16px;">
                        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                            <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">Waiting for discovery to start...</p>
                            <p style="font-size: 14px;">Progress will appear here in real-time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: QA Buddy -->
        <div class="buddy-panel">
            <div class="buddy-header">
                <h1>QA Buddy</h1>
                <p class="subtitle">AI-Powered Intelligent Test Discovery & Automation</p>
            </div>

            <div class="buddy-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('config')">1Ô∏è‚É£ Configuration</button>
                    <button class="tab" onclick="switchTab('media')">2Ô∏è‚É£ Upload Images (Optional)</button>
                    <button class="tab" onclick="switchTab('discovery')">3Ô∏è‚É£ Discovery & Results</button>
                </div>

                <!-- Configuration Tab -->
                <div id="tab-config" class="tab-content active">
                    <!-- Workflow Guide -->
                    <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); border: 2px solid rgba(99, 102, 241, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üí°</span>
                            <h3 style="font-size: 16px; font-weight: 600; color: var(--primary);">Quick Start Guide</h3>
                        </div>
                        <ol style="margin-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                            <li><strong>Configure</strong> your application URL and authentication below</li>
                            <li><strong>Upload Images</strong> (optional) - Switch to tab 2Ô∏è‚É£ to upload screenshots that help guide discovery</li>
                            <li><strong>Start Discovery</strong> - Click the button below to begin comprehensive testing</li>
                        </ol>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">‚öôÔ∏è</span> Run Configuration</h2>
                        </div>

                        <div class="form-group">
                            <label for="base_url">Base URL *</label>
                            <input type="url" id="base_url" placeholder="https://your-app.example.com" value="">
                        </div>

                        <div class="form-group">
                            <label for="env">Environment</label>
                            <select id="env">
                                <option value="dev">Development</option>
                                <option value="staging" selected>Staging</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="headless" checked>
                                <label for="headless">Run in headless mode</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="discovery_debug">
                                <label for="discovery_debug">Enable discovery debug mode (headed, slowMo, video)</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="auth_type">Authentication Type</label>
                            <select id="auth_type">
                                <option value="none">None</option>
                                <option value="keycloak" selected>Keycloak</option>
                            </select>
                        </div>

                        <div class="form-group" id="auth_fields">
                            <label for="username">Username</label>
                            <input type="text" id="username" placeholder="Enter username">
                            <label for="password" style="margin-top: 12px;">Password</label>
                            <input type="password" id="password" placeholder="Enter password">
                        </div>

                        <!-- Advanced Discovery Settings -->
                        <details style="margin-top: 16px; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary);">‚öôÔ∏è Advanced Discovery Settings (NEW!)</summary>
                            <div style="margin-top: 12px; display: grid; gap: 12px;">
                                <div class="form-group">
                                    <label for="max_pages">Max Pages to Discover</label>
                                    <input type="number" id="max_pages" placeholder="2000 (default)" value="2000" min="1" max="10000">
                                    <small style="color: var(--text-secondary);">Default: 2000 pages (was 500)</small>
                                </div>
                                <div class="form-group">
                                    <label for="max_forms_per_page">Max Forms Per Page</label>
                                    <input type="number" id="max_forms_per_page" placeholder="50 (default)" value="50" min="1" max="200">
                                    <small style="color: var(--text-secondary);">Default: 50 forms (was 20)</small>
                                </div>
                                <div class="form-group">
                                    <label for="max_table_rows">Max Table Rows to Click</label>
                                    <input type="number" id="max_table_rows" placeholder="50 (default)" value="50" min="1" max="200">
                                    <small style="color: var(--text-secondary);">Default: 50 rows (was 10)</small>
                                </div>
                                <div class="form-group">
                                    <label for="max_discovery_time">Max Discovery Time (minutes)</label>
                                    <input type="number" id="max_discovery_time" placeholder="60 (default)" value="60" min="1" max="120">
                                    <small style="color: var(--text-secondary);">Default: 60 minutes (was 30)</small>
                                </div>
                            </div>
                        </details>

                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                            üí° <strong>Tip:</strong> Upload screenshots in tab 2Ô∏è‚É£ before starting for better discovery results
                        </div>

                        <button id="start_btn" onclick="startRun()" style="width: 100%; margin-top: 12px;">
                            üöÄ Start Discovery Run
                        </button>
                        <button id="stop_btn" class="btn-danger hidden" onclick="stopRun()" style="width: 100%; margin-top: 8px;">
                            ‚èπÔ∏è Stop Polling
                        </button>
                    </div>

                    <!-- Status Card -->
                    <div class="card hidden" id="status_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üìä</span> Run Status</h2>
                            <span id="status_badge" class="status-badge">-</span>
                        </div>
                        <div id="status_content"></div>
                    </div>

                    <!-- Question Card -->
                    <div class="card hidden" id="question_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">‚ùì</span> Action Required</h2>
                        </div>
                        <div id="question_content"></div>
                    </div>

                    <!-- Free Text Input -->
                    <div class="card hidden" id="free_text_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üí¨</span> Ask QA Buddy</h2>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <textarea id="free_text_input" placeholder="What should I test / check / skip?" rows="3" style="flex: 1;"></textarea>
                            <button onclick="submitFreeText()" style="align-self: flex-end;">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Discovery Tab -->
                <div id="tab-discovery" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üîç</span> Live Discovery</h2>
                        </div>
                        <div class="discovery-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="discovery_pages_count">0</div>
                                <div class="stat-label">Pages</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="discovery_forms_count">0</div>
                                <div class="stat-label">Forms</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="discovery_actions_count">0</div>
                                <div class="stat-label">Actions</div>
                            </div>
                        </div>
                        <div id="discovery_feed" class="discovery-feed"></div>
                    </div>

                    <div class="card hidden" id="pages_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üìÑ</span> Discovered Pages</h2>
                        </div>
                        <div id="pages_list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="card hidden" id="page_details_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üìã</span> Page Details</h2>
                        </div>
                        <div id="page_details_content"></div>
                    </div>

                    <!-- Feature-wise Test Cases -->
                    <div class="card hidden" id="features_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üéØ</span> Discovered Test Cases by Feature</h2>
                        </div>
                        <div id="features_summary" style="margin-bottom: 16px;"></div>
                        <div id="features_list"></div>
                    </div>

                    <!-- Phase 1: Health Check Dashboard -->
                    <div class="card hidden" id="health_check_dashboard">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">‚úÖ</span> Phase 1: Health Check Validation</h2>
                        </div>

                        <!-- Summary Cards -->
                        <div class="discovery-stats" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="health_pages_validated">0 / 0</div>
                                <div class="stat-label">Pages Validated</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);">
                                <div class="stat-value" style="color: #059669;" id="health_checks_passed">0</div>
                                <div class="stat-label">Checks Passed</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);">
                                <div class="stat-value" style="color: #dc2626;" id="health_checks_failed">0</div>
                                <div class="stat-label">Checks Failed</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);">
                                <div class="stat-value" style="color: #2563eb;" id="health_concurrent_tests">0</div>
                                <div class="stat-label">Running Now</div>
                            </div>
                        </div>

                        <!-- Health Check Table -->
                        <div style="overflow-x: auto;">
                            <table class="health-check-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 200px;">Page</th>
                                        <th style="width: 80px; text-align: center;">üìÑ Listing</th>
                                        <th style="width: 80px; text-align: center;">üìä Pagination</th>
                                        <th style="width: 80px; text-align: center;">üîç Search</th>
                                        <th style="width: 80px; text-align: center;">üéõÔ∏è Filters</th>
                                        <th style="width: 80px; text-align: center;">‚ÜïÔ∏è Sort</th>
                                        <th style="width: 120px; text-align: center;">Overall Status</th>
                                        <th style="width: 100px; text-align: center;">Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="health_check_table_body">
                                    <!-- Rows populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Media Upload Tab -->
                <div id="tab-media" class="tab-content">
                    <!-- Info Banner -->
                    <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 24px;">‚ÑπÔ∏è</span>
                            <h3 style="font-size: 16px; font-weight: 600; color: var(--success);">Upload Before Discovery</h3>
                        </div>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            Upload screenshots of your application <strong>before starting discovery</strong>. The AI will analyze images to detect UI patterns, forms, tables, and workflows to guide comprehensive testing.
                        </p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üì∏</span> Image Upload</h2>
                        </div>
                        <div class="file-upload-area" id="image_upload_area" onclick="document.getElementById('image_input').click()">
                            <div class="file-upload-icon">üì∑</div>
                            <div class="file-upload-text">Click to upload or drag & drop images</div>
                            <div class="file-upload-hint">Supports: JPG, PNG, GIF, WebP (Max 10MB each)</div>
                            <input type="file" id="image_input" accept="image/*" multiple>
                        </div>
                        <div class="file-preview" id="image_preview"></div>
                        <button onclick="uploadImages()" style="width: 100%; margin-top: 12px;" id="upload_images_btn" disabled>
                            üì§ Upload Images
                        </button>

                        <!-- Uploaded Images List -->
                        <div id="uploaded_images_list" style="margin-top: 20px; display: none;">
                            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text);">‚úÖ Uploaded Images</h3>
                            <div id="uploaded_images_container" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üé•</span> Video Upload</h2>
                        </div>
                        <div class="file-upload-area" id="video_upload_area" onclick="document.getElementById('video_input').click()">
                            <div class="file-upload-icon">üé¨</div>
                            <div class="file-upload-text">Click to upload or drag & drop videos</div>
                            <div class="file-upload-hint">Supports: MP4, WebM, MOV (Max 100MB each)</div>
                            <input type="file" id="video_input" accept="video/*" multiple>
                        </div>
                        <div class="file-preview" id="video_preview"></div>
                        <button onclick="uploadVideos()" style="width: 100%; margin-top: 12px;" id="upload_videos_btn" disabled>
                            üì§ Upload Videos
                        </button>
                    </div>

                    <div class="future-discovery-section">
                        <h3>üîÆ Future Discovery Features</h3>
                        <p>
                            Uploaded images and videos will be analyzed to:
                        </p>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary); font-size: 14px;">
                            <li>Extract UI elements and components</li>
                            <li>Identify workflows and user journeys</li>
                            <li>Generate test cases from visual patterns</li>
                            <li>Detect accessibility issues</li>
                            <li>Compare UI changes over time</li>
                        </ul>
                    </div>
                </div>

                <!-- Report Section -->
                <div class="card hidden" id="report_card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="icon">üìä</span> Test Report</h2>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn-success" onclick="openReport()" style="width: 100%;">
                            üìÑ Open Full Report
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="message_area"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        
        // State
        let currentRunId = null;
        let pollingInterval = null;
        let eventsPollingInterval = null;
        let currentQuestion = null;
        let currentAppUrl = null;
        let eventsCursor = 0;
        let discoveredPages = [];
        let selectedPageIndex = null;
        let uploadedImages = [];
        let uploadedVideos = [];
        let uploadedImageResults = [];  // Store uploaded image metadata for discovery

        // Tab switching (right panel)
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // App panel tab switching (left panel)
        function switchAppTab(viewName) {
            document.querySelectorAll('.app-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${viewName}-view`).classList.add('active');
        }

        // File upload handlers
        document.getElementById('image_input').addEventListener('change', handleImageSelect);
        document.getElementById('video_input').addEventListener('change', handleVideoSelect);

        // Drag and drop
        setupDragAndDrop('image_upload_area', 'image_input', handleImageSelect);
        setupDragAndDrop('video_upload_area', 'video_input', handleVideoSelect);

        function setupDragAndDrop(areaId, inputId, handler) {
            const area = document.getElementById(areaId);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
            });

            area.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById(inputId).files = files;
                handler({target: {files: Array.from(files)}});
            }, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files || []);
            uploadedImages = [...uploadedImages, ...files];
            renderImagePreviews();
            document.getElementById('upload_images_btn').disabled = uploadedImages.length === 0;
        }

        function handleVideoSelect(e) {
            const files = Array.from(e.target.files || []);
            uploadedVideos = [...uploadedVideos, ...files];
            renderVideoPreviews();
            document.getElementById('upload_videos_btn').disabled = uploadedVideos.length === 0;
        }

        function renderImagePreviews() {
            const preview = document.getElementById('image_preview');
            preview.innerHTML = '';
            uploadedImages.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                const name = document.createElement('span');
                name.textContent = file.name;
                const remove = document.createElement('button');
                remove.className = 'file-remove';
                remove.textContent = '√ó';
                remove.onclick = () => {
                    uploadedImages.splice(index, 1);
                    renderImagePreviews();
                    document.getElementById('upload_images_btn').disabled = uploadedImages.length === 0;
                };
                item.appendChild(img);
                item.appendChild(name);
                item.appendChild(remove);
                preview.appendChild(item);
            });
        }

        function renderVideoPreviews() {
            const preview = document.getElementById('video_preview');
            preview.innerHTML = '';
            uploadedVideos.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.muted = true;
                const name = document.createElement('span');
                name.textContent = file.name;
                const remove = document.createElement('button');
                remove.className = 'file-remove';
                remove.textContent = '√ó';
                remove.onclick = () => {
                    uploadedVideos.splice(index, 1);
                    renderVideoPreviews();
                    document.getElementById('upload_videos_btn').disabled = uploadedVideos.length === 0;
                };
                item.appendChild(video);
                item.appendChild(name);
                item.appendChild(remove);
                preview.appendChild(item);
            });
        }

        function displayUploadedImages(newResults) {
            const listContainer = document.getElementById('uploaded_images_list');
            const imagesContainer = document.getElementById('uploaded_images_container');

            // Show the list
            listContainer.style.display = 'block';

            // Add new images
            newResults.forEach((result, idx) => {
                const imageCard = document.createElement('div');
                imageCard.style.cssText = 'background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;';

                const workflows = result.analysis?.workflows || [];
                const workflowText = workflows.length > 0 ? workflows.join(', ') : 'No workflows detected';

                imageCard.innerHTML = `
                    <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--gradient-success); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                        üì∑
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 13px; color: var(--text); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${result.filename}
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ${result.analysis.ui_elements_count} elements ‚Ä¢ ${result.analysis.components_detected?.length || 0} components
                        </div>
                        <div style="font-size: 11px; color: var(--success); margin-top: 2px;">
                            üí° ${workflowText}
                        </div>
                    </div>
                    <div style="flex-shrink: 0; padding: 4px 8px; background: rgba(16, 185, 129, 0.1); color: var(--success); border-radius: 4px; font-size: 11px; font-weight: 600;">
                        ‚úì Analyzed
                    </div>
                `;

                imagesContainer.appendChild(imageCard);
            });
        }

        async function uploadImages() {
            if (uploadedImages.length === 0) return;

            try {
                showMessage('Uploading images...', 'success');

                // Upload images one by one to pre-run endpoint (no run_id needed)
                const results = [];
                for (const file of uploadedImages) {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_BASE}/runs/upload/image/pre-run`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || `HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    results.push(data);
                }

                // Store results for discovery
                uploadedImageResults = uploadedImageResults.concat(results);

                // Show combined analysis results
                const totalElements = results.reduce((sum, r) => sum + (r.analysis?.ui_elements_count || 0), 0);
                const totalComponents = results.reduce((sum, r) => sum + (r.analysis?.components_detected?.length || 0), 0);
                const totalWorkflows = results.reduce((sum, r) => sum + (r.analysis?.workflow_hints || 0), 0);

                showMessage(
                    `‚úÖ Uploaded ${results.length} image(s)! Analysis: ${totalElements} UI elements, ${totalComponents} components, ${totalWorkflows} workflows detected`,
                    'success'
                );

                // Display uploaded images
                displayUploadedImages(results);

                // Clear upload area
                uploadedImages = [];
                document.getElementById('image_preview').innerHTML = '';
                document.getElementById('upload_images_btn').disabled = true;
            } catch (error) {
                showMessage(`Failed to upload images: ${error.message}`, 'error');
            }
        }

        async function uploadVideos() {
            if (uploadedVideos.length === 0) return;
            if (!currentRunId) {
                showMessage('Please start a run first', 'error');
                return;
            }

            try {
                showMessage('Uploading videos...', 'success');
                const formData = new FormData();
                uploadedVideos.forEach(file => {
                    formData.append('files', file);
                });

                const response = await fetch(`${API_BASE}/runs/${currentRunId}/upload/videos`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                showMessage(`Successfully uploaded ${data.uploaded_count} video(s)`, 'success');
                uploadedVideos = [];
                renderVideoPreviews();
                document.getElementById('upload_videos_btn').disabled = true;
            } catch (error) {
                showMessage(`Failed to upload videos: ${error.message}`, 'error');
            }
        }

        // Auth type change
        document.getElementById('auth_type').addEventListener('change', function() {
            document.getElementById('auth_fields').style.display = this.value === 'none' ? 'none' : 'block';
        });

        // Start run
        async function startRun() {
            const baseUrl = document.getElementById('base_url').value.trim();
            if (!baseUrl) {
                showMessage('Please enter a base URL', 'error');
                return;
            }

            const payload = {
                base_url: baseUrl,
                env: document.getElementById('env').value,
                headless: document.getElementById('headless').checked,
                discovery_debug: document.getElementById('discovery_debug').checked,
                uploaded_images: uploadedImageResults  // Include pre-uploaded images
            };

            // Add advanced discovery configuration
            const maxPages = parseInt(document.getElementById('max_pages').value);
            const maxForms = parseInt(document.getElementById('max_forms_per_page').value);
            const maxTableRows = parseInt(document.getElementById('max_table_rows').value);
            const maxTime = parseInt(document.getElementById('max_discovery_time').value);

            if (!isNaN(maxPages) && maxPages > 0) payload.max_pages = maxPages;
            if (!isNaN(maxForms) && maxForms > 0) payload.max_forms_per_page = maxForms;
            if (!isNaN(maxTableRows) && maxTableRows > 0) payload.max_table_rows_to_click = maxTableRows;
            if (!isNaN(maxTime) && maxTime > 0) payload.max_discovery_time_minutes = maxTime;

            const authType = document.getElementById('auth_type').value;
            if (authType === 'keycloak') {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                if (username && password) {
                    payload.auth = { type: 'keycloak', username, password };
                }
            }

            // Show message if images are being used
            if (uploadedImageResults.length > 0) {
                showMessage(`üéØ Using ${uploadedImageResults.length} uploaded image(s) to guide discovery...`, 'success');
            }

            // Show configuration being used
            if (payload.max_pages || payload.max_forms_per_page || payload.max_table_rows_to_click || payload.max_discovery_time_minutes) {
                showMessage(`‚öôÔ∏è Using custom config: ${payload.max_pages || 2000} pages, ${payload.max_forms_per_page || 50} forms, ${payload.max_table_rows_to_click || 50} table rows, ${payload.max_discovery_time_minutes || 60} min`, 'info');
            }

            try {
                showMessage('Starting run...', 'success');
                document.getElementById('start_btn').disabled = true;

                const response = await fetch(`${API_BASE}/runs/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(await response.text() || `HTTP ${response.status}`);

                const data = await response.json();
                currentRunId = data.run_id;

                showMessage(`Run started: ${currentRunId}`, 'success');
                document.getElementById('status_card').classList.remove('hidden');
                document.getElementById('free_text_card').classList.remove('hidden');
                document.getElementById('stop_btn').classList.remove('hidden');
                
                loadAppInIframe(baseUrl, data.current_url);
                updateStatus(data);
                startPolling();
                startEventsPolling();

            } catch (error) {
                showMessage(`Failed to start run: ${error.message}`, 'error');
                document.getElementById('start_btn').disabled = false;
            }
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                if (!currentRunId) return;
                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/status`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    updateStatus(data);
                    if (data.state === 'DONE' || data.state === 'FAILED') {
                        stopPolling();
                        stopEventsPolling();
                        checkReportAvailable();
                    }
                    if (data.state === 'DISCOVERY_RUN' || data.state === 'DISCOVERY_SUMMARY') {
                        switchTab('discovery');
                    }
                    if (data.state === 'DISCOVERY_SUMMARY' || data.state === 'WAIT_TEST_INTENT') {
                        // Discovery completed, fetch and display features
                        fetchAndDisplayFeatures();
                        // Auto-switch to test cases view when available
                        const testCasesList = document.getElementById('testcases_list');
                        if (testCasesList && testCasesList.children.length > 0 && !testCasesList.children[0].textContent.includes('No test cases')) {
                            // Test cases are available, but don't auto-switch (let user choose)
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function stopRun() {
            stopPolling();
            document.getElementById('start_btn').disabled = false;
            document.getElementById('stop_btn').classList.add('hidden');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            if (eventsPollingInterval) {
                clearInterval(eventsPollingInterval);
                eventsPollingInterval = null;
            }
        }

        function startEventsPolling() {
            if (eventsPollingInterval) clearInterval(eventsPollingInterval);
            eventsPollingInterval = setInterval(async () => {
                if (!currentRunId) return;
                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/events?after=${eventsCursor}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    if (data.events && data.events.length > 0) {
                        processEvents(data.events);
                        eventsCursor = data.next_cursor;
                    }
                } catch (error) {
                    console.error('Events polling error:', error);
                }
            }, 2000);
        }

        async function fetchAndDisplayFeatures() {
            if (!currentRunId) return;
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/discovery/features`);
                if (!response.ok) return;
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    displayFeatures(data);
                }
            } catch (error) {
                console.error('Failed to fetch features:', error);
            }
        }

        function displayFeatures(data) {
            const featuresCard = document.getElementById('features_card');
            const featuresSummary = document.getElementById('features_summary');
            const featuresList = document.getElementById('features_list');

            // Show card
            featuresCard.classList.remove('hidden');

            // Display summary
            featuresSummary.innerHTML = `
                <div style="display: flex; gap: 16px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${data.total_features}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Features</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--success);">${data.total_test_cases}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Test Cases</div>
                    </div>
                </div>
            `;

            // Also update the app panel test cases view
            updateAppPanelTestCases(data);

            // Display features
            let html = '';
            data.features.forEach((feature, idx) => {
                const testCasesByType = {};
                feature.test_cases.forEach(tc => {
                    if (!testCasesByType[tc.test_type]) {
                        testCasesByType[tc.test_type] = [];
                    }
                    testCasesByType[tc.test_type].push(tc);
                });

                const typeColors = {
                    'navigation': '#3b82f6',
                    'crud_create': '#10b981',
                    'crud_update': '#f59e0b',
                    'crud_delete': '#ef4444',
                    'data_validation': '#8b5cf6',
                    'form_submission': '#06b6d4'
                };

                html += `
                    <div style="margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                        <div style="background: var(--gradient-primary); padding: 16px; cursor: pointer;" onclick="toggleFeature(${idx})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="color: white; margin: 0; font-size: 16px; font-weight: 600;">
                                        ${feature.feature_name}
                                    </h3>
                                    <p style="color: rgba(255,255,255,0.8); margin: 4px 0 0 0; font-size: 13px;">
                                        ${feature.pages.length} pages ‚Ä¢ ${feature.test_cases.length} test cases
                                    </p>
                                </div>
                                <span id="feature_arrow_${idx}" style="color: white; font-size: 20px; transition: transform 0.3s;">‚ñº</span>
                            </div>
                        </div>
                        <div id="feature_content_${idx}" style="display: none; padding: 16px; background: var(--bg-secondary);">
                            ${Object.entries(testCasesByType).map(([type, testCases]) => `
                                <div style="margin-bottom: 16px;">
                                    <div style="display: inline-block; padding: 6px 12px; background: ${typeColors[type] || '#6b7280'}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; margin-bottom: 8px;">
                                        ${type.replace(/_/g, ' ').toUpperCase()} (${testCases.length})
                                    </div>
                                    ${testCases.map(tc => {
                                        const status = tc.status || 'pending';
                                        const statusColors = {
                                            'passed': { bg: '#d1fae5', color: '#065f46', icon: '‚úÖ' },
                                            'failed': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                                            'skipped': { bg: '#f3f4f6', color: '#6b7280', icon: '‚è≠Ô∏è' },
                                            'running': { bg: '#dbeafe', color: '#1e40af', icon: '‚è≥' },
                                            'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è∏Ô∏è' }
                                        };
                                        const statusStyle = statusColors[status] || statusColors['pending'];
                                        return `
                                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                        <span style="font-weight: 600; color: var(--text);">${tc.test_name}</span>
                                                        <span style="padding: 2px 8px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                                            ${statusStyle.icon} ${status.toUpperCase()}
                                                        </span>
                                                    </div>
                                                    <span style="margin-left: 0; padding: 2px 8px; background: ${tc.priority === 'high' ? '#fef3c7' : '#e0e7ff'}; color: ${tc.priority === 'high' ? '#92400e' : '#3730a3'}; border-radius: 4px; font-size: 11px; font-weight: 600;">${tc.priority.toUpperCase()}</span>
                                                </div>
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">
                                                <strong>Steps:</strong>
                                                <ol style="margin: 4px 0 0 0; padding-left: 20px;">
                                                    ${tc.steps.map(step => `<li>${step}</li>`).join('')}
                                                </ol>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            featuresList.innerHTML = html;
        }

        function toggleFeature(idx) {
            const content = document.getElementById(`feature_content_${idx}`);
            const arrow = document.getElementById(`feature_arrow_${idx}`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function processEvents(events) {
            events.forEach(event => {
                addEventToLog(event);
                if (event.type === 'page_discovered') {
                    addPageToList(event.data);
                } else if (event.type === 'page_visit_started') {
                    // Show live progress: "Visiting page X of Y"
                    updateDiscoveryProgress(event.data);
                } else if (event.type === 'page_testing_started') {
                    // Show: "Testing all interactions on page..."
                    updatePageTestingStatus(event.data, 'started');
                } else if (event.type === 'page_action_testing') {
                    // Show: "Testing search...", "Testing filters...", etc.
                    updatePageActionStatus(event.data);
                } else if (event.type === 'page_testing_completed') {
                    // Show: "Page testing completed"
                    updatePageTestingStatus(event.data, 'completed');
                } else if (event.type === 'discovery_completed') {
                    updateDiscoveryStats(event.data);
                    stopEventsPolling();
                } else if (event.type === 'health_check_started') {
                    showHealthCheckDashboard(event.data);
                } else if (event.type === 'page_validation_started') {
                    addPageToHealthTable(event.data);
                } else if (event.type === 'health_check_started_individual') {
                    updateHealthCheckStatus(event.data.url, event.data.type, 'running');
                    incrementHealthCounter('concurrent');
                } else if (event.type === 'health_check_completed_individual') {
                    updateHealthCheckStatus(event.data.url, event.data.type, event.data.status);
                    updateHealthCheckDuration(event.data.url, event.data.type, event.data.duration_ms);
                    decrementHealthCounter('concurrent');
                    if (event.data.status === 'passed') {
                        incrementHealthCounter('passed');
                    } else if (event.data.status === 'failed') {
                        incrementHealthCounter('failed');
                    }
                } else if (event.type === 'page_validation_completed') {
                    updatePageOverallStatus(event.data.url, event.data.status);
                    incrementHealthCounter('pages_validated');
                } else if (event.type === 'health_check_completed') {
                    showHealthCheckSummary(event.data);
                } else if (event.type === 'free_text_execution_started') {
                    showFreeTextExecutionStarted(event.data);
                } else if (event.type === 'free_text_test_started') {
                    showFreeTextTestStarted(event.data);
                } else if (event.type === 'free_text_test_completed') {
                    showFreeTextTestCompleted(event.data);
                } else if (event.type === 'free_text_execution_completed') {
                    showFreeTextExecutionCompleted(event.data);
                } else if (event.type === 'free_text_execution_error') {
                    showFreeTextExecutionError(event.data);
                }
            });
        }

        function updateDiscoveryProgress(data) {
            const progressText = `üìÑ Visiting page ${data.page_number} of ${data.total_pages_limit}${data.nav_path ? ` (${data.nav_path})` : ''}`;
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            entry.style.cssText = 'padding: 10px; margin-bottom: 4px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 13px; font-weight: 500;';
            entry.textContent = progressText;
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight;
        }

        function updatePageTestingStatus(data, status) {
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            const pageName = data.page_name || data.url.split('/').pop() || 'page';
            if (status === 'started') {
                entry.style.cssText = 'padding: 8px; margin-bottom: 4px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 4px; font-size: 12px;';
                entry.textContent = `üß™ Testing all interactions on: ${pageName}`;
            } else {
                entry.style.cssText = 'padding: 8px; margin-bottom: 4px; background: rgba(16, 185, 129, 0.15); border-left: 3px solid #10b981; border-radius: 4px; font-size: 12px; font-weight: 500;';
                entry.textContent = `‚úÖ Completed testing: ${pageName}`;
            }
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight;
        }

        function updatePageActionStatus(data) {
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            const actionName = data.action.charAt(0).toUpperCase() + data.action.slice(1).replace('_', ' ');
            const icon = data.status === 'testing' ? '‚è≥' : '‚úì';
            entry.style.cssText = `padding: 6px 8px; margin-bottom: 2px; background: ${data.status === 'testing' ? 'rgba(59, 130, 246, 0.05)' : 'rgba(16, 185, 129, 0.05)'}; border-radius: 4px; font-size: 11px; margin-left: 20px;`;
            entry.textContent = `${icon} ${actionName}...`;
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight;
        }

        function addEventToLog(event) {
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            entry.style.cssText = 'padding: 8px; margin-bottom: 4px; background: white; border-radius: 4px; font-size: 12px;';
            const timestamp = new Date(event.timestamp).toLocaleTimeString();
            const type = event.type.replace(/_/g, ' ');
            let message = '';
            if (event.type === 'page_discovered') {
                message = `üìÑ ${event.data.page_name || event.data.title || event.data.url}`;
            } else if (event.type === 'dropdowns_discovered') {
                message = `üîΩ Found ${event.data.count} dropdown(s)`;
            } else if (event.type === 'navigation_discovered') {
                message = `üß≠ Found ${event.data.count} navigation item(s)`;
            } else if (event.type === 'page_visit_started') {
                message = `üìÑ Visiting page ${event.data.page_number}/${event.data.total_pages_limit}${event.data.nav_path ? ` (${event.data.nav_path})` : ''}`;
            } else if (event.type === 'page_testing_started') {
                message = `üß™ Testing interactions on: ${event.data.page_name || 'page'}`;
            } else if (event.type === 'page_action_testing') {
                const actionName = event.data.action.charAt(0).toUpperCase() + event.data.action.slice(1).replace('_', ' ');
                message = `${event.data.status === 'testing' ? '‚è≥' : '‚úì'} ${actionName}`;
            } else if (event.type === 'page_testing_completed') {
                message = `‚úÖ Completed testing: ${event.data.page_name || 'page'}`;
            } else if (event.type === 'discovery_completed') {
                message = `‚úÖ Discovery completed: ${event.data.pages_count} pages, ${event.data.forms_count} forms`;
            } else if (event.type === 'health_check_started') {
                message = `‚úÖ Starting Phase 1 health checks on ${event.data.total_pages} pages`;
            } else if (event.type === 'page_validation_started') {
                message = `üîç Validating: ${event.data.title}`;
            } else if (event.type === 'health_check_completed_individual') {
                const icon = event.data.status === 'passed' ? '‚úì' : event.data.status === 'failed' ? '‚úó' : '-';
                message = `${icon} ${event.data.type}: ${event.data.status}`;
            } else if (event.type === 'health_check_completed') {
                message = `üéâ Health checks completed: ${event.data.passed} passed, ${event.data.failed} failed`;
            } else if (event.type === 'free_text_execution_started') {
                message = `ü§ñ QA Buddy executing: ${event.data.instruction}`;
            } else if (event.type === 'free_text_test_started') {
                message = `‚ñ∂Ô∏è Testing: ${event.data.test}`;
            } else if (event.type === 'free_text_test_completed') {
                const icon = event.data.status === 'passed' ? '‚úÖ' : '‚ùå';
                message = `${icon} ${event.data.test}: ${event.data.status}`;
            } else if (event.type === 'free_text_execution_completed') {
                message = `‚ú® QA Buddy completed: ${event.data.passed} passed, ${event.data.failed} failed`;
            } else if (event.type === 'free_text_execution_error') {
                message = `‚ùå QA Buddy error: ${event.data.error}`;
            }
            entry.innerHTML = `<span style="color: #999; margin-right: 8px;">${timestamp}</span>${message}`;
            
            // Add to both feeds (right panel and app panel)
            if (feed) {
                feed.appendChild(entry.cloneNode(true));
                feed.scrollTop = feed.scrollHeight;
            }
            
            // Also add to app panel progress feed
            const appFeed = document.getElementById('app_progress_feed');
            if (appFeed) {
                // Clear "waiting" message if present
                if (appFeed.children.length === 1 && appFeed.children[0].textContent.includes('Waiting')) {
                    appFeed.innerHTML = '';
                }
                appFeed.appendChild(entry.cloneNode(true));
                appFeed.scrollTop = appFeed.scrollHeight;
            }
        }

        function addPageToList(pageData) {
            const page = {
                url: pageData.url,
                title: pageData.title || pageData.url,
                page_name: pageData.page_name || pageData.title || pageData.url,
                nav_path: pageData.nav_path || '',
                forms_count: pageData.forms_count || 0,
                actions_count: pageData.actions_count || 0
            };
            const exists = discoveredPages.find(p => p.url === page.url);
            if (exists) {
                const index = discoveredPages.findIndex(p => p.url === page.url);
                discoveredPages[index] = { ...discoveredPages[index], ...page };
            } else {
                discoveredPages.push(page);
            }
            renderPagesList();
        }

        function renderPagesList() {
            const list = document.getElementById('pages_list');
            list.innerHTML = '';
            discoveredPages.forEach((page, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 12px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;';
                item.onmouseover = () => item.style.borderColor = 'var(--primary)';
                item.onmouseout = () => item.style.borderColor = 'transparent';
                item.onclick = () => selectPage(index);
                if (selectedPageIndex === index) {
                    item.style.borderColor = 'var(--primary)';
                    item.style.background = 'rgba(99, 102, 241, 0.1)';
                }
                item.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px;">${page.page_name || page.title}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); word-break: break-all;">${page.url}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                        ${page.forms_count} forms, ${page.actions_count} actions
                    </div>
                `;
                list.appendChild(item);
            });
            if (discoveredPages.length > 0) {
                document.getElementById('pages_card').classList.remove('hidden');
            }
        }

        function selectPage(index) {
            selectedPageIndex = index;
            renderPagesList();
            const page = discoveredPages[index];
            showPageDetails(page);
        }

        function showPageDetails(page) {
            const details = document.getElementById('page_details_content');
            details.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <strong>Page Name:</strong> ${page.page_name || page.title || 'N/A'}<br>
                    <strong>URL:</strong> ${page.url}<br>
                    <strong>Forms:</strong> ${page.forms_count}<br>
                    <strong>Actions:</strong> ${page.actions_count}
                </div>
            `;
            document.getElementById('page_details_card').classList.remove('hidden');
        }

        function updateDiscoveryStats(data) {
            document.getElementById('discovery_pages_count').textContent = data.pages_count || 0;
            document.getElementById('discovery_forms_count').textContent = data.forms_count || 0;
            document.getElementById('discovery_actions_count').textContent = data.actions_count || 0;
            
            // Also update app panel progress stats
            const appPages = document.getElementById('app_progress_pages');
            const appForms = document.getElementById('app_progress_forms');
            const appActions = document.getElementById('app_progress_actions');
            if (appPages) appPages.textContent = data.pages_count || 0;
            if (appForms) appForms.textContent = data.forms_count || 0;
            if (appActions) appActions.textContent = data.actions_count || 0;
        }

        function updateAppPanelTestCases(data) {
            const testCasesList = document.getElementById('testcases_list');
            const testCasesSummary = document.getElementById('testcases_summary');
            
            if (!testCasesList || !data || !data.features) return;
            
            // Calculate summary stats
            let totalTestCases = 0;
            let passedCount = 0;
            let failedCount = 0;
            let pendingCount = 0;
            
            data.features.forEach(feature => {
                feature.test_cases.forEach(tc => {
                    totalTestCases++;
                    const status = tc.status || 'pending';
                    if (status === 'passed') passedCount++;
                    else if (status === 'failed') failedCount++;
                    else pendingCount++;
                });
            });
            
            // Update summary
            testCasesSummary.innerHTML = `
                <div class="stat-card" style="flex: 1;">
                    <div class="stat-value">${totalTestCases}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card success" style="flex: 1;">
                    <div class="stat-value">${passedCount}</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card" style="flex: 1; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);">
                    <div class="stat-value" style="color: #dc2626;">${failedCount}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card" style="flex: 1; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);">
                    <div class="stat-value" style="color: #d97706;">${pendingCount}</div>
                    <div class="stat-label">Pending</div>
                </div>
            `;
            
            // Display test cases in a clean table format
            let html = '';
            data.features.forEach((feature, featureIdx) => {
                feature.test_cases.forEach((tc, tcIdx) => {
                    const status = tc.status || 'pending';
                    const statusColors = {
                        'passed': { bg: '#d1fae5', color: '#065f46', icon: '‚úÖ' },
                        'failed': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                        'skipped': { bg: '#f3f4f6', color: '#6b7280', icon: '‚è≠Ô∏è' },
                        'running': { bg: '#dbeafe', color: '#1e40af', icon: '‚è≥' },
                        'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è∏Ô∏è' }
                    };
                    const statusStyle = statusColors[status] || statusColors['pending'];
                    const priorityColor = tc.priority === 'high' ? '#fef3c7' : '#e0e7ff';
                    const priorityTextColor = tc.priority === 'high' ? '#92400e' : '#3730a3';
                    
                    html += `
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 16px; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 15px;">${tc.test_name}</span>
                                        <span style="padding: 4px 10px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                            ${statusStyle.icon} ${status.toUpperCase()}
                                        </span>
                                        <span style="padding: 4px 10px; background: ${priorityColor}; color: ${priorityTextColor}; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                            ${tc.priority.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                        <strong>Feature:</strong> ${feature.feature_name} | <strong>Type:</strong> ${tc.test_type.replace(/_/g, ' ')}
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                <strong style="color: var(--text-primary);">Steps:</strong>
                                <ol style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.6;">
                                    ${tc.steps.map(step => `<li style="margin-bottom: 4px;">${step}</li>`).join('')}
                                </ol>
                            </div>
                        </div>
                    `;
                });
            });
            
            testCasesList.innerHTML = html || '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><p>No test cases available yet.</p></div>';
        }

        // Health Check Dashboard Functions
        let healthCheckTotalPages = 0;

        function showHealthCheckDashboard(data) {
            const dashboard = document.getElementById('health_check_dashboard');
            dashboard.classList.remove('hidden');
            healthCheckTotalPages = data.total_pages || 0;

            // Initialize counters
            document.getElementById('health_pages_validated').textContent = `0 / ${healthCheckTotalPages}`;
            document.getElementById('health_checks_passed').textContent = '0';
            document.getElementById('health_checks_failed').textContent = '0';
            document.getElementById('health_concurrent_tests').textContent = '0';
        }

        function addPageToHealthTable(data) {
            const tbody = document.getElementById('health_check_table_body');
            const row = document.createElement('tr');
            const urlKey = encodeURIComponent(data.url);
            row.id = `health_page_${urlKey}`;
            row.dataset.url = data.url;

            row.innerHTML = `
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${data.url}">
                    <div style="font-weight: 500;">${data.title || 'Untitled'}</div>
                    <div style="font-size: 11px; color: #666;">${data.url}</div>
                </td>
                <td><span class="health-check-status pending" data-check="table_listing">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="pagination">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="search">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="filters">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="sort">‚è≥</span></td>
                <td><span class="health-check-status pending">Pending</span></td>
                <td>-</td>
            `;

            tbody.appendChild(row);
        }

        function updateHealthCheckStatus(url, checkType, status) {
            const rows = document.querySelectorAll('#health_check_table_body tr');
            let targetRow = null;

            for (const row of rows) {
                if (row.dataset.url === url) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) return;

            const checkCell = targetRow.querySelector(`[data-check="${checkType}"]`);
            if (checkCell) {
                checkCell.className = 'health-check-status ' + status;
                checkCell.textContent = getHealthStatusIcon(status);
            }
        }

        function updateHealthCheckDuration(url, checkType, durationMs) {
            const rows = document.querySelectorAll('#health_check_table_body tr');
            let targetRow = null;

            for (const row of rows) {
                if (row.dataset.url === url) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) return;

            const durationCell = targetRow.cells[7];
            const currentDuration = durationCell.textContent;
            if (currentDuration === '-') {
                durationCell.textContent = `${durationMs}ms`;
            } else {
                const total = parseInt(currentDuration) + durationMs;
                durationCell.textContent = `${total}ms`;
            }
        }

        function updatePageOverallStatus(url, status) {
            const rows = document.querySelectorAll('#health_check_table_body tr');
            let targetRow = null;

            for (const row of rows) {
                if (row.dataset.url === url) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) return;

            const statusCell = targetRow.cells[6];
            statusCell.innerHTML = `<span class="health-check-status ${status}">${status.toUpperCase()}</span>`;
        }

        function incrementHealthCounter(type) {
            if (type === 'pages_validated') {
                const elem = document.getElementById('health_pages_validated');
                const parts = elem.textContent.split(' / ');
                const current = parseInt(parts[0]) + 1;
                elem.textContent = `${current} / ${healthCheckTotalPages}`;
            } else if (type === 'passed') {
                const elem = document.getElementById('health_checks_passed');
                elem.textContent = parseInt(elem.textContent) + 1;
            } else if (type === 'failed') {
                const elem = document.getElementById('health_checks_failed');
                elem.textContent = parseInt(elem.textContent) + 1;
            } else if (type === 'concurrent') {
                const elem = document.getElementById('health_concurrent_tests');
                elem.textContent = parseInt(elem.textContent) + 1;
            }
        }

        function decrementHealthCounter(type) {
            if (type === 'concurrent') {
                const elem = document.getElementById('health_concurrent_tests');
                const current = parseInt(elem.textContent);
                elem.textContent = Math.max(0, current - 1);
            }
        }

        function getHealthStatusIcon(status) {
            switch(status) {
                case 'pending': return '‚è≥';
                case 'running': return '‚è≥';
                case 'passed': return '‚úì';
                case 'failed': return '‚úó';
                case 'skipped': return '-';
                default: return '?';
            }
        }

        function showHealthCheckSummary(data) {
            // Final summary could show a notification or update the UI
            console.log('Health Check Summary:', data);
        }

        // Ask QA Buddy Event Handlers
        function showFreeTextExecutionStarted(data) {
            console.log('QA Buddy started:', data.instruction);
            // Could show a banner or notification
        }

        function showFreeTextTestStarted(data) {
            console.log('QA Buddy test started:', data.test);
        }

        function showFreeTextTestCompleted(data) {
            console.log('QA Buddy test completed:', data.test, data.status);
        }

        function showFreeTextExecutionCompleted(data) {
            console.log('QA Buddy execution completed:', data);
            // Could show a summary notification
        }

        function showFreeTextExecutionError(data) {
            console.error('QA Buddy error:', data.error);
            // Could show an error notification
        }

        function updateStatus(data) {
            document.getElementById('run_id_display')?.textContent || (document.getElementById('status_content').innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Run ID:</strong> ${data.run_id || '-'}</div>
                <div style="margin-bottom: 8px;"><strong>State:</strong> ${data.state || '-'}</div>
                <div style="margin-bottom: 8px;"><strong>URL:</strong> ${data.current_url || '-'}</div>
                <div class="progress-bar"><div class="progress-fill" style="width: ${data.progress || 0}%"></div></div>
            `);
            
            const badge = document.getElementById('status_badge');
            if (badge) {
                badge.textContent = data.state || '-';
                badge.className = 'status-badge ' + (data.state === 'DONE' ? 'active' : data.state === 'FAILED' ? 'error' : 'running');
            }

            if (data.current_url && data.current_url !== currentAppUrl) {
                currentAppUrl = data.current_url;
                const iframe = document.getElementById('app_iframe');
                const iframeBlocked = document.getElementById('iframe_blocked');
                if (iframeBlocked.classList.contains('hidden')) {
                    iframe.src = data.current_url;
                }
            }

            if (data.question) {
                currentQuestion = data.question;
                showQuestion(data.question);
            } else {
                document.getElementById('question_card').classList.add('hidden');
            }
        }

        function showQuestion(question) {
            const card = document.getElementById('question_card');
            const content = document.getElementById('question_content');
            card.classList.remove('hidden');
            content.innerHTML = `<div class="question-text">${question.text || ''}</div>`;
            
            if (question.type === 'select_one' && question.options) {
                const options = document.createElement('div');
                options.className = 'question-options';
                question.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-button';
                    btn.textContent = option.label || option.id;
                    btn.onclick = () => submitAnswer(question.id, option.id);
                    options.appendChild(btn);
                });
                content.appendChild(options);
            } else if (question.type === 'confirm') {
                const buttons = document.createElement('div');
                buttons.style.cssText = 'display: flex; gap: 10px;';
                ['Yes', 'No'].forEach(answer => {
                    const btn = document.createElement('button');
                    btn.className = answer === 'Yes' ? 'btn-success' : 'btn-danger';
                    btn.textContent = answer;
                    btn.onclick = () => submitAnswer(question.id, answer.toLowerCase());
                    buttons.appendChild(btn);
                });
                content.appendChild(buttons);
            }
        }

        async function submitAnswer(questionId, answer) {
            if (!currentRunId) return;
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: questionId, answer })
                });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                showMessage('Answer submitted', 'success');
                updateStatus(data);
            } catch (error) {
                showMessage(`Failed: ${error.message}`, 'error');
            }
        }

        async function submitFreeText() {
            const input = document.getElementById('free_text_input');
            const text = input.value.trim();
            if (!text || !currentRunId) {
                showMessage('Please enter a question', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: 'free_text', answer: text })
                });
                if (!response.ok) throw new Error(await response.text());
                input.value = '';
                showMessage('Message sent', 'success');
            } catch (error) {
                showMessage(`Failed: ${error.message}`, 'error');
            }
        }

        function loadAppInIframe(baseUrl, currentUrl = null) {
            const iframe = document.getElementById('app_iframe');
            const iframeBlocked = document.getElementById('iframe_blocked');
            const urlToLoad = currentUrl || baseUrl;
            currentAppUrl = urlToLoad;
            iframeBlocked.classList.add('hidden');
            iframe.src = urlToLoad;
            setTimeout(() => {
                try {
                    iframe.contentDocument;
                } catch (e) {
                    iframeBlocked.classList.remove('hidden');
                    iframe.classList.add('hidden');
                }
            }, 1500);
        }

        function checkReportAvailable() {
            if (!currentRunId) return;
            fetch(`${API_BASE}/runs/${currentRunId}/report`)
                .then(r => r.ok && document.getElementById('report_card').classList.remove('hidden'))
                .catch(() => {});
        }

        function openReport() {
            if (currentRunId) window.open(`${API_BASE}/runs/${currentRunId}/report`, '_blank');
        }

        function showMessage(message, type) {
            const area = document.getElementById('message_area');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            area.innerHTML = '';
            area.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function displayImageAnalysis(results) {
            // Create or update analysis display card
            let analysisCard = document.getElementById('image_analysis_card');
            if (!analysisCard) {
                analysisCard = document.createElement('div');
                analysisCard.id = 'image_analysis_card';
                analysisCard.className = 'card';
                analysisCard.style.marginTop = '20px';
                document.getElementById('tab-media').appendChild(analysisCard);
            }
            
            let html = '<div class="card-header"><h2 class="card-title"><span class="icon">üîç</span> Image Analysis Results</h2></div>';
            html += '<div style="padding: 16px;">';
            
            results.forEach((result, idx) => {
                html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">`;
                html += `<strong>${result.filename}</strong><br>`;
                html += `<div style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);">`;
                html += `üìä UI Elements: ${result.ui_elements || 0}<br>`;
                html += `üß© Components: ${result.components?.join(', ') || 'None'}<br>`;
                html += `üîÑ Workflows: ${result.workflows || 0}`;
                html += `</div></div>`;
            });
            
            html += '</div>';
            analysisCard.innerHTML = html;
        }
    </script>
</body>
</html>
