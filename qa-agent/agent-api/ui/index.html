<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Buddy - AI-Powered Test Discovery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-dark: #0f172a;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-info: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .app-panel {
            width: 60%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .buddy-panel {
            width: 40%;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            padding: 0;
        }

        .buddy-header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 28px;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
        }

        .buddy-header h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .buddy-header h1::before {
            content: "ü§ñ";
            font-size: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .buddy-header .subtitle {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .buddy-content {
            padding: 24px;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .file-upload-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .file-upload-hint {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Hide file inputs inside file-upload-area (they use onclick handlers) */
        .file-upload-area input[type="file"] {
            display: none;
        }
        
        /* Keep prd_upload and images_upload visible - they don't have click handlers */
        #prd_upload,
        #images_upload {
            display: block;
        }

        .file-preview {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-preview-item {
            position: relative;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .file-preview-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .file-preview-item video {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .file-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        button:hover:not(:disabled)::before {
            opacity: 1;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -2px rgba(99, 102, 241, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0px);
        }

        button:disabled {
            background: var(--border);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            box-shadow: var(--shadow);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            letter-spacing: 0.3px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-badge.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.25) 100%);
            color: var(--success);
            border: 1.5px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge.active::before {
            animation: pulse-success 2s ease-in-out infinite;
        }

        @keyframes pulse-success {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-badge.running {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.25) 100%);
            color: var(--info);
            border: 1.5px solid rgba(59, 130, 246, 0.3);
        }

        .status-badge.running::before {
            animation: pulse-running 1s ease-in-out infinite;
        }

        @keyframes pulse-running {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .status-badge.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.25) 100%);
            color: var(--danger);
            border: 1.5px solid rgba(239, 68, 68, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .question-panel {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid var(--warning);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 16px;
            color: #856404;
            font-weight: 500;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-button {
            background: white;
            border: 2px solid var(--warning);
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 14px;
        }

        .option-button:hover {
            background: #fff9e6;
            border-color: #f59e0b;
            transform: translateX(4px);
        }

        .discovery-feed {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border-light);
            box-shadow: var(--shadow-md);
        }

        .discovery-feed::-webkit-scrollbar {
            width: 8px;
        }

        .discovery-feed::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .discovery-feed::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .discovery-feed::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .discovery-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--border-light);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-card.success::before {
            background: var(--gradient-success);
        }

        .stat-card.success .stat-value {
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.info::before {
            background: var(--gradient-info);
        }

        .stat-card.info .stat-value {
            background: var(--gradient-info);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 2px solid var(--border);
            box-shadow: var(--shadow);
        }

        .app-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -2px;
            border-radius: 6px 6px 0 0;
        }

        .app-tab:hover {
            background: var(--bg-tertiary);
        }

        .app-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg-primary);
            font-weight: 600;
        }

        .app-view {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .app-view.active {
            display: flex;
            flex-direction: column;
        }

        .app-iframe-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--bg-tertiary);
        }

        .app-iframe-header {
            padding: 12px 20px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .app-iframe-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .app-iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .future-discovery-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .future-discovery-section h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 16px;
        }

        .future-discovery-section p {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Health Check Dashboard Styles */
        .health-check-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .health-check-table th {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 2px solid #d1d5db;
            white-space: nowrap;
        }

        .health-check-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
        }

        .health-check-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .health-check-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .health-check-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            min-width: 60px;
        }

        .health-check-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .health-check-status.running {
            background: #dbeafe;
            color: #1e40af;
            animation: pulse-health 2s infinite;
        }

        .health-check-status.passed {
            background: #d1fae5;
            color: #065f46;
        }

        .health-check-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .health-check-status.skipped {
            background: #f3f4f6;
            color: #6b7280;
        }

        @keyframes pulse-health {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .health-page-title {
            font-weight: 500;
            color: #111827;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .health-page-url {
            font-size: 11px;
            color: #9ca3af;
            display: block;
            margin-top: 2px;
        }

        .health-duration {
            font-size: 12px;
            color: #6b7280;
            font-family: 'Monaco', 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Left Panel: Application UI -->
        <div class="app-panel">
            <!-- Current Run Indicator -->
            <div id="current_run_indicator" style="display: none; padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 12px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                <span>üîµ Current Run: <span id="current_run_id_display" style="font-family: monospace; font-size: 13px;">-</span></span>
                <button onclick="copyRunId()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                    üìã Copy ID
                </button>
            </div>

            <!-- App Panel Tabs -->
            <div class="app-tabs">
                <button class="app-tab active" onclick="switchAppTab('testcases')">‚úÖ Test Cases</button>
                <button class="app-tab" onclick="switchAppTab('progress')">‚è±Ô∏è Live Progress</button>
                <button class="app-tab" onclick="switchAppTab('history')">üìú Discovery History</button>
                <button class="app-tab" onclick="switchAppTab('execution-history')">üß™ Test Execution History</button>
            </div>

            <!-- Application View (Hidden - Not Needed) -->
            <div id="app-view" class="app-view" style="display: none;">
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <!-- Discovered Features Cards Section -->
                    <div id="app_discovered_features" style="padding: 20px; background: var(--bg-secondary); border-bottom: 2px solid var(--border); display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 8px;">
                                <span>üîç</span> Discovered Features
                            </h3>
                            <button onclick="viewReport()" class="btn-secondary btn-sm" id="app_view_report_btn" style="display: none;">
                                üìä View Full Report
                            </button>
                        </div>
                        <div id="app_features_cards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <!-- Feature cards will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Application Iframe Section -->
                    <div class="app-iframe-container" style="flex: 1; overflow: hidden;">
                        <div class="app-iframe-header">
                            <h3>üì± Application UI</h3>
                            <button id="open_app_tab_btn" class="btn-sm hidden" style="background: var(--success);">
                                Open in New Tab
                            </button>
                        </div>
                        <iframe id="app_iframe" class="app-iframe" src="about:blank" title="Application"></iframe>
                        <div id="iframe_blocked" class="hidden" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: var(--bg-tertiary);">
                            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 16px;">‚ö†Ô∏è Application cannot be embedded (X-Frame-Options blocked)</p>
                            <p style="color: var(--text-secondary); font-size: 14px; max-width: 400px; margin-bottom: 20px;">
                                This is a security feature. QA Buddy uses Playwright in the background to interact with your application.
                            </p>
                            <button id="open_app_tab_btn2" onclick="window.open(currentAppUrl || document.getElementById('base_url').value, '_blank')">
                                Open Application in New Tab
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Cases View -->
            <div id="testcases-view" class="app-view active">
                <div style="padding: 20px; height: 100%; overflow-y: auto; background: var(--bg-secondary);">
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="font-size: 22px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px; margin: 0;">
                                <span>‚úÖ</span> Test Cases
                            </h2>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="selectAllTestCases()" class="btn-secondary btn-sm" id="select_all_btn" style="display: none;">
                                    Select All
                                </button>
                                <button onclick="deselectAllTestCases()" class="btn-secondary btn-sm" id="deselect_all_btn" style="display: none;">
                                    Deselect All
                                </button>
                                <button onclick="executeSelectedTests()" class="btn-success btn-sm" id="execute_tests_btn" style="display: none;">
                                    ‚ñ∂Ô∏è Run Selected Tests
                                </button>
                                <button onclick="viewReport()" class="btn-secondary btn-sm" id="view_report_btn" style="display: none;">
                                    üìä View Report
                                </button>
                            </div>
                        </div>
                        <div id="testcases_summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px;">
                            <!-- Summary stats will be populated here -->
                        </div>
                    </div>
                    <div id="testcases_list" style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                            <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">No test cases available yet</p>
                            <p style="font-size: 14px;">Start a discovery run to see test cases with their status</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Progress View -->
            <div id="progress-view" class="app-view">
                <div style="padding: 20px; height: 100%; overflow-y: auto; background: var(--bg-secondary);">
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="font-size: 22px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px; margin: 0;">
                                <span>üìä</span> Live Discovery Progress
                                <span style="font-size: 12px; font-weight: 400; color: var(--text-secondary); margin-left: 8px;">(Works in headless mode)</span>
                            </h2>
                            <div id="discovery_status_badge" style="padding: 8px 16px; background: var(--bg-tertiary); border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary);"></span>
                                <span>Not Started</span>
                            </div>
                        </div>
                        <div class="discovery-stats" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="app_progress_pages">0</div>
                                <div class="stat-label">Pages</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="app_progress_forms">0</div>
                                <div class="stat-label">Forms</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="app_progress_actions">0</div>
                                <div class="stat-label">Actions</div>
                            </div>
                        </div>
                    </div>
                    <div id="app_progress_feed" class="discovery-feed" style="max-height: calc(100vh - 280px); background: white; border-radius: 12px; padding: 16px;">
                        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary);">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                            <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">Waiting for discovery to start...</p>
                            <p style="font-size: 14px; margin-bottom: 12px;">Progress will appear here in real-time</p>
                            <p style="font-size: 12px; color: var(--primary); font-weight: 500;">
                                ‚ö° Auto-updates every second - no refresh needed!
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discovery History View -->
            <div id="history-view" class="app-view">
                <div style="padding: 20px; height: 100%; overflow-y: auto; background: var(--bg-secondary);">
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="font-size: 22px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px; margin: 0;">
                                <span>üìú</span> Discovery History
                            </h2>
                            <button onclick="loadRunHistory()" class="btn-secondary btn-sm">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div id="run_history_list" style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                            <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">Loading discovery history...</p>
                            <p style="font-size: 14px;">Past discovery runs will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Execution History View -->
            <div id="execution-history-view" class="app-view">
                <div style="padding: 20px; height: 100%; overflow-y: auto; background: var(--bg-secondary);">
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="font-size: 22px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px; margin: 0;">
                                <span>üß™</span> Test Execution History
                            </h2>
                            <button onclick="loadTestExecutionHistory()" class="btn-secondary btn-sm">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                    <div id="execution_history_list" style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üß™</div>
                            <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">Loading test execution history...</p>
                            <p style="font-size: 14px;">Past test execution runs will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: QA Buddy -->
        <div class="buddy-panel">
            <div class="buddy-header">
                <h1>ü§ñ QA Buddy</h1>
                <p class="subtitle">AI-Powered Automated Test Discovery</p>
                <button onclick="showCapabilities()" style="margin-top: 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">
                    ‚ÑπÔ∏è What Can AI Do?
                </button>
            </div>

            <div class="buddy-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
                    <button class="tab" onclick="switchTab('discovery')">üìä Results</button>
                </div>

                <!-- Configuration Tab -->
                <div id="tab-config" class="tab-content active">
                    <!-- AI Capabilities Info Card -->
                    <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border: 2px solid rgba(99, 102, 241, 0.2); margin-bottom: 16px;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(99, 102, 241, 0.2);">
                            <h2 class="card-title" style="color: var(--primary);">
                                <span class="icon">‚ú®</span> AI-Powered Capabilities
                            </h2>
                        </div>
                        <div style="padding: 16px;">
                            <p style="font-size: 14px; color: var(--text-primary); margin-bottom: 16px; line-height: 1.6;">
                                <strong>QA Buddy now supports AI-powered test generation!</strong> Enable AI to get smarter, more comprehensive test cases.
                            </p>
                            
                            <div style="display: grid; gap: 12px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                                    <span style="font-size: 18px;">üß†</span>
                                    <div>
                                        <strong style="font-size: 13px; color: var(--text-primary);">Contextual Understanding</strong>
                                        <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">AI understands page purpose and generates context-aware tests</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                                    <span style="font-size: 18px;">üéØ</span>
                                    <div>
                                        <strong style="font-size: 13px; color: var(--text-primary);">Edge Case Detection</strong>
                                        <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">Identifies edge cases like special characters, empty inputs, boundary conditions</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                                    <span style="font-size: 18px;">üìä</span>
                                    <div>
                                        <strong style="font-size: 13px; color: var(--text-primary);">Better Test Coverage</strong>
                                        <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">Generates 2-3x more comprehensive tests than rule-based alone</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                                    <span style="font-size: 18px;">üîÑ</span>
                                    <div>
                                        <strong style="font-size: 13px; color: var(--text-primary);">Workflow Understanding</strong>
                                        <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">Creates end-to-end workflows (create ‚Üí edit ‚Üí delete sequences)</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: 10px; padding: 10px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                                    <span style="font-size: 18px;">üí°</span>
                                    <div>
                                        <strong style="font-size: 13px; color: var(--text-primary);">Realistic Test Data</strong>
                                        <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">Generates appropriate test data based on field types and context</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--info); margin-top: 12px;">
                                <p style="font-size: 12px; color: var(--text-primary); margin: 0; line-height: 1.6;">
                                    <strong>üí° Recommendation:</strong> Start with <strong>Hybrid mode</strong> + <strong>Ollama</strong> (free, local) for best results. Switch to OpenAI for even better quality if needed.
                                </p>
                            </div>
                            
                            <details style="margin-top: 12px;">
                                <summary style="cursor: pointer; font-size: 12px; color: var(--primary); font-weight: 600; padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 4px;">
                                    üìñ Learn More About AI Modes
                                </summary>
                                <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.8); border-radius: 6px; font-size: 12px; line-height: 1.6;">
                                    <p style="margin-bottom: 10px;"><strong>Normal Mode:</strong> Traditional rule-based generation. Fast, predictable, no AI required.</p>
                                    <p style="margin-bottom: 10px;"><strong>Hybrid Mode:</strong> Combines rule-based tests with AI-generated tests. Best of both worlds - comprehensive coverage with reliability.</p>
                                    <p style="margin-bottom: 10px;"><strong>AI-Powered Mode:</strong> Pure AI generation. Most comprehensive but requires model setup. Best for complex applications.</p>
                                    <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);"><strong>Providers:</strong></p>
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li><strong>Ollama:</strong> Free, runs locally. Install from ollama.ai. Good quality, no API costs.</li>
                                        <li><strong>OpenAI:</strong> Cloud-based, requires API key. Higher quality (GPT-4), faster responses, but costs money per use.</li>
                                    </ul>
                                </div>
                            </details>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">‚öôÔ∏è</span> Run Configuration</h2>
                        </div>

                        <div class="form-group">
                            <label for="base_url">Base URL *</label>
                            <input type="url" id="base_url" placeholder="https://your-app.example.com" value="">
                        </div>

                        <div class="form-group">
                            <label for="env">Environment</label>
                            <select id="env">
                                <option value="dev">Development</option>
                                <option value="staging" selected>Staging</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="headless" checked>
                                <label for="headless">Run in headless mode</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="discovery_debug">
                                <label for="discovery_debug">Enable discovery debug mode (headed, slowMo, video)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="close_browser_on_complete">
                                <label for="close_browser_on_complete">Close browser automatically when tests complete</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="auth_type">Authentication Type</label>
                            <select id="auth_type">
                                <option value="none">None</option>
                                <option value="keycloak" selected>Keycloak</option>
                            </select>
                        </div>

                        <div class="form-group" id="auth_fields">
                            <label for="username">Username</label>
                            <input type="text" id="username" placeholder="Enter username">
                            <label for="password" style="margin-top: 12px;">Password</label>
                            <input type="password" id="password" placeholder="Enter password">
                        </div>

                        <!-- Document Upload Section -->
                        <details style="margin-top: 16px; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--bg-secondary);">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                üìé Upload Requirements (PRD, Images, Documents)
                            </summary>
                            <div style="margin-top: 16px;">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                    Upload PRD documents, mockups, screenshots, or requirement files to help QA Buddy understand expected behavior and generate better test cases.
                                </p>

                                <!-- PRD/Documents Upload -->
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                                        üìÑ PRD / Requirement Documents
                                        <span style="font-size: 11px; color: var(--text-tertiary); font-weight: 400;">(PDF, DOCX, TXT, MD)</span>
                                    </label>
                                    <div style="margin-top: 8px; position: relative;">
                                        <input type="file" id="prd_upload" accept=".pdf,.docx,.doc,.txt,.md" multiple
                                            style="padding: 12px; border: 2px dashed var(--primary); border-radius: 8px; width: 100%; cursor: pointer; background: var(--bg-secondary); font-size: 14px; color: var(--text-primary);">
                                        <div style="margin-top: 4px; font-size: 12px; color: var(--text-tertiary);">
                                            üëÜ Click to select files or drag & drop here
                                        </div>
                                    </div>
                                    <div id="prd_files_list" style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"></div>
                                </div>

                                <!-- Images Upload -->
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                                        üñºÔ∏è Mockups / Screenshots
                                        <span style="font-size: 11px; color: var(--text-tertiary); font-weight: 400;">(PNG, JPG, JPEG)</span>
                                    </label>
                                    <div style="margin-top: 8px; position: relative;">
                                        <input type="file" id="images_upload" accept=".png,.jpg,.jpeg" multiple
                                            style="padding: 12px; border: 2px dashed var(--primary); border-radius: 8px; width: 100%; cursor: pointer; background: var(--bg-secondary); font-size: 14px; color: var(--text-primary);">
                                        <div style="margin-top: 4px; font-size: 12px; color: var(--text-tertiary);">
                                            üëÜ Click to select images or drag & drop here
                                        </div>
                                    </div>
                                    <div id="images_files_list" style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"></div>
                                </div>

                                <!-- Figma/Design Links -->
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                                        üé® Figma / Design Links
                                        <span style="font-size: 11px; color: var(--text-tertiary); font-weight: 400;">(Optional)</span>
                                    </label>
                                    <input type="url" id="design_links" placeholder="https://figma.com/..." style="margin-top: 8px;">
                                    <textarea id="design_links_additional" rows="2" placeholder="Additional design links (one per line)" style="margin-top: 8px; width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
                                </div>

                                <!-- Expected Behavior Notes -->
                                <div class="form-group" style="margin-top: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                                        üìù Expected Behavior / Notes
                                        <span style="font-size: 11px; color: var(--text-tertiary); font-weight: 400;">(Optional)</span>
                                    </label>
                                    <textarea id="expected_behavior" rows="4" placeholder="Describe expected behavior, user flows, critical features to test, or any specific requirements..." style="margin-top: 8px; width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px;"></textarea>
                                </div>

                                <button onclick="clearUploads()" style="margin-top: 12px; padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    üóëÔ∏è Clear All Uploads
                                </button>
                            </div>
                        </details>

                        <!-- AI/Model Configuration -->
                        <details style="margin-top: 16px; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(139, 92, 246, 0.03) 100%);">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                                ü§ñ AI-Powered Test Generation (Optional)
                            </summary>
                            <div style="margin-top: 16px;">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6;">
                                    Enable AI-powered test case generation for smarter, more comprehensive test coverage. Choose between free local models (Ollama) or cloud models (OpenAI).
                                </p>

                                <!-- Enable AI Toggle -->
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                                        <input type="checkbox" id="ai_enabled" onchange="toggleAIConfig()" style="width: 18px; height: 18px; cursor: pointer;">
                                        Enable AI-Powered Test Generation
                                    </label>
                                    <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px; margin-left: 26px;">
                                        When enabled, AI will enhance or generate test cases using intelligent analysis
                                    </p>
                                </div>

                                <!-- AI Configuration (hidden by default) -->
                                <div id="ai_config_section" style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                                    <!-- AI Mode Selection -->
                                    <div class="form-group" style="margin-bottom: 16px;">
                                        <label for="ai_mode" style="font-weight: 600; margin-bottom: 8px; display: block;">Generation Mode</label>
                                        <select id="ai_mode" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                                            <option value="normal">Normal (Rule-based only)</option>
                                            <option value="hybrid">Hybrid (Rule-based + AI)</option>
                                            <option value="ai">AI-Powered (AI only)</option>
                                        </select>
                                        <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                                            <strong>Normal:</strong> Traditional rule-based generation (fast, predictable)<br>
                                            <strong>Hybrid:</strong> Combines rule-based and AI for best results<br>
                                            <strong>AI-Powered:</strong> Pure AI generation (requires model setup)
                                        </p>
                                    </div>

                                    <!-- Provider Selection -->
                                    <div class="form-group" style="margin-bottom: 16px;">
                                        <label for="ai_provider" style="font-weight: 600; margin-bottom: 8px; display: block;">AI Provider</label>
                                        <select id="ai_provider" onchange="toggleProviderConfig()" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                                            <option value="none">None (Rule-based only)</option>
                                            <option value="ollama">Ollama (Free, Local)</option>
                                            <option value="openai">OpenAI (Cloud, Paid)</option>
                                        </select>
                                        <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                                            <strong>Ollama:</strong> Free, runs locally. Install from <a href="https://ollama.ai" target="_blank" style="color: var(--primary);">ollama.ai</a><br>
                                            <strong>OpenAI:</strong> Cloud-based, requires API key. More powerful models.
                                        </p>
                                    </div>

                                    <!-- Ollama Configuration -->
                                    <div id="ollama_config" style="display: none; margin-top: 16px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; border: 1px solid rgba(99, 102, 241, 0.2);">
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label for="ollama_base_url" style="font-weight: 600; margin-bottom: 6px; display: block;">Ollama Base URL</label>
                                            <input type="url" id="ollama_base_url" placeholder="http://localhost:11434" value="http://localhost:11434" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">Default: http://localhost:11434 (Ollama default port)</p>
                                        </div>
                                        <div class="form-group">
                                            <label for="ollama_model" style="font-weight: 600; margin-bottom: 6px; display: block;">Model Name</label>
                                            <select id="ollama_model" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                                                <option value="llama2">llama2 (Recommended)</option>
                                                <option value="mistral">mistral</option>
                                                <option value="codellama">codellama</option>
                                                <option value="llama2:13b">llama2:13b (Larger, slower)</option>
                                                <option value="llama2:70b">llama2:70b (Largest, slowest)</option>
                                            </select>
                                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                                                Make sure the model is installed: <code style="background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px;">ollama pull llama2</code>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- OpenAI Configuration -->
                                    <div id="openai_config" style="display: none; margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label for="openai_api_key" style="font-weight: 600; margin-bottom: 6px; display: block;">OpenAI API Key</label>
                                            <input type="password" id="openai_api_key" placeholder="sk-..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                                                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary);">OpenAI Platform</a>
                                            </p>
                                        </div>
                                        <div class="form-group">
                                            <label for="openai_model" style="font-weight: 600; margin-bottom: 6px; display: block;">Model</label>
                                            <select id="openai_model" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                                                <option value="gpt-3.5-turbo">gpt-3.5-turbo (Fast, Cost-effective)</option>
                                                <option value="gpt-4">gpt-4 (More powerful, Slower)</option>
                                                <option value="gpt-4-turbo">gpt-4-turbo (Best balance)</option>
                                            </select>
                                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">
                                                GPT-4 models provide better quality but are slower and more expensive
                                            </p>
                                        </div>
                                    </div>

                                    <!-- AI Settings Info -->
                                    <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid var(--info);">
                                        <p style="font-size: 12px; color: var(--text-primary); margin: 0; line-height: 1.6;">
                                            <strong>üí° Tip:</strong> Start with "Hybrid" mode and "Ollama" for free local AI. If you need better quality, switch to OpenAI with GPT-4.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- Advanced Discovery Settings -->
                        <details style="margin-top: 16px; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--text-primary);">‚öôÔ∏è Advanced Settings</summary>
                            <div style="margin-top: 12px; display: grid; gap: 12px;">
                                <div class="form-group">
                                    <label for="max_pages">Max Pages</label>
                                    <input type="number" id="max_pages" placeholder="2000" value="2000" min="1" max="10000">
                                </div>
                                <div class="form-group">
                                    <label for="max_forms_per_page">Max Forms Per Page</label>
                                    <input type="number" id="max_forms_per_page" placeholder="50" value="50" min="1" max="200">
                                </div>
                                <div class="form-group">
                                    <label for="max_table_rows">Max Table Rows</label>
                                    <input type="number" id="max_table_rows" placeholder="50" value="50" min="1" max="200">
                                </div>
                                <div class="form-group">
                                    <label for="max_discovery_time">Max Time (minutes)</label>
                                    <input type="number" id="max_discovery_time" placeholder="60" value="60" min="1" max="120">
                                </div>
                            </div>
                        </details>

                        <button id="start_btn" onclick="startRun()" style="width: 100%; margin-top: 20px;">
                            üöÄ Start Discovery Run
                        </button>
                        <button id="stop_btn" class="btn-danger hidden" onclick="stopRun()" style="width: 100%; margin-top: 8px;">
                            ‚èπÔ∏è Stop Polling
                        </button>
                    </div>

                    <!-- Status Card -->
                    <div class="card hidden" id="status_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üìä</span> Run Status</h2>
                            <span id="status_badge" class="status-badge">-</span>
                        </div>
                        <div id="status_content"></div>
                    </div>

                    <!-- Question Card - Hidden (not needed) -->
                    <div class="card hidden" id="question_card" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">‚ùì</span> Action Required</h2>
                        </div>
                        <div id="question_content"></div>
                    </div>

                    <!-- Free Text Input -->
                    <div class="card hidden" id="free_text_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üí¨</span> Ask QA Buddy</h2>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <textarea id="free_text_input" placeholder="What should I test / check / skip?" rows="3" style="flex: 1;"></textarea>
                            <button onclick="submitFreeText()" style="align-self: flex-end;">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Discovery Tab -->
                <div id="tab-discovery" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üîç</span> Live Discovery</h2>
                        </div>
                        <div class="discovery-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="discovery_pages_count">0</div>
                                <div class="stat-label">Pages</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="discovery_forms_count">0</div>
                                <div class="stat-label">Forms</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="discovery_actions_count">0</div>
                                <div class="stat-label">Actions</div>
                            </div>
                        </div>
                        <div id="discovery_feed" class="discovery-feed"></div>
                    </div>

                    <div class="card hidden" id="pages_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üìÑ</span> Discovered Pages</h2>
                        </div>
                        <div id="pages_list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <div class="card hidden" id="page_details_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üìã</span> Page Details</h2>
                        </div>
                        <div id="page_details_content"></div>
                    </div>

                    <!-- Feature-wise Test Cases -->
                    <div class="card hidden" id="features_card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üéØ</span> Discovered Test Cases by Feature</h2>
                        </div>
                        <div id="features_summary" style="margin-bottom: 16px;"></div>
                        <div id="features_list"></div>
                    </div>

                    <!-- Phase 1: Health Check Dashboard -->
                    <div class="card hidden" id="health_check_dashboard">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">‚úÖ</span> Phase 1: Health Check Validation</h2>
                        </div>

                        <!-- Summary Cards -->
                        <div class="discovery-stats" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="health_pages_validated">0 / 0</div>
                                <div class="stat-label">Pages Validated</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);">
                                <div class="stat-value" style="color: #059669;" id="health_checks_passed">0</div>
                                <div class="stat-label">Checks Passed</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);">
                                <div class="stat-value" style="color: #dc2626;" id="health_checks_failed">0</div>
                                <div class="stat-label">Checks Failed</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);">
                                <div class="stat-value" style="color: #2563eb;" id="health_concurrent_tests">0</div>
                                <div class="stat-label">Running Now</div>
                            </div>
                        </div>

                        <!-- Health Check Table -->
                        <div style="overflow-x: auto;">
                            <table class="health-check-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 200px;">Page</th>
                                        <th style="width: 80px; text-align: center;">üìÑ Listing</th>
                                        <th style="width: 80px; text-align: center;">üìä Pagination</th>
                                        <th style="width: 80px; text-align: center;">üîç Search</th>
                                        <th style="width: 80px; text-align: center;">üéõÔ∏è Filters</th>
                                        <th style="width: 80px; text-align: center;">‚ÜïÔ∏è Sort</th>
                                        <th style="width: 120px; text-align: center;">Overall Status</th>
                                        <th style="width: 100px; text-align: center;">Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="health_check_table_body">
                                    <!-- Rows populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Media Upload Tab -->
                <div id="tab-media" class="tab-content" style="display: none;">
                    <!-- Info Banner -->
                    <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 24px;">‚ÑπÔ∏è</span>
                            <h3 style="font-size: 16px; font-weight: 600; color: var(--success);">Upload Before Discovery</h3>
                        </div>
                        <p style="color: var(--text-secondary); line-height: 1.6;">
                            Upload screenshots of your application <strong>before starting discovery</strong>. The AI will analyze images to detect UI patterns, forms, tables, and workflows to guide comprehensive testing.
                        </p>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üì∏</span> Image Upload</h2>
                        </div>
                        <div class="file-upload-area" id="image_upload_area" onclick="document.getElementById('image_input').click()">
                            <div class="file-upload-icon">üì∑</div>
                            <div class="file-upload-text">Click to upload or drag & drop images</div>
                            <div class="file-upload-hint">Supports: JPG, PNG, GIF, WebP (Max 10MB each)</div>
                            <input type="file" id="image_input" accept="image/*" multiple>
                        </div>
                        <div class="file-preview" id="image_preview"></div>
                        <button onclick="uploadImages()" style="width: 100%; margin-top: 12px;" id="upload_images_btn" disabled>
                            üì§ Upload Images
                        </button>

                        <!-- Uploaded Images List -->
                        <div id="uploaded_images_list" style="margin-top: 20px; display: none;">
                            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text);">‚úÖ Uploaded Images</h3>
                            <div id="uploaded_images_container" style="display: flex; flex-direction: column; gap: 8px;"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><span class="icon">üé•</span> Video Upload</h2>
                        </div>
                        <div class="file-upload-area" id="video_upload_area" onclick="document.getElementById('video_input').click()">
                            <div class="file-upload-icon">üé¨</div>
                            <div class="file-upload-text">Click to upload or drag & drop videos</div>
                            <div class="file-upload-hint">Supports: MP4, WebM, MOV (Max 100MB each)</div>
                            <input type="file" id="video_input" accept="video/*" multiple>
                        </div>
                        <div class="file-preview" id="video_preview"></div>
                        <button onclick="uploadVideos()" style="width: 100%; margin-top: 12px;" id="upload_videos_btn" disabled>
                            üì§ Upload Videos
                        </button>
                    </div>

                    <div class="future-discovery-section">
                        <h3>üîÆ Future Discovery Features</h3>
                        <p>
                            Uploaded images and videos will be analyzed to:
                        </p>
                        <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-secondary); font-size: 14px;">
                            <li>Extract UI elements and components</li>
                            <li>Identify workflows and user journeys</li>
                            <li>Generate test cases from visual patterns</li>
                            <li>Detect accessibility issues</li>
                            <li>Compare UI changes over time</li>
                        </ul>
                    </div>
                </div>

                <!-- Report Section -->
                <div class="card hidden" id="report_card">
                    <div class="card-header">
                        <h2 class="card-title"><span class="icon">üìä</span> Test Report</h2>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn-success" onclick="openReport()" style="width: 100%;">
                            üìÑ Open Full Report
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="message_area"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;

        // State
        let currentRunId = localStorage.getItem('currentRunId') || null;
        let pollingInterval = null;
        let eventsPollingInterval = null;
        let testCasesPollingInterval = null;
        let currentQuestion = null;
        let currentAppUrl = null;
        let eventsCursor = parseInt(localStorage.getItem('eventsCursor_' + currentRunId) || '0');
        let discoveredPages = [];
        let selectedPageIndex = null;
        let uploadedImages = [];
        let uploadedVideos = [];
        let uploadedImageResults = [];  // Store uploaded image metadata for discovery
        let selectedTestCases = new Set(); // Track selected test cases for execution

        // Tab switching (right panel)
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // App panel tab switching (left panel)
        function switchAppTab(viewName) {
            document.querySelectorAll('.app-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${viewName}-view`).classList.add('active');
            
            // Load data when switching to specific views
            if (viewName === 'execution-history') {
                loadTestExecutionHistory();
            } else if (viewName === 'history') {
                loadRunHistory();
            }
        }

        // File upload handlers
        document.getElementById('image_input').addEventListener('change', handleImageSelect);
        document.getElementById('video_input').addEventListener('change', handleVideoSelect);

        // Drag and drop
        setupDragAndDrop('image_upload_area', 'image_input', handleImageSelect);
        setupDragAndDrop('video_upload_area', 'video_input', handleVideoSelect);

        function setupDragAndDrop(areaId, inputId, handler) {
            const area = document.getElementById(areaId);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
            });

            area.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById(inputId).files = files;
                handler({target: {files: Array.from(files)}});
            }, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleImageSelect(e) {
            const files = Array.from(e.target.files || []);
            uploadedImages = [...uploadedImages, ...files];
            renderImagePreviews();
            document.getElementById('upload_images_btn').disabled = uploadedImages.length === 0;
        }

        function handleVideoSelect(e) {
            const files = Array.from(e.target.files || []);
            uploadedVideos = [...uploadedVideos, ...files];
            renderVideoPreviews();
            document.getElementById('upload_videos_btn').disabled = uploadedVideos.length === 0;
        }

        function renderImagePreviews() {
            const preview = document.getElementById('image_preview');
            preview.innerHTML = '';
            uploadedImages.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                const name = document.createElement('span');
                name.textContent = file.name;
                const remove = document.createElement('button');
                remove.className = 'file-remove';
                remove.textContent = '√ó';
                remove.onclick = () => {
                    uploadedImages.splice(index, 1);
                    renderImagePreviews();
                    document.getElementById('upload_images_btn').disabled = uploadedImages.length === 0;
                };
                item.appendChild(img);
                item.appendChild(name);
                item.appendChild(remove);
                preview.appendChild(item);
            });
        }

        function renderVideoPreviews() {
            const preview = document.getElementById('video_preview');
            preview.innerHTML = '';
            uploadedVideos.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.muted = true;
                const name = document.createElement('span');
                name.textContent = file.name;
                const remove = document.createElement('button');
                remove.className = 'file-remove';
                remove.textContent = '√ó';
                remove.onclick = () => {
                    uploadedVideos.splice(index, 1);
                    renderVideoPreviews();
                    document.getElementById('upload_videos_btn').disabled = uploadedVideos.length === 0;
                };
                item.appendChild(video);
                item.appendChild(name);
                item.appendChild(remove);
                preview.appendChild(item);
            });
        }

        function displayUploadedImages(newResults) {
            const listContainer = document.getElementById('uploaded_images_list');
            const imagesContainer = document.getElementById('uploaded_images_container');

            // Show the list
            listContainer.style.display = 'block';

            // Add new images
            newResults.forEach((result, idx) => {
                const imageCard = document.createElement('div');
                imageCard.style.cssText = 'background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 12px;';

                const workflows = result.analysis?.workflows || [];
                const workflowText = workflows.length > 0 ? workflows.join(', ') : 'No workflows detected';

                imageCard.innerHTML = `
                    <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--gradient-success); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                        üì∑
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 13px; color: var(--text); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${result.filename}
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ${result.analysis.ui_elements_count} elements ‚Ä¢ ${result.analysis.components_detected?.length || 0} components
                        </div>
                        <div style="font-size: 11px; color: var(--success); margin-top: 2px;">
                            üí° ${workflowText}
                        </div>
                    </div>
                    <div style="flex-shrink: 0; padding: 4px 8px; background: rgba(16, 185, 129, 0.1); color: var(--success); border-radius: 4px; font-size: 11px; font-weight: 600;">
                        ‚úì Analyzed
                    </div>
                `;

                imagesContainer.appendChild(imageCard);
            });
        }

        async function uploadImages() {
            if (uploadedImages.length === 0) return;

            try {
                showMessage('Uploading images...', 'success');

                // Upload images one by one to pre-run endpoint (no run_id needed)
                const results = [];
                for (const file of uploadedImages) {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_BASE}/runs/upload/image/pre-run`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || `HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    results.push(data);
                }

                // Store results for discovery
                uploadedImageResults = uploadedImageResults.concat(results);

                // Show combined analysis results
                const totalElements = results.reduce((sum, r) => sum + (r.analysis?.ui_elements_count || 0), 0);
                const totalComponents = results.reduce((sum, r) => sum + (r.analysis?.components_detected?.length || 0), 0);
                const totalWorkflows = results.reduce((sum, r) => sum + (r.analysis?.workflow_hints || 0), 0);

                showMessage(
                    `‚úÖ Uploaded ${results.length} image(s)! Analysis: ${totalElements} UI elements, ${totalComponents} components, ${totalWorkflows} workflows detected`,
                    'success'
                );

                // Display uploaded images
                displayUploadedImages(results);

                // Clear upload area
                uploadedImages = [];
                document.getElementById('image_preview').innerHTML = '';
                document.getElementById('upload_images_btn').disabled = true;
            } catch (error) {
                showMessage(`Failed to upload images: ${error.message}`, 'error');
            }
        }

        async function uploadVideos() {
            if (uploadedVideos.length === 0) return;
            if (!currentRunId) {
                showMessage('Please start a run first', 'error');
                return;
            }

            try {
                showMessage('Uploading videos...', 'success');
                const formData = new FormData();
                uploadedVideos.forEach(file => {
                    formData.append('files', file);
                });

                const response = await fetch(`${API_BASE}/runs/${currentRunId}/upload/videos`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                showMessage(`Successfully uploaded ${data.uploaded_count} video(s)`, 'success');
                uploadedVideos = [];
                renderVideoPreviews();
                document.getElementById('upload_videos_btn').disabled = true;
            } catch (error) {
                showMessage(`Failed to upload videos: ${error.message}`, 'error');
            }
        }

        // File upload handling
        let uploadedPRDFiles = [];
        let uploadedImageFiles = [];

        // PRD/Document upload handler
        document.getElementById('prd_upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            uploadedPRDFiles = files;

            const filesList = document.getElementById('prd_files_list');
            if (files.length > 0) {
                filesList.innerHTML = `<strong>üìÑ ${files.length} file(s) selected:</strong><br>` +
                    files.map(f => `<span style="display: block; padding: 4px 0;">‚Ä¢ ${f.name} (${(f.size / 1024).toFixed(1)} KB)</span>`).join('');
                filesList.style.color = 'var(--success)';
            } else {
                filesList.innerHTML = '';
            }
        });

        // Images upload handler
        document.getElementById('images_upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            uploadedImageFiles = files;

            const filesList = document.getElementById('images_files_list');
            if (files.length > 0) {
                filesList.innerHTML = `<strong>üñºÔ∏è ${files.length} image(s) selected:</strong><br>` +
                    files.map(f => `<span style="display: block; padding: 4px 0;">‚Ä¢ ${f.name} (${(f.size / 1024).toFixed(1)} KB)</span>`).join('');
                filesList.style.color = 'var(--success)';
            } else {
                filesList.innerHTML = '';
            }
        });

        // Clear uploads function
        function clearUploads() {
            uploadedPRDFiles = [];
            uploadedImageFiles = [];
            document.getElementById('prd_upload').value = '';
            document.getElementById('images_upload').value = '';
            document.getElementById('design_links').value = '';
            document.getElementById('design_links_additional').value = '';
            document.getElementById('expected_behavior').value = '';
            document.getElementById('prd_files_list').innerHTML = '';
            document.getElementById('images_files_list').innerHTML = '';
            showMessage('‚úÖ Uploads cleared', 'info');
        }

        // Upload files to run
        async function uploadRequirementFiles(runId) {
            const uploadedData = {
                prd_files: [],
                image_files: [],
                design_links: [],
                expected_behavior: ''
            };

            try {
                // Upload PRD files
                if (uploadedPRDFiles.length > 0) {
                    const formData = new FormData();
                    uploadedPRDFiles.forEach(file => formData.append('files', file));

                    const response = await fetch(`${API_BASE}/runs/${runId}/upload/documents`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        uploadedData.prd_files = data.uploaded_files || [];
                        showMessage(`‚úÖ Uploaded ${uploadedData.prd_files.length} PRD document(s)`, 'success');
                    }
                }

                // Upload images
                if (uploadedImageFiles.length > 0) {
                    const formData = new FormData();
                    uploadedImageFiles.forEach(file => formData.append('files', file));

                    const response = await fetch(`${API_BASE}/runs/${runId}/upload/images`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        uploadedData.image_files = data.uploaded_files || [];
                        showMessage(`‚úÖ Uploaded ${uploadedData.image_files.length} image(s)`, 'success');
                    }
                }

                // Collect design links
                const designLink = document.getElementById('design_links').value.trim();
                const additionalLinks = document.getElementById('design_links_additional').value.trim();

                if (designLink) uploadedData.design_links.push(designLink);
                if (additionalLinks) {
                    uploadedData.design_links.push(...additionalLinks.split('\n').map(l => l.trim()).filter(l => l));
                }

                // Collect expected behavior
                uploadedData.expected_behavior = document.getElementById('expected_behavior').value.trim();

                // Send metadata to backend
                if (uploadedData.design_links.length > 0 || uploadedData.expected_behavior) {
                    await fetch(`${API_BASE}/runs/${runId}/metadata`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            design_links: uploadedData.design_links,
                            expected_behavior: uploadedData.expected_behavior
                        })
                    });
                }

                return uploadedData;

            } catch (error) {
                console.error('Error uploading requirement files:', error);
                showMessage(`‚ö†Ô∏è Error uploading files: ${error.message}`, 'warning');
                return uploadedData;
            }
        }

        // Auth type change
        document.getElementById('auth_type').addEventListener('change', function() {
            document.getElementById('auth_fields').style.display = this.value === 'none' ? 'none' : 'block';
        });

        // Start run
        async function startRun() {
            const baseUrl = document.getElementById('base_url').value.trim();
            if (!baseUrl) {
                showMessage('Please enter a base URL', 'error');
                return;
            }

            const payload = {
                base_url: baseUrl,
                env: document.getElementById('env').value,
                headless: document.getElementById('headless').checked,
                discovery_debug: document.getElementById('discovery_debug').checked,
                close_browser_on_complete: document.getElementById('close_browser_on_complete').checked,
                uploaded_images: uploadedImageResults  // Include pre-uploaded images
            };

            // Add AI configuration if enabled
            const aiEnabled = document.getElementById('ai_enabled')?.checked || false;
            if (aiEnabled) {
                const aiProvider = document.getElementById('ai_provider')?.value || 'none';
                const aiMode = document.getElementById('ai_mode')?.value || 'normal';
                
                if (aiProvider !== 'none') {
                    payload.ai_config = {
                        enabled: true,
                        mode: aiMode,
                        provider: aiProvider,
                        temperature: 0.7,
                        max_tokens: 2000,
                        timeout: 60
                    };

                    if (aiProvider === 'ollama') {
                        payload.ai_config.base_url = document.getElementById('ollama_base_url')?.value || 'http://localhost:11434';
                        payload.ai_config.model_name = document.getElementById('ollama_model')?.value || 'llama2';
                    } else if (aiProvider === 'openai') {
                        const apiKey = document.getElementById('openai_api_key')?.value?.trim();
                        if (!apiKey) {
                            showMessage('OpenAI API key is required when using OpenAI provider', 'error');
                            return;
                        }
                        payload.ai_config.api_key = apiKey;
                        payload.ai_config.model_name = document.getElementById('openai_model')?.value || 'gpt-3.5-turbo';
                    }
                }
            }

            // Add advanced discovery configuration
            const maxPages = parseInt(document.getElementById('max_pages').value);
            const maxForms = parseInt(document.getElementById('max_forms_per_page').value);
            const maxTableRows = parseInt(document.getElementById('max_table_rows').value);
            const maxTime = parseInt(document.getElementById('max_discovery_time').value);

            if (!isNaN(maxPages) && maxPages > 0) payload.max_pages = maxPages;
            if (!isNaN(maxForms) && maxForms > 0) payload.max_forms_per_page = maxForms;
            if (!isNaN(maxTableRows) && maxTableRows > 0) payload.max_table_rows_to_click = maxTableRows;
            if (!isNaN(maxTime) && maxTime > 0) payload.max_discovery_time_minutes = maxTime;

            const authType = document.getElementById('auth_type').value;
            if (authType === 'keycloak') {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                if (username && password) {
                    payload.auth = { type: 'keycloak', username, password };
                }
            }

            // Show message if images are being used
            if (uploadedImageResults.length > 0) {
                showMessage(`üéØ Using ${uploadedImageResults.length} uploaded image(s) to guide discovery...`, 'success');
            }

            // Show configuration being used
            if (payload.max_pages || payload.max_forms_per_page || payload.max_table_rows_to_click || payload.max_discovery_time_minutes) {
                showMessage(`‚öôÔ∏è Using custom config: ${payload.max_pages || 2000} pages, ${payload.max_forms_per_page || 50} forms, ${payload.max_table_rows_to_click || 50} table rows, ${payload.max_discovery_time_minutes || 60} min`, 'info');
            }

            try {
                showMessage('Starting run...', 'success');
                document.getElementById('start_btn').disabled = true;

                const response = await fetch(`${API_BASE}/runs/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(await response.text() || `HTTP ${response.status}`);

                const data = await response.json();
                currentRunId = data.run_id;
                localStorage.setItem('currentRunId', currentRunId);
                updateCurrentRunIndicator();

                showMessage(`Run started: ${currentRunId}`, 'success');

                // Upload requirement files if any
                if (uploadedPRDFiles.length > 0 || uploadedImageFiles.length > 0 ||
                    document.getElementById('design_links').value.trim() ||
                    document.getElementById('expected_behavior').value.trim()) {
                    showMessage('üìé Uploading requirement files...', 'info');
                    await uploadRequirementFiles(currentRunId);
                }

                document.getElementById('status_card').classList.remove('hidden');
                document.getElementById('free_text_card').classList.remove('hidden');
                document.getElementById('stop_btn').classList.remove('hidden');

                // Load app in iframe immediately with base URL (but don't switch to app tab yet)
                if (baseUrl) {
                    loadAppInIframe(baseUrl, data.current_url || baseUrl);
                }
                
                // Reset progress stats
                document.getElementById('app_progress_pages').textContent = '0';
                document.getElementById('app_progress_forms').textContent = '0';
                document.getElementById('app_progress_actions').textContent = '0';

                // Reset events cursor for new run
                eventsCursor = 0;
                localStorage.setItem('eventsCursor_' + currentRunId, '0');

                // Reset discovery status
                updateDiscoveryStatus('not_started', null);

                // Reset Test Cases tab for new run
                resetTestCasesView();

                // Reset Live Progress feed for new run
                resetLiveProgressView();

                // Clear any selected test cases from previous run
                selectedTestCases.clear();
                
                // Auto-switch to Live Progress tab FIRST to show headless progress
                // This ensures users see progress updates immediately, especially in headless mode
                const progressTab = document.querySelector('.app-tab[onclick*="progress"]');
                if (progressTab) {
                    // Remove active from all tabs
                    document.querySelectorAll('.app-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
                    // Activate progress tab
                    switchAppTab('progress');
                    progressTab.classList.add('active');
                }
                
                // Clear progress feed and show starting message
                const appFeed = document.getElementById('app_progress_feed');
                if (appFeed) {
                    appFeed.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--success); font-weight: 500;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üöÄ</div>
                            <div style="font-size: 16px; margin-bottom: 8px; font-weight: 600;">Discovery starting...</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                ‚ö° Updates appear automatically - no refresh needed!<br>
                                Watch this tab for real-time progress.
                            </div>
                        </div>
                    `;
                }
                
                updateStatus(data);
                startPolling();
                startEventsPolling(); // This will poll every 1 second and show updates
                startTestCasesPolling(); // Start polling for test cases during discovery
                
                console.log('‚úÖ Run started:', currentRunId, '- Events polling active, watching for updates...');

            } catch (error) {
                showMessage(`Failed to start run: ${error.message}`, 'error');
                document.getElementById('start_btn').disabled = false;
            }
        }

        function startPolling() {
            // Don't start polling if no run ID exists
            if (!currentRunId) {
                console.log('‚ö†Ô∏è No run ID, skipping polling start');
                return;
            }
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                if (!currentRunId) return;
                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/status`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    updateStatus(data);
                    if (data.state === 'DONE' || data.state === 'FAILED') {
                        stopPolling();
                        stopEventsPolling();
                        if (testCasesPollingInterval) {
                            clearInterval(testCasesPollingInterval);
                            testCasesPollingInterval = null;
                        }
                        // Final fetch of test cases
                        fetchAndDisplayFeatures();
                        checkReportAvailable();
                        
                        // Show completion notification
                        if (data.state === 'DONE') {
                            showCompletionNotification('üéâ Discovery and testing completed! View test cases and report.', 'success');
                            // Auto-switch to test cases tab after a delay
                            setTimeout(() => {
                                const testCasesTab = document.querySelector('.app-tab[onclick*="testcases"]');
                                if (testCasesTab) {
                                    switchAppTab('testcases');
                                    testCasesTab.classList.add('active');
                                }
                            }, 1500);
                        } else {
                            showCompletionNotification('‚ùå Discovery failed. Check logs for details.', 'error');
                        }
                    }
                    if (data.state === 'DISCOVERY_RUN' || data.state === 'DISCOVERY_SUMMARY') {
                        switchTab('discovery');
                        // Auto-switch to progress view during discovery (for headless mode visibility)
                        const progressTab = document.querySelector('.app-tab[onclick*="progress"]');
                        if (progressTab) {
                            switchAppTab('progress');
                            progressTab.classList.add('active');
                            document.querySelector('.app-tab[onclick*="app"]')?.classList.remove('active');
                            document.querySelector('.app-tab[onclick*="testcases"]')?.classList.remove('active');
                        }
                    }
                    if (data.state === 'DISCOVERY_SUMMARY' || data.state === 'WAIT_TEST_INTENT') {
                        // Discovery completed, fetch and display features
                        fetchAndDisplayFeatures();
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function stopRun() {
            stopPolling();
            document.getElementById('start_btn').disabled = false;
            document.getElementById('stop_btn').classList.add('hidden');
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            if (eventsPollingInterval) {
                clearInterval(eventsPollingInterval);
                eventsPollingInterval = null;
            }
            if (testCasesPollingInterval) {
                clearInterval(testCasesPollingInterval);
                testCasesPollingInterval = null;
            }
        }

        function startEventsPolling() {
            // Don't start polling if no run ID exists
            if (!currentRunId) {
                console.log('‚ö†Ô∏è No run ID, skipping events polling start');
                return;
            }
            if (eventsPollingInterval) clearInterval(eventsPollingInterval);
            console.log('üîÑ Starting events polling for run:', currentRunId);
            eventsPollingInterval = setInterval(async () => {
                if (!currentRunId) {
                    console.log('‚ö†Ô∏è No current run ID, stopping events polling');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/events?after=${eventsCursor}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    if (data.events && data.events.length > 0) {
                        console.log(`üì• Received ${data.events.length} events, cursor: ${eventsCursor} -> ${data.next_cursor}`);
                        processEvents(data.events);
                        eventsCursor = data.next_cursor;
                        if (currentRunId) {
                            localStorage.setItem('eventsCursor_' + currentRunId, eventsCursor.toString());
                        }
                        
                        // Update progress stats in real-time from events (works in headless mode too)
                        data.events.forEach(event => {
                            if (event.type === 'page_discovered') {
                                // Update stats incrementally - this works even in headless mode
                                const pagesCount = document.getElementById('app_progress_pages');
                                const formsCount = document.getElementById('app_progress_forms');
                                const actionsCount = document.getElementById('app_progress_actions');
                                if (pagesCount) {
                                    const current = parseInt(pagesCount.textContent) || 0;
                                    // Increment page count for each page_discovered event
                                    pagesCount.textContent = (current + 1);
                                }
                                if (formsCount && event.data.forms_count) {
                                    const current = parseInt(formsCount.textContent) || 0;
                                    formsCount.textContent = current + (event.data.forms_count || 0);
                                }
                                if (actionsCount && event.data.actions_count) {
                                    const current = parseInt(actionsCount.textContent) || 0;
                                    actionsCount.textContent = current + (event.data.actions_count || 0);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Events polling error:', error);
                }
            }, 1000); // Poll every 1 second for faster updates - works in headless mode
        }

        function startTestCasesPolling() {
            // Don't start polling if no run ID exists
            if (!currentRunId) {
                console.log('‚ö†Ô∏è No run ID, skipping test cases polling start');
                return;
            }
            // Poll for test cases during discovery (not just at end)
            if (testCasesPollingInterval) clearInterval(testCasesPollingInterval);
            testCasesPollingInterval = setInterval(async () => {
                if (!currentRunId) return;
                try {
                    await fetchAndDisplayFeatures();
                    await fetchTestCases(); // Also fetch test cases during discovery
                } catch (error) {
                    // Silently fail - test cases may not be available yet
                }
            }, 3000); // Poll every 3 seconds for faster updates
        }

        function showCompletionNotification(message, type) {
            // Show a prominent notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                z-index: 10000;
                font-weight: 600;
                font-size: 15px;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <span style="font-size: 24px;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        async function fetchAndDisplayFeatures() {
            if (!currentRunId) return;
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/discovery/features`);
                if (!response.ok) return;
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    displayFeatures(data);
                }
            } catch (error) {
                console.error('Failed to fetch features:', error);
            }
        }

        function displayFeatures(data) {
            const featuresCard = document.getElementById('features_card');
            const featuresSummary = document.getElementById('features_summary');
            const featuresList = document.getElementById('features_list');

            // Show card
            featuresCard.classList.remove('hidden');

            // Display summary
            featuresSummary.innerHTML = `
                <div style="display: flex; gap: 16px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${data.total_features}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Features</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--success);">${data.total_test_cases}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Test Cases</div>
                    </div>
                </div>
            `;

            // Also update the app panel test cases view (async - loads accurate counts from test_cases.json)
            updateAppPanelTestCases(data).catch(err => console.error('Failed to update test cases panel:', err));
            
            // Update discovered features cards in Application tab
            updateAppDiscoveredFeatures(data);

            // Display features
            let html = '';
            data.features.forEach((feature, idx) => {
                const testCasesByType = {};
                feature.test_cases.forEach(tc => {
                    if (!testCasesByType[tc.test_type]) {
                        testCasesByType[tc.test_type] = [];
                    }
                    testCasesByType[tc.test_type].push(tc);
                });

                const typeColors = {
                    'navigation': '#3b82f6',
                    'crud_create': '#10b981',
                    'crud_update': '#f59e0b',
                    'crud_delete': '#ef4444',
                    'data_validation': '#8b5cf6',
                    'form_submission': '#06b6d4'
                };

                html += `
                    <div style="margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                        <div style="background: var(--gradient-primary); padding: 16px; cursor: pointer;" onclick="toggleFeature(${idx})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="color: white; margin: 0; font-size: 16px; font-weight: 600;">
                                        ${feature.feature_name}
                                    </h3>
                                    <p style="color: rgba(255,255,255,0.8); margin: 4px 0 0 0; font-size: 13px;">
                                        ${feature.pages.length} pages ‚Ä¢ ${feature.test_cases.length} test cases
                                    </p>
                                </div>
                                <span id="feature_arrow_${idx}" style="color: white; font-size: 20px; transition: transform 0.3s;">‚ñº</span>
                            </div>
                        </div>
                        <div id="feature_content_${idx}" style="display: none; padding: 16px; background: var(--bg-secondary);">
                            ${Object.entries(testCasesByType).map(([type, testCases]) => `
                                <div style="margin-bottom: 16px;">
                                    <div style="display: inline-block; padding: 6px 12px; background: ${typeColors[type] || '#6b7280'}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; margin-bottom: 8px;">
                                        ${type.replace(/_/g, ' ').toUpperCase()} (${testCases.length})
                                    </div>
                                    ${testCases.map(tc => {
                                        const status = tc.status || 'pending';
                                        const statusColors = {
                                            'passed': { bg: '#d1fae5', color: '#065f46', icon: '‚úÖ' },
                                            'failed': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                                            'skipped': { bg: '#f3f4f6', color: '#6b7280', icon: '‚è≠Ô∏è' },
                                            'running': { bg: '#dbeafe', color: '#1e40af', icon: '‚è≥' },
                                            'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è∏Ô∏è' }
                                        };
                                        const statusStyle = statusColors[status] || statusColors['pending'];
                                        return `
                                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                        <span style="font-weight: 600; color: var(--text);">${tc.test_name}</span>
                                                        <span style="padding: 2px 8px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                                            ${statusStyle.icon} ${status.toUpperCase()}
                                                        </span>
                                                    </div>
                                                    <span style="margin-left: 0; padding: 2px 8px; background: ${tc.priority === 'high' ? '#fef3c7' : '#e0e7ff'}; color: ${tc.priority === 'high' ? '#92400e' : '#3730a3'}; border-radius: 4px; font-size: 11px; font-weight: 600;">${tc.priority.toUpperCase()}</span>
                                                </div>
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">
                                                <strong>Steps:</strong>
                                                <ol style="margin: 4px 0 0 0; padding-left: 20px;">
                                                    ${tc.steps.map(step => `<li>${step}</li>`).join('')}
                                                </ol>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            featuresList.innerHTML = html;
        }

        function toggleFeature(idx) {
            const content = document.getElementById(`feature_content_${idx}`);
            const arrow = document.getElementById(`feature_arrow_${idx}`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function processEvents(events) {
            events.forEach(event => {
                addEventToLog(event);
                if (event.type === 'page_discovered') {
                    addPageToList(event.data);
                } else if (event.type === 'page_visit_started') {
                    // Show live progress: "Visiting page X of Y"
                    updateDiscoveryProgress(event.data);
                } else if (event.type === 'page_testing_started') {
                    // Show: "Testing all interactions on page..."
                    updatePageTestingStatus(event.data, 'started');
                } else if (event.type === 'page_action_testing') {
                    // Show: "Testing search...", "Testing filters...", etc.
                    updatePageActionStatus(event.data);
                } else if (event.type === 'page_testing_completed') {
                    // Show: "Page testing completed"
                    updatePageTestingStatus(event.data, 'completed');
                } else if (event.type === 'discovery_started') {
                    updateDiscoveryStatus('started', event.data);
                } else if (event.type === 'discovery_progress') {
                    // Periodic progress update - shows discovery is still running
                    updateDiscoveryStatus('in_progress', event.data);
                    // Update elapsed time if available
                    if (event.data.elapsed_minutes) {
                        const badge = document.getElementById('discovery_status_badge');
                        if (badge) {
                            const timeText = `${event.data.elapsed_minutes}min / ${event.data.max_time_minutes}min`;
                            badge.setAttribute('title', `Elapsed: ${timeText}`);
                        }
                    }
                } else if (event.type === 'test_case_generated') {
                    handleTestCaseGenerated(event.data);
                } else if (event.type === 'test_cases_generated') {
                    handleTestCasesGenerated(event.data);
                    // Fetch and display all test cases
                    fetchTestCases();
                } else if (event.type === 'discovery_completed') {
                    updateDiscoveryStatus('completed', event.data);
                    updateDiscoveryStats(event.data);
                    // Fetch test cases immediately when discovery completes
                    // This will also update discovered features in Application tab via displayFeatures()
                    fetchAndDisplayFeatures();
                    fetchTestCases(); // Fetch generated test cases
                    checkReportAvailable();
                    // Refresh run history to show the completed run
                    loadRunHistory();
                    // Stop polling once discovery is complete
                    stopEventsPolling();
                    stopPolling();
                    // Show completion in a prominent way
                    showCompletionNotification('üéâ Discovery completed! View test cases and report.', 'success');
                    // Auto-switch to test cases tab after a delay
                    setTimeout(() => {
                        const testCasesTab = document.querySelector('.app-tab[onclick*="testcases"]');
                        if (testCasesTab) {
                            switchAppTab('testcases');
                            testCasesTab.classList.add('active');
                        }
                    }, 2000);
                } else if (event.type === 'discovery_failed') {
                    updateDiscoveryStatus('failed', event.data);
                    showMessage(`Discovery failed: ${event.data.error || 'Unknown error'}`, 'error');
                    showCompletionNotification('‚ùå Discovery failed. Check logs for details.', 'error');
                } else if (event.type === 'page_discovered' || event.type === 'page_visit_started' || event.type === 'page_testing_started') {
                    // Update status to "in progress" when any page activity happens
                    const statusBadge = document.getElementById('discovery_status_badge');
                    if (statusBadge && !statusBadge.textContent.includes('Completed') && !statusBadge.textContent.includes('Failed')) {
                        updateDiscoveryStatus('in_progress', null);
                    }
                } else if (event.type === 'health_check_started') {
                    showHealthCheckDashboard(event.data);
                } else if (event.type === 'page_validation_started') {
                    addPageToHealthTable(event.data);
                } else if (event.type === 'health_check_started_individual') {
                    updateHealthCheckStatus(event.data.url, event.data.type, 'running');
                    incrementHealthCounter('concurrent');
                } else if (event.type === 'health_check_completed_individual') {
                    updateHealthCheckStatus(event.data.url, event.data.type, event.data.status);
                    updateHealthCheckDuration(event.data.url, event.data.type, event.data.duration_ms);
                    decrementHealthCounter('concurrent');
                    if (event.data.status === 'passed') {
                        incrementHealthCounter('passed');
                    } else if (event.data.status === 'failed') {
                        incrementHealthCounter('failed');
                    }
                } else if (event.type === 'page_validation_completed') {
                    updatePageOverallStatus(event.data.url, event.data.status);
                    incrementHealthCounter('pages_validated');
                } else if (event.type === 'health_check_completed') {
                    showHealthCheckSummary(event.data);
                } else if (event.type === 'free_text_execution_started') {
                    showFreeTextExecutionStarted(event.data);
                } else if (event.type === 'free_text_test_started') {
                    showFreeTextTestStarted(event.data);
                } else if (event.type === 'free_text_test_completed') {
                    showFreeTextTestCompleted(event.data);
                } else if (event.type === 'free_text_execution_completed') {
                    showFreeTextExecutionCompleted(event.data);
                } else if (event.type === 'free_text_execution_error') {
                    showFreeTextExecutionError(event.data);
                }
            });
        }

        function updateDiscoveryProgress(data) {
            const progressText = `üìÑ Visiting page ${data.page_number} of ${data.total_pages_limit}${data.nav_path ? ` (${data.nav_path})` : ''}`;
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            entry.style.cssText = 'padding: 10px; margin-bottom: 4px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%); border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 13px; font-weight: 500;';
            entry.textContent = progressText;
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight;
        }

        function updatePageTestingStatus(data, status) {
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            const pageName = data.page_name || data.url.split('/').pop() || 'page';
            if (status === 'started') {
                entry.style.cssText = 'padding: 8px; margin-bottom: 4px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; border-radius: 4px; font-size: 12px;';
                entry.textContent = `üß™ Testing all interactions on: ${pageName}`;
            } else {
                entry.style.cssText = 'padding: 8px; margin-bottom: 4px; background: rgba(16, 185, 129, 0.15); border-left: 3px solid #10b981; border-radius: 4px; font-size: 12px; font-weight: 500;';
                entry.textContent = `‚úÖ Completed testing: ${pageName}`;
            }
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight;
        }

        function updatePageActionStatus(data) {
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            const actionName = data.action.charAt(0).toUpperCase() + data.action.slice(1).replace('_', ' ');
            const icon = data.status === 'testing' ? '‚è≥' : '‚úì';
            entry.style.cssText = `padding: 6px 8px; margin-bottom: 2px; background: ${data.status === 'testing' ? 'rgba(59, 130, 246, 0.05)' : 'rgba(16, 185, 129, 0.05)'}; border-radius: 4px; font-size: 11px; margin-left: 20px;`;
            entry.textContent = `${icon} ${actionName}...`;
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight;
        }

        function addEventToLog(event) {
            const feed = document.getElementById('discovery_feed');
            const entry = document.createElement('div');
            entry.style.cssText = 'padding: 8px; margin-bottom: 4px; background: white; border-radius: 4px; font-size: 12px;';
            const timestamp = new Date(event.timestamp).toLocaleTimeString();
            const type = event.type.replace(/_/g, ' ');
            let message = '';
            if (event.type === 'page_discovered') {
                message = `üìÑ ${event.data.page_name || event.data.title || event.data.url}`;
            } else if (event.type === 'dropdowns_discovered') {
                message = `üîΩ Found ${event.data.count} dropdown(s)`;
            } else if (event.type === 'navigation_discovered') {
                message = `üß≠ Found ${event.data.count} navigation item(s)`;
            } else if (event.type === 'page_visit_started') {
                message = `üìÑ Visiting page ${event.data.page_number}/${event.data.total_pages_limit}${event.data.nav_path ? ` (${event.data.nav_path})` : ''}`;
            } else if (event.type === 'page_testing_started') {
                message = `üß™ Testing interactions on: ${event.data.page_name || 'page'}`;
            } else if (event.type === 'page_action_testing') {
                const actionName = event.data.action.charAt(0).toUpperCase() + event.data.action.slice(1).replace('_', ' ');
                message = `${event.data.status === 'testing' ? '‚è≥' : '‚úì'} ${actionName}`;
            } else if (event.type === 'page_testing_completed') {
                message = `‚úÖ Completed testing: ${event.data.page_name || 'page'}`;
            } else if (event.type === 'discovery_started') {
                message = `üöÄ Discovery started`;
            } else if (event.type === 'discovery_progress') {
                message = `‚è≥ Discovery in progress: ${event.data.pages_discovered} pages, ${event.data.elapsed_minutes}min elapsed`;
            } else if (event.type === 'discovery_completed') {
                message = `‚úÖ Discovery completed: ${event.data.pages_count || 0} pages, ${event.data.forms_count || 0} forms, ${event.data.api_endpoints_count || 0} APIs`;
            } else if (event.type === 'discovery_failed') {
                message = `‚ùå Discovery failed: ${event.data.error || 'Unknown error'}`;
            } else if (event.type === 'health_check_started') {
                message = `‚úÖ Starting Phase 1 health checks on ${event.data.total_pages} pages`;
            } else if (event.type === 'page_validation_started') {
                message = `üîç Validating: ${event.data.title}`;
            } else if (event.type === 'health_check_completed_individual') {
                const icon = event.data.status === 'passed' ? '‚úì' : event.data.status === 'failed' ? '‚úó' : '-';
                message = `${icon} ${event.data.type}: ${event.data.status}`;
            } else if (event.type === 'health_check_completed') {
                message = `üéâ Health checks completed: ${event.data.passed} passed, ${event.data.failed} failed`;
            } else if (event.type === 'free_text_execution_started') {
                message = `ü§ñ QA Buddy executing: ${event.data.instruction}`;
            } else if (event.type === 'free_text_test_started') {
                message = `‚ñ∂Ô∏è Testing: ${event.data.test}`;
            } else if (event.type === 'free_text_test_completed') {
                const icon = event.data.status === 'passed' ? '‚úÖ' : '‚ùå';
                message = `${icon} ${event.data.test}: ${event.data.status}`;
            } else if (event.type === 'free_text_execution_completed') {
                message = `‚ú® QA Buddy completed: ${event.data.passed} passed, ${event.data.failed} failed`;
            } else if (event.type === 'free_text_execution_error') {
                message = `‚ùå QA Buddy error: ${event.data.error}`;
            }
            entry.innerHTML = `<span style="color: #999; margin-right: 8px;">${timestamp}</span>${message}`;
            
            // Add to both feeds (right panel and app panel)
            if (feed) {
                feed.appendChild(entry.cloneNode(true));
                feed.scrollTop = feed.scrollHeight;
            }
            
            // Also add to app panel progress feed
            const appFeed = document.getElementById('app_progress_feed');
            if (appFeed) {
                // Clear "waiting" or "starting" message if present
                if (appFeed.children.length === 1) {
                    const firstChild = appFeed.children[0];
                    if (firstChild.textContent.includes('Waiting') || firstChild.textContent.includes('starting')) {
                        appFeed.innerHTML = '';
                    }
                }
                const clonedEntry = entry.cloneNode(true);
                appFeed.appendChild(clonedEntry);
                appFeed.scrollTop = appFeed.scrollHeight;
            }
        }

        function addPageToList(pageData) {
            const page = {
                url: pageData.url,
                title: pageData.title || pageData.url,
                page_name: pageData.page_name || pageData.title || pageData.url,
                nav_path: pageData.nav_path || '',
                forms_count: pageData.forms_count || 0,
                actions_count: pageData.actions_count || 0
            };
            const exists = discoveredPages.find(p => p.url === page.url);
            if (exists) {
                const index = discoveredPages.findIndex(p => p.url === page.url);
                discoveredPages[index] = { ...discoveredPages[index], ...page };
            } else {
                discoveredPages.push(page);
            }
            renderPagesList();
        }

        function renderPagesList() {
            const list = document.getElementById('pages_list');
            list.innerHTML = '';
            discoveredPages.forEach((page, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 12px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;';
                item.onmouseover = () => item.style.borderColor = 'var(--primary)';
                item.onmouseout = () => item.style.borderColor = 'transparent';
                item.onclick = () => selectPage(index);
                if (selectedPageIndex === index) {
                    item.style.borderColor = 'var(--primary)';
                    item.style.background = 'rgba(99, 102, 241, 0.1)';
                }
                item.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px;">${page.page_name || page.title}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); word-break: break-all;">${page.url}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                        ${page.forms_count} forms, ${page.actions_count} actions
                    </div>
                `;
                list.appendChild(item);
            });
            if (discoveredPages.length > 0) {
                document.getElementById('pages_card').classList.remove('hidden');
            }
        }

        function selectPage(index) {
            selectedPageIndex = index;
            renderPagesList();
            const page = discoveredPages[index];
            showPageDetails(page);
        }

        function showPageDetails(page) {
            const details = document.getElementById('page_details_content');
            details.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <strong>Page Name:</strong> ${page.page_name || page.title || 'N/A'}<br>
                    <strong>URL:</strong> ${page.url}<br>
                    <strong>Forms:</strong> ${page.forms_count}<br>
                    <strong>Actions:</strong> ${page.actions_count}
                </div>
            `;
            document.getElementById('page_details_card').classList.remove('hidden');
        }

        function updateDiscoveryStats(data) {
            // Update right panel stats (if they exist)
            const discoveryPages = document.getElementById('discovery_pages_count');
            const discoveryForms = document.getElementById('discovery_forms_count');
            const discoveryActions = document.getElementById('discovery_actions_count');
            
            if (discoveryPages && data.pages_count !== undefined) {
                discoveryPages.textContent = data.pages_count || 0;
            }
            if (discoveryForms && data.forms_count !== undefined) {
                discoveryForms.textContent = data.forms_count || 0;
            }
            if (discoveryActions && data.actions_count !== undefined) {
                discoveryActions.textContent = data.actions_count || 0;
            }
            
            // Update app panel progress stats (Live Progress tab) - this is the main one
            const pagesCount = document.getElementById('app_progress_pages');
            const formsCount = document.getElementById('app_progress_forms');
            const actionsCount = document.getElementById('app_progress_actions');
            
            if (pagesCount && data.pages_count !== undefined) {
                pagesCount.textContent = data.pages_count;
            }
            if (formsCount && data.forms_count !== undefined) {
                formsCount.textContent = data.forms_count;
            }
            if (actionsCount) {
                if (data.actions_count !== undefined) {
                    actionsCount.textContent = data.actions_count;
                } else if (data.api_endpoints_count !== undefined) {
                    // Use API endpoints as actions if actions_count not available
                    actionsCount.textContent = data.api_endpoints_count;
                }
            }
            
            console.log('Discovery stats updated:', {
                pages: data.pages_count,
                forms: data.forms_count,
                actions: data.actions_count || data.api_endpoints_count
            });
        }

        function updateAppDiscoveredFeatures(data) {
            const featuresSection = document.getElementById('app_discovered_features');
            const featuresCards = document.getElementById('app_features_cards');
            const reportBtn = document.getElementById('app_view_report_btn');
            
            if (!featuresSection || !featuresCards || !data || !data.features) return;
            
            // Show the section if we have features
            if (data.features && data.features.length > 0) {
                featuresSection.style.display = 'block';
                
                // Show report button if available
                if (reportBtn) {
                    checkReportAvailable(); // This will show the button if report exists
                }
                
                // Generate feature cards
                let html = '';
                data.features.forEach((feature, idx) => {
                    const totalPages = feature.pages ? feature.pages.length : 0;
                    const totalTests = feature.test_cases ? feature.test_cases.length : 0;
                    const passedTests = feature.test_cases ? feature.test_cases.filter(tc => tc.status === 'passed').length : 0;
                    const failedTests = feature.test_cases ? feature.test_cases.filter(tc => tc.status === 'failed').length : 0;
                    
                    html += `
                        <div style="background: white; border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s;">
                            <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">${feature.feature_name === 'Dashboard' ? 'üìä' : 'üîß'}</span>
                                        ${feature.feature_name}
                                    </h4>
                                    <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary);">
                                        <span>üìÑ ${totalPages} pages</span>
                                        <span>‚úÖ ${totalTests} tests</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <div style="flex: 1; text-align: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #10b981;">${passedTests}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Passed</div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${failedTests}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Failed</div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${totalTests - passedTests - failedTests}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Pending</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                featuresCards.innerHTML = html;
            } else {
                featuresSection.style.display = 'none';
            }
        }

        async function updateAppPanelTestCases(data) {
            const testCasesList = document.getElementById('testcases_list');
            const testCasesSummary = document.getElementById('testcases_summary');
            
            if (!testCasesList || !data) return;
            
            // Use total_test_cases from API response (which includes count from test_cases.json)
            let totalTestCases = data.total_test_cases || 0;
            let passedCount = 0;
            let failedCount = 0;
            let pendingCount = 0;
            let scenarios = [];
            
            // Try to load actual test cases from test_cases.json for accurate display
            if (currentRunId) {
                try {
                    const testCasesResponse = await fetch(`${API_BASE}/runs/${currentRunId}/test-cases`);
                    if (testCasesResponse.ok) {
                        const testCasesData = await testCasesResponse.json();
                        // Use the actual total from test_cases.json
                        totalTestCases = testCasesData.total_test_cases || totalTestCases;
                        scenarios = testCasesData.scenarios || [];
                        
                        // Count statuses from all scenarios
                        if (scenarios.length > 0) {
                            scenarios.forEach(scenario => {
                                if (scenario.test_cases && Array.isArray(scenario.test_cases)) {
                                    scenario.test_cases.forEach(tc => {
                                        const status = tc.status || 'pending';
                                        if (status === 'passed') passedCount++;
                                        else if (status === 'failed') failedCount++;
                                        else pendingCount++;
                                    });
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.log('Could not load test_cases.json, using feature-based counts:', e);
                    // Fallback to counting from features
                    if (data.features) {
                        data.features.forEach(feature => {
                            if (feature.test_cases && Array.isArray(feature.test_cases)) {
                                feature.test_cases.forEach(tc => {
                                    const status = tc.status || 'pending';
                                    if (status === 'passed') passedCount++;
                                    else if (status === 'failed') failedCount++;
                                    else pendingCount++;
                                });
                            }
                        });
                    }
                }
            } else {
                // Fallback to counting from features if no run ID
                if (data.features) {
                    data.features.forEach(feature => {
                        if (feature.test_cases && Array.isArray(feature.test_cases)) {
                            feature.test_cases.forEach(tc => {
                                const status = tc.status || 'pending';
                                if (status === 'passed') passedCount++;
                                else if (status === 'failed') failedCount++;
                                else pendingCount++;
                            });
                        }
                    });
                }
            }
            
            // Ensure total matches sum of statuses if we have accurate counts
            if (passedCount + failedCount + pendingCount > 0 && totalTestCases === 0) {
                totalTestCases = passedCount + failedCount + pendingCount;
            }
            
            // Update summary
            testCasesSummary.innerHTML = `
                <div class="stat-card" style="flex: 1;">
                    <div class="stat-value">${totalTestCases}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card success" style="flex: 1;">
                    <div class="stat-value">${passedCount}</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card" style="flex: 1; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);">
                    <div class="stat-value" style="color: #dc2626;">${failedCount}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card" style="flex: 1; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);">
                    <div class="stat-value" style="color: #d97706;">${pendingCount}</div>
                    <div class="stat-label">Pending</div>
                </div>
            `;
            
            // Display test cases from scenarios (if available) or fallback to features
            let html = '';
            
            if (scenarios.length > 0) {
                // Display from test_cases.json scenarios
                scenarios.forEach((scenario, scenarioIdx) => {
                    const scenarioId = `scenario_${scenarioIdx}`;
                    const isExpanded = localStorage.getItem(`scenario_${scenarioIdx}_expanded`) !== 'false';
                    
                    html += `
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" 
                                 onclick="toggleScenario('${scenarioId}')">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 18px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                    <h3 style="margin: 0; color: white; font-size: 16px; font-weight: 600;">${scenario.scenario_name || `Scenario ${scenarioIdx + 1}`}</h3>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px;">
                                    <span>Total: ${scenario.test_cases ? scenario.test_cases.length : 0}</span>
                                    ${scenario.passed > 0 ? `<span style="color: #d1fae5;">‚úì ${scenario.passed}</span>` : ''}
                                    ${scenario.failed > 0 ? `<span style="color: #fee2e2;">‚úó ${scenario.failed}</span>` : ''}
                                    ${scenario.pending > 0 ? `<span style="color: #fef3c7;">‚è≥ ${scenario.pending}</span>` : ''}
                                </div>
                            </div>
                            <div id="${scenarioId}_content" style="display: ${isExpanded ? 'block' : 'none'}; padding: 16px;">
                                ${(scenario.test_cases || []).map((tc, tcIdx) => {
                                    const status = tc.status || 'pending';
                                    const statusColors = {
                                        'passed': { bg: '#d1fae5', color: '#065f46', icon: '‚úÖ' },
                                        'failed': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                                        'skipped': { bg: '#f3f4f6', color: '#6b7280', icon: '‚è≠Ô∏è' },
                                        'running': { bg: '#dbeafe', color: '#1e40af', icon: '‚è≥' },
                                        'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è∏Ô∏è' }
                                    };
                                    const statusStyle = statusColors[status] || statusColors['pending'];
                                    const priorityColor = tc.priority === 'high' ? '#fef3c7' : '#e0e7ff';
                                    const priorityTextColor = tc.priority === 'high' ? '#92400e' : '#3730a3';
                                    
                                    const testCaseId = tc.id || `${scenarioId}_${tcIdx}`;
                                    const isSelected = selectedTestCases.has(testCaseId);
                                    
                                    return `
                                        <div style="background: ${isSelected ? 'rgba(99, 102, 241, 0.05)' : 'transparent'}; border: ${isSelected ? '2px solid var(--primary)' : '1px solid var(--border)'}; border-radius: 8px; padding: 16px; margin-bottom: 12px; transition: all 0.2s;">
                                            <div style="display: flex; gap: 12px; align-items: start;">
                                                <input type="checkbox" 
                                                    class="test-case-checkbox"
                                                    id="tc_${testCaseId}" 
                                                    data-test-id="${testCaseId}"
                                                    onchange="toggleTestCase('${testCaseId}')"
                                                    ${isSelected ? 'checked' : ''}
                                                    style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer; flex-shrink: 0;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                        <div style="flex: 1;">
                                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                                                                <span style="font-weight: 600; color: var(--text-primary); font-size: 15px;">${tc.name || tc.test_name || 'Unnamed Test'}</span>
                                                                <span style="padding: 4px 10px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                                                    ${statusStyle.icon} ${status.toUpperCase()}
                                                                </span>
                                                                <span style="padding: 4px 10px; background: ${priorityColor}; color: ${priorityTextColor}; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                                    ${(tc.priority || 'medium').toUpperCase()}
                                                                </span>
                                                            </div>
                                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                                                <strong>Type:</strong> ${(tc.type || tc.test_type || 'unknown').replace(/_/g, ' ')} | <strong>ID:</strong> ${tc.id || testCaseId}
                                                            </div>
                                                            ${tc.description ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${tc.description}</div>` : ''}
                                                        </div>
                                                    </div>
                                                    ${tc.steps && tc.steps.length > 0 ? `
                                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                                            <strong style="color: var(--text-primary);">Steps:</strong>
                                                            <ol style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.6;">
                                                                ${tc.steps.map(step => `<li style="margin-bottom: 4px;">${step}</li>`).join('')}
                                                            </ol>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
            } else if (data.features) {
                // Fallback to features display
                data.features.forEach((feature, featureIdx) => {
                    if (feature.test_cases && Array.isArray(feature.test_cases)) {
                        feature.test_cases.forEach((tc, tcIdx) => {
                            const status = tc.status || 'pending';
                            const statusColors = {
                                'passed': { bg: '#d1fae5', color: '#065f46', icon: '‚úÖ' },
                                'failed': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                                'skipped': { bg: '#f3f4f6', color: '#6b7280', icon: '‚è≠Ô∏è' },
                                'running': { bg: '#dbeafe', color: '#1e40af', icon: '‚è≥' },
                                'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è∏Ô∏è' }
                            };
                            const statusStyle = statusColors[status] || statusColors['pending'];
                            const priorityColor = tc.priority === 'high' ? '#fef3c7' : '#e0e7ff';
                            const priorityTextColor = tc.priority === 'high' ? '#92400e' : '#3730a3';
                            
                            const testCaseId = `${feature.feature_name}_${tc.test_id || tcIdx}`;
                            const isSelected = selectedTestCases.has(testCaseId);
                            
                            html += `
                                <div style="background: white; border: ${isSelected ? '2px solid var(--primary)' : '1px solid var(--border)'}; border-radius: 8px; padding: 16px; margin-bottom: 12px; transition: all 0.2s;">
                                    <div style="display: flex; gap: 12px; align-items: start;">
                                        <input type="checkbox" 
                                            class="test-case-checkbox"
                                            id="tc_${testCaseId}" 
                                            data-test-id="${testCaseId}"
                                            onchange="toggleTestCase('${testCaseId}')"
                                            ${isSelected ? 'checked' : ''}
                                            style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer; flex-shrink: 0;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 15px;">${tc.test_name}</span>
                                                        <span style="padding: 4px 10px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                                            ${statusStyle.icon} ${status.toUpperCase()}
                                                        </span>
                                                        <span style="padding: 4px 10px; background: ${priorityColor}; color: ${priorityTextColor}; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                            ${tc.priority.toUpperCase()}
                                                        </span>
                                                    </div>
                                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                                                        <strong>Feature:</strong> ${feature.feature_name} | <strong>Type:</strong> ${tc.test_type.replace(/_/g, ' ')} | <strong>ID:</strong> ${tc.test_id || 'N/A'}
                                                    </div>
                                                </div>
                                            </div>
                                            ${tc.steps && tc.steps.length > 0 ? `
                                                <div style="font-size: 13px; color: var(--text-secondary);">
                                                    <strong style="color: var(--text-primary);">Steps:</strong>
                                                    <ol style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.6;">
                                                        ${tc.steps.map(step => `<li style="margin-bottom: 4px;">${step}</li>`).join('')}
                                                    </ol>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
            }
            
            testCasesList.innerHTML = html || '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><p>No test cases available yet.</p></div>';
            
            // Show action buttons if test cases exist
            if (totalTestCases > 0) {
                document.getElementById('select_all_btn').style.display = 'inline-flex';
                document.getElementById('deselect_all_btn').style.display = 'inline-flex';
                document.getElementById('execute_tests_btn').style.display = 'inline-flex';
                updateExecuteButtonState();
            }
        }
        
        function toggleScenario(scenarioId) {
            const content = document.getElementById(`${scenarioId}_content`);
            const header = content.previousElementSibling;
            const arrow = header.querySelector('span');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '‚ñº';
                localStorage.setItem(`${scenarioId}_expanded`, 'true');
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñ∂';
                localStorage.setItem(`${scenarioId}_expanded`, 'false');
            }
        }

        function toggleTestCase(testCaseId) {
            const checkbox = document.getElementById(`tc_${testCaseId}`);
            if (!checkbox) return;
            
            if (checkbox.checked) {
                selectedTestCases.add(testCaseId);
            } else {
                selectedTestCases.delete(testCaseId);
            }
            updateExecuteButtonState();
            // Update visual selection
            const card = checkbox.closest('div[style*="background"]');
            if (card) {
                if (checkbox.checked) {
                    card.style.borderColor = 'var(--primary)';
                    card.style.borderWidth = '2px';
                    card.style.background = 'rgba(99, 102, 241, 0.05)';
                } else {
                    card.style.borderColor = 'var(--border)';
                    card.style.borderWidth = '1px';
                    // Reset background - check if it's a scenario card or regular card
                    if (card.style.background.includes('rgba(99, 102, 241')) {
                        card.style.background = card.id && card.id.includes('scenario') ? 'white' : 'transparent';
                    }
                }
            }
        }

        function selectAllTestCases() {
            document.querySelectorAll('.test-case-checkbox').forEach(cb => {
                cb.checked = true;
                const testCaseId = cb.getAttribute('data-test-id');
                if (testCaseId) {
                    selectedTestCases.add(testCaseId);
                }
            });
            // Update visual selection
            document.querySelectorAll('.test-case-checkbox').forEach(cb => {
                const testCaseId = cb.getAttribute('data-test-id');
                if (testCaseId) {
                    const card = cb.closest('div[style*="background"]');
                    if (card) {
                        card.style.borderColor = 'var(--primary)';
                        card.style.borderWidth = '2px';
                        card.style.background = 'rgba(99, 102, 241, 0.05)';
                    }
                }
            });
            updateExecuteButtonState();
        }

        function deselectAllTestCases() {
            document.querySelectorAll('.test-case-checkbox').forEach(cb => {
                cb.checked = false;
                const testCaseId = cb.getAttribute('data-test-id');
                if (testCaseId) {
                    const card = cb.closest('div[style*="background"]');
                    if (card) {
                        card.style.borderColor = 'var(--border)';
                        card.style.borderWidth = '1px';
                        card.style.background = card.style.background.includes('rgba(99, 102, 241') ? 'white' : card.style.background;
                    }
                }
            });
            selectedTestCases.clear();
            updateExecuteButtonState();
        }

        function updateExecuteButtonState() {
            const btn = document.getElementById('execute_tests_btn');
            if (btn) {
                const count = selectedTestCases.size;
                if (count > 0) {
                    btn.textContent = `‚ñ∂Ô∏è Run ${count} Selected Test${count > 1 ? 's' : ''}`;
                    btn.disabled = false;
                } else {
                    btn.textContent = '‚ñ∂Ô∏è Run Selected Tests';
                    btn.disabled = true;
                }
            }
        }

        async function executeSelectedTests() {
            console.log('executeSelectedTests called', { selectedCount: selectedTestCases.size, currentRunId });
            
            // Check if test cases are selected
            if (selectedTestCases.size === 0) {
                showMessage('Please select at least one test case to run', 'error');
                return;
            }
            
            // Check if run ID exists
            if (!currentRunId) {
                showMessage('No discovery run found. Please start a discovery run first.', 'error');
                return;
            }
            
            // Open popup instead of executing directly
            await openTestExecutionModal();
        }

        function viewReport() {
            if (!currentRunId) {
                showMessage('No run ID available', 'error');
                return;
            }
            window.open(`${API_BASE}/runs/${currentRunId}/report`, '_blank');
        }


        function updateDiscoveryStatus(status, data) {
            const badge = document.getElementById('discovery_status_badge');
            if (!badge) return;

            const statusConfig = {
                'not_started': {
                    text: 'Not Started',
                    color: '#6b7280',
                    bg: 'var(--bg-tertiary)',
                    icon: '‚ö™'
                },
                'started': {
                    text: 'Started',
                    color: '#3b82f6',
                    bg: '#dbeafe',
                    icon: 'üöÄ'
                },
                'in_progress': {
                    text: 'In Progress',
                    color: '#f59e0b',
                    bg: '#fef3c7',
                    icon: '‚è≥'
                },
                'completed': {
                    text: 'Completed',
                    color: '#10b981',
                    bg: '#d1fae5',
                    icon: '‚úÖ'
                },
                'failed': {
                    text: 'Failed',
                    color: '#ef4444',
                    bg: '#fee2e2',
                    icon: '‚ùå'
                }
            };

            const config = statusConfig[status] || statusConfig['not_started'];
            badge.innerHTML = `
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${config.color}; ${status === 'in_progress' ? 'animation: pulse 2s infinite;' : ''}"></span>
                <span>${config.icon} ${config.text}</span>
            `;
            badge.style.background = config.bg;
            badge.style.color = config.color;

            // Also update in the right panel if it exists
            const rightPanelBadge = document.querySelector('#discovery_status_badge_right');
            if (rightPanelBadge) {
                rightPanelBadge.innerHTML = badge.innerHTML;
                rightPanelBadge.style.background = config.bg;
                rightPanelBadge.style.color = config.color;
            }
        }

        // Health Check Dashboard Functions
        let healthCheckTotalPages = 0;

        function showHealthCheckDashboard(data) {
            const dashboard = document.getElementById('health_check_dashboard');
            dashboard.classList.remove('hidden');
            healthCheckTotalPages = data.total_pages || 0;

            // Initialize counters
            document.getElementById('health_pages_validated').textContent = `0 / ${healthCheckTotalPages}`;
            document.getElementById('health_checks_passed').textContent = '0';
            document.getElementById('health_checks_failed').textContent = '0';
            document.getElementById('health_concurrent_tests').textContent = '0';
        }

        function addPageToHealthTable(data) {
            const tbody = document.getElementById('health_check_table_body');
            const row = document.createElement('tr');
            const urlKey = encodeURIComponent(data.url);
            row.id = `health_page_${urlKey}`;
            row.dataset.url = data.url;

            row.innerHTML = `
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${data.url}">
                    <div style="font-weight: 500;">${data.title || 'Untitled'}</div>
                    <div style="font-size: 11px; color: #666;">${data.url}</div>
                </td>
                <td><span class="health-check-status pending" data-check="table_listing">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="pagination">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="search">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="filters">‚è≥</span></td>
                <td><span class="health-check-status pending" data-check="sort">‚è≥</span></td>
                <td><span class="health-check-status pending">Pending</span></td>
                <td>-</td>
            `;

            tbody.appendChild(row);
        }

        function updateHealthCheckStatus(url, checkType, status) {
            const rows = document.querySelectorAll('#health_check_table_body tr');
            let targetRow = null;

            for (const row of rows) {
                if (row.dataset.url === url) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) return;

            const checkCell = targetRow.querySelector(`[data-check="${checkType}"]`);
            if (checkCell) {
                checkCell.className = 'health-check-status ' + status;
                checkCell.textContent = getHealthStatusIcon(status);
            }
        }

        function updateHealthCheckDuration(url, checkType, durationMs) {
            const rows = document.querySelectorAll('#health_check_table_body tr');
            let targetRow = null;

            for (const row of rows) {
                if (row.dataset.url === url) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) return;

            const durationCell = targetRow.cells[7];
            const currentDuration = durationCell.textContent;
            if (currentDuration === '-') {
                durationCell.textContent = `${durationMs}ms`;
            } else {
                const total = parseInt(currentDuration) + durationMs;
                durationCell.textContent = `${total}ms`;
            }
        }

        function updatePageOverallStatus(url, status) {
            const rows = document.querySelectorAll('#health_check_table_body tr');
            let targetRow = null;

            for (const row of rows) {
                if (row.dataset.url === url) {
                    targetRow = row;
                    break;
                }
            }

            if (!targetRow) return;

            const statusCell = targetRow.cells[6];
            statusCell.innerHTML = `<span class="health-check-status ${status}">${status.toUpperCase()}</span>`;
        }

        function incrementHealthCounter(type) {
            if (type === 'pages_validated') {
                const elem = document.getElementById('health_pages_validated');
                const parts = elem.textContent.split(' / ');
                const current = parseInt(parts[0]) + 1;
                elem.textContent = `${current} / ${healthCheckTotalPages}`;
            } else if (type === 'passed') {
                const elem = document.getElementById('health_checks_passed');
                elem.textContent = parseInt(elem.textContent) + 1;
            } else if (type === 'failed') {
                const elem = document.getElementById('health_checks_failed');
                elem.textContent = parseInt(elem.textContent) + 1;
            } else if (type === 'concurrent') {
                const elem = document.getElementById('health_concurrent_tests');
                elem.textContent = parseInt(elem.textContent) + 1;
            }
        }

        function decrementHealthCounter(type) {
            if (type === 'concurrent') {
                const elem = document.getElementById('health_concurrent_tests');
                const current = parseInt(elem.textContent);
                elem.textContent = Math.max(0, current - 1);
            }
        }

        function getHealthStatusIcon(status) {
            switch(status) {
                case 'pending': return '‚è≥';
                case 'running': return '‚è≥';
                case 'passed': return '‚úì';
                case 'failed': return '‚úó';
                case 'skipped': return '-';
                default: return '?';
            }
        }

        function showHealthCheckSummary(data) {
            // Final summary could show a notification or update the UI
            console.log('Health Check Summary:', data);
        }

        // Test Execution Results (Azure DevOps Style)
        let testExecutionState = {
            startTime: null,
            tests: new Map(), // test_id -> {name, status, start, end, duration, error}
            totalTests: 0,
            passed: 0,
            failed: 0,
            running: 0,
            skipped: 0
        };

        function showFreeTextExecutionStarted(data) {
            console.log('Test execution started:', data.instruction);

            // Reset state
            testExecutionState = {
                startTime: Date.now(),
                tests: new Map(),
                totalTests: 0,
                passed: 0,
                failed: 0,
                running: 0,
                skipped: 0
            };

            // Note: Test Results view removed - free text execution will show results in notifications

            // Note: Test Results view removed - free text execution results will be shown in notifications

            // Start elapsed timer
            const timerInterval = setInterval(() => {
                if (testExecutionState.startTime) {
                    // Note: Test Results view removed - duration tracking kept in state only
                } else {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function showFreeTextTestStarted(data) {
            console.log('Test started:', data.test);

            const testId = data.test_id || data.test || `test_${testExecutionState.tests.size}`;
            const testName = data.test_name || data.test || 'Unnamed Test';

            // Add to state
            testExecutionState.tests.set(testId, {
                name: testName,
                status: 'running',
                start: Date.now(),
                end: null,
                duration: null,
                error: null
            });
            testExecutionState.totalTests++;
            testExecutionState.running++;

            // Update counters
            updateTestResultsCounters();

            // Note: Test Results view removed - test status tracked in state only

            // Update progress bar
            updateProgressBar();
        }

        function showFreeTextTestCompleted(data) {
            console.log('Test completed:', data.test, data.status);

            const testId = data.test_id || data.test || `test_${testExecutionState.tests.size}`;
            const test = testExecutionState.tests.get(testId);

            if (test) {
                test.status = data.status || 'passed';
                test.end = Date.now();
                test.duration = test.end - test.start;
                test.error = data.error || null;

                // Update counters
                testExecutionState.running--;
                if (test.status === 'passed') {
                    testExecutionState.passed++;
                } else if (test.status === 'failed') {
                    testExecutionState.failed++;
                } else {
                    testExecutionState.skipped++;
                }

                updateTestResultsCounters();
                // Note: Test Results view removed - test completion tracked in state only

                // Update progress bar
                updateProgressBar();
            }
        }

        function showFreeTextExecutionCompleted(data) {
            console.log('Test execution completed:', data);

            testExecutionState.startTime = null; // Stop timer

            // Show completion notification
            const passRate = testExecutionState.totalTests > 0
                ? Math.round((testExecutionState.passed / testExecutionState.totalTests) * 100)
                : 0;

            showCompletionNotification(
                `‚úì Test execution completed! Pass rate: ${passRate}% (${testExecutionState.passed}/${testExecutionState.totalTests})`,
                passRate >= 80 ? 'success' : 'error'
            );
        }

        function showFreeTextExecutionError(data) {
            console.error('Test execution error:', data.error);

            testExecutionState.startTime = null; // Stop timer

            // Show error notification
            showMessage(`Test execution failed: ${data.error}`, 'error');
        }

        // Note: Test Results view removed - these functions are kept for free text execution but won't update UI
        function updateTestResultsCounters() {
            // View removed - function kept for compatibility
        }

        function updateProgressBar() {
            // View removed - function kept for compatibility
        }

        // Test Case Event Handlers
        let testCaseCount = 0;

        function handleTestCaseGenerated(data) {
            testCaseCount++;
            console.log(`Test case generated (#${testCaseCount}):`, data.test_case_name);

            // Update test case counter in UI if visible
            const counter = document.getElementById('test_cases_counter');
            if (counter) {
                counter.textContent = testCaseCount;
            }
        }

        function handleTestCasesGenerated(data) {
            console.log(`All test cases generated: ${data.total_test_cases} test cases in ${data.scenarios_count} scenarios`);
            testCaseCount = data.total_test_cases;

            // Show notification
            showMessage(`‚ú® Generated ${data.total_test_cases} test cases in ${data.scenarios_count} scenarios`, 'success');
        }

        async function fetchTestCases() {
            if (!currentRunId) return;

            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/test-cases`);
                if (!response.ok) {
                    console.warn('Test cases not available yet');
                    return;
                }

                const testCasesData = await response.json();
                // Store globally so modal can access it
                window.testCasesData = testCasesData;
                displayTestCases(testCasesData);
            } catch (error) {
                console.warn('Failed to fetch test cases:', error.message);
            }
        }

        async function loadRunHistory() {
            const container = document.getElementById('run_history_list');
            if (!container) return;

            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><p>Loading run history...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/runs/list`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayRunHistory(data.runs || []);
            } catch (error) {
                console.error('Failed to load run history:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <p>‚ùå Failed to load run history</p>
                        <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function displayRunHistory(runs) {
            const container = document.getElementById('run_history_list');
            if (!container) return;

            if (runs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                        <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">No runs found</p>
                        <p style="font-size: 14px;">Start a discovery run to see it here</p>
                    </div>
                `;
                return;
            }

            let html = '';
            runs.forEach(run => {
                const date = run.started_at ? new Date(run.started_at).toLocaleString() : 'Unknown';
                const isCurrent = run.run_id === currentRunId;

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid ${isCurrent ? 'var(--primary)' : 'var(--border)'}; position: relative;">
                        ${isCurrent ? '<div style="position: absolute; top: 12px; right: 12px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">CURRENT</div>' : ''}

                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; font-family: monospace;">
                                    ${run.run_id}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    ${date}
                                </div>
                            </div>
                        </div>

                        ${run.base_url ? `
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; word-break: break-all;">
                                üåê ${run.base_url}
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                üìÑ <strong>${run.pages_count}</strong> pages
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                üìù <strong>${run.forms_count}</strong> forms
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                ‚úÖ <strong>${run.test_cases_count}</strong> test cases
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="loadRun('${run.run_id}')" class="btn-secondary btn-sm" style="flex: 1; min-width: 120px;">
                                üìÇ Load Run
                            </button>
                            ${run.has_test_cases ? `
                                <button onclick="loadRunTestCases('${run.run_id}')" class="btn-secondary btn-sm" style="flex: 1; min-width: 120px;">
                                    ‚úÖ View Tests
                                </button>
                            ` : ''}
                            ${run.has_discovery ? `
                                <button onclick="window.open('${API_BASE}/runs/${run.run_id}/report', '_blank')" class="btn-secondary btn-sm" style="flex: 1; min-width: 120px;">
                                    üìä Report
                                </button>
                            ` : ''}
                            <button onclick="deleteRun('${run.run_id}')" class="btn-secondary btn-sm" style="min-width: 100px; color: var(--danger); border-color: var(--danger);" title="${isCurrent ? 'Delete current run (will clear UI)' : 'Delete this run permanently'}">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function loadTestExecutionHistory() {
            const container = document.getElementById('execution_history_list');
            if (!container) return;

            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><p>Loading test execution history...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/runs/executions/list`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayTestExecutionHistory(data.executions || []);
                
                // Poll for status updates on running executions
                const runningExecutions = (data.executions || []).filter(e => e.status === 'running' || !e.completed_at);
                if (runningExecutions.length > 0) {
                    // Poll status every 2 seconds for running executions
                    setTimeout(() => {
                        runningExecutions.forEach(exec => {
                            pollExecutionStatus(exec.execution_id);
                        });
                    }, 2000);
                }
            } catch (error) {
                console.error('Failed to load test execution history:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <p>‚ùå Failed to load test execution history</p>
                        <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function pollExecutionStatus(executionId) {
            try {
                const response = await fetch(`${API_BASE}/runs/executions/${executionId}/status`);
                if (!response.ok) return;
                
                const status = await response.json();
                
                // Update the UI if execution is still running
                if (status.status === 'running' || !status.completed_at) {
                    // Reload history to show updated status
                    setTimeout(() => loadTestExecutionHistory(), 2000);
                }
            } catch (error) {
                console.error(`Failed to poll status for ${executionId}:`, error);
            }
        }
        
        async function deleteExecution(executionId) {
            if (!confirm(`Are you sure you want to delete execution ${executionId}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/runs/executions/${executionId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete execution');
                }
                
                showMessage('Execution deleted successfully', 'success');
                loadTestExecutionHistory();
            } catch (error) {
                console.error('Failed to delete execution:', error);
                showMessage(`Failed to delete execution: ${error.message}`, 'error');
            }
        }

        function displayTestExecutionHistory(executions) {
            const container = document.getElementById('execution_history_list');
            if (!container) return;

            if (executions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üß™</div>
                        <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">No test executions found</p>
                        <p style="font-size: 14px;">Execute test cases to see execution history here</p>
                    </div>
                `;
                return;
            }

            let html = '';
            executions.forEach(exec => {
                const startDate = exec.started_at ? new Date(exec.started_at).toLocaleString() : 'Unknown';
                const endDate = exec.completed_at ? new Date(exec.completed_at).toLocaleString() : 'Running...';
                const duration = exec.duration_seconds ? `${Math.round(exec.duration_seconds)}s` : '-';
                const passRate = exec.total_tests > 0 ? Math.round((exec.passed / exec.total_tests) * 100) : 0;
                const statusColor = exec.status === 'completed' ? (exec.failed === 0 ? '#10b981' : '#ef4444') : '#f59e0b';

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                    ${exec.execution_name}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ID: <span style="font-family: monospace;">${exec.execution_id}</span>
                                </div>
                                ${exec.description ? `
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                        ${exec.description}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="padding: 6px 12px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${exec.status.toUpperCase()}
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 12px;">
                            <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${exec.total_tests}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Total</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: #10b981;">${exec.passed}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Passed</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${exec.failed}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Failed</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${exec.skipped}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Skipped</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${passRate}%</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Pass Rate</div>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border);">
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                <div>üïê Started: ${startDate}</div>
                                <div>‚è±Ô∏è Duration: ${duration}</div>
                                ${exec.discovery_run_id ? `<div>üîó Discovery: <span style="font-family: monospace; color: var(--primary); cursor: pointer;" onclick="loadRun('${exec.discovery_run_id}')">${exec.discovery_run_id}</span></div>` : ''}
                                ${exec.environment ? `<div>üåç Environment: ${exec.environment}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="viewExecutionReport('${exec.execution_id}')" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                    üìä Allure Report
                                </button>
                                <button onclick="deleteExecution('${exec.execution_id}')" style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;" title="Delete this execution">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function viewExecutionReport(executionId) {
            try {
                // First, get execution details to check for Allure report
                const response = await fetch(`${API_BASE}/runs/executions/${executionId}`);
                if (!response.ok) throw new Error('Failed to load execution details');
                
                const data = await response.json();
                const allureUrl = data.execution?.allure_report_url;
                
                if (allureUrl) {
                    // Open Allure report in new window
                    window.open(`${API_BASE}${allureUrl}`, '_blank');
                    showMessage('Opening Allure report in new window...', 'success');
                } else {
                    // Fallback: show execution details
                    showMessage('Allure report not available yet. Execution may still be running.', 'info');
                    // Switch to execution history tab
                    switchAppTab('execution-history');
                    loadTestExecutionHistory();
                }
            } catch (error) {
                console.error('Failed to view execution report:', error);
                showMessage(`Failed to load execution report: ${error.message}`, 'error');
            }
        }

        function loadRun(runId) {
            console.log(`üîÑ Loading run: ${runId}`);

            // Clear old data first
            resetTestCasesView();
            resetLiveProgressView();
            selectedTestCases.clear();

            // Update run ID
            currentRunId = runId;
            localStorage.setItem('currentRunId', runId);
            updateCurrentRunIndicator();

            // Reset event cursor for new run
            eventsCursor = 0;
            localStorage.setItem('eventsCursor_' + runId, '0');

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('run_id', runId);
            window.history.pushState({}, '', url);

            // Switch to Test Cases tab
            switchAppTab('testcases');

            // Trigger initialization to load run data
            initializePage();

            showMessage(`Loaded run: ${runId}`, 'success');
        }

        function loadRunTestCases(runId) {
            loadRun(runId);
            // Wait a bit for data to load then switch to test cases
            setTimeout(() => {
                switchAppTab('testcases');
            }, 500);
        }

        async function deleteRun(runId) {
            // Warn if deleting current run
            const isCurrent = runId === currentRunId;
            const warningMessage = isCurrent 
                ? `‚ö†Ô∏è WARNING: You are about to delete the CURRENT active run (${runId}).\n\nThis will:\n- Delete all discovery data, test cases, reports, and screenshots\n- Clear the current run from the UI\n- Remove all database records\n\nThis action cannot be undone.\n\nAre you sure you want to continue?`
                : `Are you sure you want to permanently delete run ${runId}?\n\nThis will delete:\n- All discovery data, test cases, reports, and screenshots\n- All database records\n- All files in the run directory\n\nThis action cannot be undone.`;

            if (!confirm(warningMessage)) {
                return;
            }

            try {
                showMessage('Deleting run...', 'info');

                const response = await fetch(`${API_BASE}/runs/${runId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const data = await response.json();

                showMessage(
                    `‚úÖ Run deleted successfully: ${data.run_info.files_deleted} files (${data.run_info.size_deleted_mb} MB)`,
                    'success'
                );

                // If deleting current run, clear it
                if (isCurrent) {
                    currentRunId = null;
                    localStorage.removeItem('currentRunId');
                    updateCurrentRunIndicator();
                    resetTestCasesView();
                    resetLiveProgressView();
                }

                // Refresh run history to show updated list
                loadRunHistory();

            } catch (error) {
                console.error('Failed to delete run:', error);
                showMessage(`‚ùå Failed to delete run: ${error.message}`, 'error');
            }
        }

        function updateCurrentRunIndicator() {
            const indicator = document.getElementById('current_run_indicator');
            const display = document.getElementById('current_run_id_display');

            if (currentRunId) {
                indicator.style.display = 'flex';
                display.textContent = currentRunId;
            } else {
                indicator.style.display = 'none';
            }
        }

        function copyRunId() {
            if (!currentRunId) {
                showMessage('No active run', 'error');
                return;
            }

            navigator.clipboard.writeText(currentRunId).then(() => {
                showMessage('Run ID copied to clipboard!', 'success');
            }).catch(err => {
                showMessage('Failed to copy: ' + err.message, 'error');
            });
        }

        function resetTestCasesView() {
            const testCasesContainer = document.getElementById('testcases_list');
            if (!testCasesContainer) return;

            testCasesContainer.innerHTML = `
                <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary); background: white; border-radius: 12px; border: 2px dashed var(--border);">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                    <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">No test cases available yet</p>
                    <p style="font-size: 14px;">Test cases will appear here as discovery progresses</p>
                </div>
            `;

            // Reset summary
            const summaryContainer = document.getElementById('testcases_summary');
            if (summaryContainer) {
                summaryContainer.innerHTML = '';
            }

            // Hide action buttons
            const selectAllBtn = document.getElementById('select_all_btn');
            const deselectAllBtn = document.getElementById('deselect_all_btn');
            const executeBtn = document.getElementById('execute_tests_btn');
            const viewReportBtn = document.getElementById('view_report_btn');

            if (selectAllBtn) selectAllBtn.style.display = 'none';
            if (deselectAllBtn) deselectAllBtn.style.display = 'none';
            if (executeBtn) executeBtn.style.display = 'none';
            if (viewReportBtn) viewReportBtn.style.display = 'none';

            console.log('‚úÖ Test Cases view reset for new run');
        }

        function resetLiveProgressView() {
            const feedContainer = document.getElementById('app_progress_feed');
            if (!feedContainer) return;

            feedContainer.innerHTML = `
                <div style="text-align: center; padding: 60px 40px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                    <p style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">Waiting for discovery to start...</p>
                    <p style="font-size: 14px; margin-bottom: 12px;">Progress will appear here in real-time</p>
                    <p style="font-size: 12px; color: var(--primary); font-weight: 500;">
                        ‚ö° Auto-updates every second - no refresh needed!
                    </p>
                </div>
            `;

            console.log('‚úÖ Live Progress view reset for new run');
        }

        function displayTestCases(testCasesData) {
            const scenarios = testCasesData.scenarios || [];
            const totalTests = testCasesData.total_test_cases || 0;

            console.log(`Displaying ${totalTests} test cases in ${scenarios.length} scenarios`);

            // Update test cases list
            const testCasesContainer = document.getElementById('testcases_list');
            if (!testCasesContainer) {
                console.error('testcases_list container not found');
                return;
            }

            let html = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <h2 style="margin: 0 0 10px 0;">üìã Generated Test Cases</h2>
                        <p style="color: var(--text-secondary);">
                            ${totalTests} test cases organized into ${scenarios.length} scenarios
                        </p>
                    </div>
            `;

            scenarios.forEach((scenario, idx) => {
                const totalScenarioTests = scenario.total || 0;
                const passedTests = scenario.passed || 0;
                const failedTests = scenario.failed || 0;
                const pendingTests = scenario.pending || 0;

                html += `
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: white;">${scenario.scenario_name}</h3>
                                <div style="display: flex; gap: 15px; font-size: 14px;">
                                    <span>Total: ${totalScenarioTests}</span>
                                    ${passedTests > 0 ? `<span style="color: #d1fae5;">‚úì ${passedTests}</span>` : ''}
                                    ${failedTests > 0 ? `<span style="color: #fee2e2;">‚úó ${failedTests}</span>` : ''}
                                    ${pendingTests > 0 ? `<span style="color: #fef3c7;">‚è≥ ${pendingTests}</span>` : ''}
                                </div>
                            </div>
                        </div>

                        <div style="padding: 20px;">
                            <table class="health-check-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" onchange="toggleScenarioTests(this, ${idx})" />
                                        </th>
                                        <th>Test Case ID</th>
                                        <th>Test Name</th>
                                        <th>Type</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="scenario_${idx}_tests">
                `;

                scenario.test_cases.forEach((tc, tcIdx) => {
                    const statusClass = tc.status || 'pending';
                    const statusIcon = statusClass === 'passed' ? '‚úì' : statusClass === 'failed' ? '‚úó' : '‚è≥';
                    const priorityColor = tc.priority === 'high' ? '#ef4444' : tc.priority === 'medium' ? '#f59e0b' : '#3b82f6';

                    html += `
                        <tr data-test-id="${tc.id}">
                            <td>
                                <input type="checkbox" class="test-case-checkbox" data-scenario="${idx}" data-test-id="${tc.id}" />
                            </td>
                            <td><code style="font-size: 11px;">${tc.id}</code></td>
                            <td>
                                <div style="font-weight: 500;">${tc.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${tc.description}</div>
                            </td>
                            <td><span style="font-size: 11px; padding: 3px 8px; background: #e0e7ff; border-radius: 4px;">${tc.type}</span></td>
                            <td><span style="font-size: 11px; padding: 3px 8px; background: ${priorityColor}22; color: ${priorityColor}; border-radius: 4px;">${tc.priority}</span></td>
                            <td><span class="health-check-status ${statusClass}">${statusIcon} ${statusClass}</span></td>
                            <td>
                                <button onclick="showTestCaseDetails('${tc.id}')" style="padding: 4px 8px; font-size: 12px;">View Details</button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="executeSelectedTests()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Execute Selected Tests
                        </button>
                        <button onclick="selectAllTests()" style="padding: 10px 20px; background: var(--secondary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Select All
                        </button>
                        <button onclick="deselectAllTests()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                            Deselect All
                        </button>
                    </div>
                </div>
            `;

            testCasesContainer.innerHTML = html;
        }

        function toggleScenarioTests(checkbox, scenarioIdx) {
            const checkboxes = document.querySelectorAll(`.test-case-checkbox[data-scenario="${scenarioIdx}"]`);
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function selectAllTests() {
            document.querySelectorAll('.test-case-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllTests() {
            document.querySelectorAll('.test-case-checkbox').forEach(cb => cb.checked = false);
        }

        // Removed duplicate executeSelectedTests - using the one at line 3110

        function showTestCaseDetails(testCaseId) {
            console.log('Showing details for test:', testCaseId);

            // Find the test case in the loaded data
            let testCase = null;
            if (window.testCasesData && window.testCasesData.scenarios) {
                for (const scenario of window.testCasesData.scenarios) {
                    const found = scenario.test_cases.find(tc => tc.id === testCaseId);
                    if (found) {
                        testCase = found;
                        break;
                    }
                }
            }

            if (!testCase) {
                showMessage(`Test case ${testCaseId} not found`, 'error');
                return;
            }

            // Create modal HTML
            const modalHtml = `
                <div id="testCaseModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="closeTestCaseModal(event)">
                    <div style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.2);" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                            <h2 style="margin: 0 0 8px 0; font-size: 20px; color: white;">${testCase.name}</h2>
                            <p style="margin: 0; opacity: 0.9; font-size: 14px;">${testCase.description}</p>
                        </div>

                        <!-- Content -->
                        <div style="padding: 24px;">
                            <!-- Metadata -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Test ID</div>
                                    <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${testCase.id}</code>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Type</div>
                                    <span style="background: #e0e7ff; color: #4338ca; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 500;">${testCase.type}</span>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Priority</div>
                                    <span style="background: ${testCase.priority === 'high' ? '#fee2e2' : testCase.priority === 'medium' ? '#fef3c7' : '#dbeafe'}; color: ${testCase.priority === 'high' ? '#991b1b' : testCase.priority === 'medium' ? '#92400e' : '#1e40af'}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 500;">${testCase.priority}</span>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Status</div>
                                    <span style="background: ${testCase.status === 'passed' ? '#d1fae5' : testCase.status === 'failed' ? '#fee2e2' : '#fef3c7'}; color: ${testCase.status === 'passed' ? '#065f46' : testCase.status === 'failed' ? '#991b1b' : '#92400e'}; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 500;">${testCase.status === 'passed' ? '‚úì Passed' : testCase.status === 'failed' ? '‚úó Failed' : '‚è≥ Pending'}</span>
                                </div>
                            </div>

                            <!-- Page URL -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Page URL</div>
                                <a href="${testCase.page_url}" target="_blank" style="color: #2563eb; font-size: 14px; text-decoration: none; word-break: break-all;">${testCase.page_url}</a>
                            </div>

                            <!-- Test Steps -->
                            <div style="margin-bottom: 24px;">
                                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #111827;">üìã Test Steps</div>
                                <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                    ${testCase.steps ? testCase.steps.map(step => `<li style="margin-bottom: 8px; color: #374151;">${step}</li>`).join('') : '<li>No steps defined</li>'}
                                </ol>
                            </div>

                            <!-- Expected Result -->
                            <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 16px;">
                                <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #065f46;">‚úì Expected Result</div>
                                <div style="color: #166534; font-size: 14px;">${testCase.expected_result || 'No expected result defined'}</div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; border-radius: 0 0 12px 12px; display: flex; justify-content: flex-end; gap: 12px;">
                            <button onclick="closeTestCaseModal()" style="padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; font-size: 14px;">Close</button>
                            <button onclick="runSingleTest('${testCase.id}')" style="padding: 8px 16px; border: none; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-size: 14px; font-weight: 500;">‚ñ∂Ô∏è Run This Test</button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('testCaseModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeTestCaseModal(event) {
            // Close if clicked outside the modal content or explicitly called
            if (!event || event.target.id === 'testCaseModal') {
                const modal = document.getElementById('testCaseModal');
                if (modal) {
                    modal.remove();
                }
            }
        }

        function runSingleTest(testCaseId) {
            // Select only this test case and execute
            deselectAllTestCases();
            const checkbox = document.querySelector(`.test-case-checkbox[data-test-id="${testCaseId}"]`);
            if (checkbox) {
                checkbox.checked = true;
                selectedTestCases.add(testCaseId);
                updateExecuteButtonState();
                closeTestCaseModal();
                // Scroll to execute button
                document.getElementById('execute_tests_btn')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateStatus(data) {
            document.getElementById('run_id_display')?.textContent || (document.getElementById('status_content').innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Run ID:</strong> ${data.run_id || '-'}</div>
                <div style="margin-bottom: 8px;"><strong>State:</strong> ${data.state || '-'}</div>
                <div style="margin-bottom: 8px;"><strong>URL:</strong> ${data.current_url || '-'}</div>
                <div class="progress-bar"><div class="progress-fill" style="width: ${data.progress || 0}%"></div></div>
            `);
            
            const badge = document.getElementById('status_badge');
            if (badge) {
                badge.textContent = data.state || '-';
                badge.className = 'status-badge ' + (data.state === 'DONE' ? 'active' : data.state === 'FAILED' ? 'error' : 'running');
            }

            if (data.current_url && data.current_url !== currentAppUrl) {
                currentAppUrl = data.current_url;
                const iframe = document.getElementById('app_iframe');
                const iframeBlocked = document.getElementById('iframe_blocked');
                if (iframeBlocked.classList.contains('hidden')) {
                    iframe.src = data.current_url;
                }
            }

            if (data.question) {
                currentQuestion = data.question;
                showQuestion(data.question);
            } else {
                document.getElementById('question_card').classList.add('hidden');
            }
        }

        function showQuestion(question) {
            const card = document.getElementById('question_card');
            const content = document.getElementById('question_content');
            card.classList.remove('hidden');
            content.innerHTML = `<div class="question-text">${question.text || ''}</div>`;
            
            if (question.type === 'select_one' && question.options) {
                const options = document.createElement('div');
                options.className = 'question-options';
                question.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-button';
                    btn.textContent = option.label || option.id;
                    btn.onclick = () => submitAnswer(question.id, option.id);
                    options.appendChild(btn);
                });
                content.appendChild(options);
            } else if (question.type === 'confirm') {
                const buttons = document.createElement('div');
                buttons.style.cssText = 'display: flex; gap: 10px;';
                ['Yes', 'No'].forEach(answer => {
                    const btn = document.createElement('button');
                    btn.className = answer === 'Yes' ? 'btn-success' : 'btn-danger';
                    btn.textContent = answer;
                    btn.onclick = () => submitAnswer(question.id, answer.toLowerCase());
                    buttons.appendChild(btn);
                });
                content.appendChild(buttons);
            }
        }

        async function submitAnswer(questionId, answer) {
            if (!currentRunId) return;
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: questionId, answer })
                });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                showMessage('Answer submitted', 'success');
                updateStatus(data);
            } catch (error) {
                showMessage(`Failed: ${error.message}`, 'error');
            }
        }

        async function submitFreeText() {
            const input = document.getElementById('free_text_input');
            const text = input.value.trim();
            if (!text || !currentRunId) {
                showMessage('Please enter a question', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_id: 'free_text', answer: text })
                });
                if (!response.ok) throw new Error(await response.text());
                input.value = '';
                showMessage('Message sent', 'success');
            } catch (error) {
                showMessage(`Failed: ${error.message}`, 'error');
            }
        }

        function loadAppInIframe(baseUrl, currentUrl = null) {
            const iframe = document.getElementById('app_iframe');
            const iframeBlocked = document.getElementById('iframe_blocked');
            const urlToLoad = currentUrl || baseUrl;
            
            if (!urlToLoad || urlToLoad === 'about:blank') {
                // Show placeholder if no URL
                iframeBlocked.classList.remove('hidden');
                iframe.classList.add('hidden');
                iframeBlocked.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üåê</div>
                        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 16px;">Application will appear here</p>
                        <p style="color: var(--text-secondary); font-size: 14px; max-width: 400px; margin: 0 auto;">
                            Enter a base URL and start discovery to view your application.
                        </p>
                    </div>
                `;
                return;
            }
            
            currentAppUrl = urlToLoad;
            iframeBlocked.classList.add('hidden');
            iframe.classList.remove('hidden');
            iframe.src = urlToLoad;
            
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'iframe_loading';
            loadingDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;';
            loadingDiv.innerHTML = '<div class="loading" style="width: 32px; height: 32px; margin: 0 auto 12px;"></div><p style="color: var(--text-secondary);">Loading application...</p>';
            iframe.parentElement.style.position = 'relative';
            iframe.parentElement.appendChild(loadingDiv);
            
            setTimeout(() => {
                try {
                    iframe.contentDocument;
                    // Iframe loaded successfully
                    const loading = document.getElementById('iframe_loading');
                    if (loading) loading.remove();
                } catch (e) {
                    // X-Frame-Options blocked
                    const loading = document.getElementById('iframe_loading');
                    if (loading) loading.remove();
                    iframeBlocked.classList.remove('hidden');
                    iframe.classList.add('hidden');
                }
            }, 2000);
        }

        function checkReportAvailable() {
            if (!currentRunId) return;
            fetch(`${API_BASE}/runs/${currentRunId}/report`)
                .then(r => {
                    if (r.ok) {
                        document.getElementById('report_card').classList.remove('hidden');
                        const viewReportBtn = document.getElementById('view_report_btn');
                        if (viewReportBtn) viewReportBtn.style.display = 'inline-flex';
                        // Also show report button in Application tab
                        const appReportBtn = document.getElementById('app_view_report_btn');
                        if (appReportBtn) appReportBtn.style.display = 'inline-flex';
                    }
                })
                .catch(() => {});
        }

        function openReport() {
            if (currentRunId) window.open(`${API_BASE}/runs/${currentRunId}/report`, '_blank');
        }

        function showMessage(message, type) {
            const area = document.getElementById('message_area');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            area.innerHTML = '';
            area.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function displayImageAnalysis(results) {
            // Create or update analysis display card
            let analysisCard = document.getElementById('image_analysis_card');
            if (!analysisCard) {
                analysisCard = document.createElement('div');
                analysisCard.id = 'image_analysis_card';
                analysisCard.className = 'card';
                analysisCard.style.marginTop = '20px';
                document.getElementById('tab-media').appendChild(analysisCard);
            }
            
            let html = '<div class="card-header"><h2 class="card-title"><span class="icon">üîç</span> Image Analysis Results</h2></div>';
            html += '<div style="padding: 16px;">';
            
            results.forEach((result, idx) => {
                html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">`;
                html += `<strong>${result.filename}</strong><br>`;
                html += `<div style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);">`;
                html += `üìä UI Elements: ${result.ui_elements || 0}<br>`;
                html += `üß© Components: ${result.components?.join(', ') || 'None'}<br>`;
                html += `üîÑ Workflows: ${result.workflows || 0}`;
                html += `</div></div>`;
            });
            
            html += '</div>';
            analysisCard.innerHTML = html;
        }

        // Initialize on page load
        async function initializePage() {
            console.log('üîÑ Initializing page...');

            // Check URL parameters for run_id (e.g., ?run_id=1ef5f62c-c1d)
            const urlParams = new URLSearchParams(window.location.search);
            const urlRunId = urlParams.get('run_id');

            if (urlRunId) {
                console.log('üìå Found run ID in URL:', urlRunId);
                currentRunId = urlRunId;
                localStorage.setItem('currentRunId', currentRunId);
                updateCurrentRunIndicator();
            }

            // Check if we have a saved run ID
            if (currentRunId) {
                console.log('üìå Using run ID:', currentRunId);
                updateCurrentRunIndicator();

                // Reset cursor to 0 to replay all events from beginning (ensures we don't miss anything on refresh)
                eventsCursor = 0;

                // Fetch current run status
                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/status`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Run status:', data.state);

                        // Update UI with current status
                        updateStatus(data);

                        // Only start polling if discovery is still in progress (not DONE or FAILED)
                        if (data.state !== 'DONE' && data.state !== 'FAILED') {
                            console.log('üîÑ Discovery in progress, resuming polling...');
                            startPolling();
                            startEventsPolling();
                            startTestCasesPolling();

                            // Show status card and stop button
                            document.getElementById('status_card').classList.remove('hidden');
                            document.getElementById('free_text_card').classList.remove('hidden');
                            document.getElementById('stop_btn').classList.remove('hidden');
                        } else {
                            // Discovery is complete, just fetch final data (no polling needed)
                            console.log('‚úÖ Discovery complete, fetching final data (no polling)...');
                            fetchAndDisplayFeatures();
                            fetchTestCases();
                            checkReportAvailable();
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Saved run ID not found on server, clearing...');
                        localStorage.removeItem('currentRunId');
                        currentRunId = null;
                    }
                } catch (error) {
                    console.error('‚ùå Failed to fetch run status:', error);
                }
            } else {
                console.log('‚ÑπÔ∏è No saved run ID, waiting for user to start discovery');
            }
        }

        // Call initialization when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializePage();
                loadRunHistory();
            });
        } else {
            initializePage();
            loadRunHistory();
        }
        </script>

        <!-- Test Execution Popup Modal -->
        <div id="test_execution_modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);" onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0;">üöÄ Execute Test Cases</h2>
                    <button onclick="closeTestExecutionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>
                
                <!-- Selected Test Cases Summary -->
                <div id="selected_test_cases_summary" style="margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">üìã Selected Test Cases</h3>
                        <span id="selected_count_badge" style="padding: 4px 12px; background: var(--primary); color: white; border-radius: 12px; font-size: 12px; font-weight: 600;">0 selected</span>
                    </div>
                    <div id="selected_test_cases_list" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Loading test case details...</p>
                    </div>
                </div>
                
                <form id="test_execution_form" onsubmit="submitTestExecution(event)">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Test Run Name *</label>
                        <input type="text" id="execution_name" required placeholder="e.g., Smoke Tests - 2024-01-25" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Description</label>
                        <textarea id="execution_description" placeholder="Optional description for this test run" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Application URL *</label>
                        <input type="url" id="execution_base_url" required placeholder="https://your-app.example.com" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 6px;">
                            Base URL of the application to test. Pre-filled from discovery run if available.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Environment</label>
                        <select id="execution_environment" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                            <option value="staging">Staging</option>
                            <option value="dev">Development</option>
                            <option value="prod">Production</option>
                            <option value="qa">QA</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Browser Mode *</label>
                        <select id="execution_headless" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                            <option value="true">Headless (No UI - Faster)</option>
                            <option value="false">UI Mode (Visible Browser - For Debugging)</option>
                        </select>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 6px;">
                            <strong>Headless:</strong> Runs faster, no browser window. <strong>UI Mode:</strong> Shows browser window for debugging.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: var(--text-primary);">üîê Authentication Credentials</span>
                            <span id="credentials_status" style="font-size: 12px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-weight: 600;">Loading...</span>
                        </div>
                        <div id="credentials_info" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;"></div>
                        
                        <div id="credentials_inputs" style="display: none;">
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: var(--text-primary); font-size: 13px;">Username *</label>
                                <input type="text" id="execution_username" required placeholder="Enter username" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 6px; color: var(--text-primary); font-size: 13px;">Password *</label>
                                <input type="password" id="execution_password" required placeholder="Enter password" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" onclick="closeTestExecutionModal()" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-primary);">Cancel</button>
                        <button type="submit" id="submit_execution_btn" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">‚ñ∂Ô∏è Start Execution</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
        // Test Execution Modal Functions
        let pendingTestCaseIds = [];
        
        async function openTestExecutionModal() {
            if (selectedTestCases.size === 0 || !currentRunId) {
                showMessage('Please select at least one test case to run', 'error');
                return;
            }
            
            // Check if modal element exists
            const modal = document.getElementById('test_execution_modal');
            if (!modal) {
                console.error('Test execution modal not found in DOM');
                showMessage('Error: Test execution modal not found', 'error');
                return;
            }
            
            console.log('Opening test execution modal', { 
                selectedCount: selectedTestCases.size, 
                pendingIds: Array.from(selectedTestCases),
                modalExists: !!modal 
            });
            
            pendingTestCaseIds = Array.from(selectedTestCases);
            
            // Show modal
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            
            // Set default execution name
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const nameInput = document.getElementById('execution_name');
            if (nameInput) {
                nameInput.value = `Test Run - ${dateStr} ${now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}`;
            }
            
            // Update selected count badge
            const countBadge = document.getElementById('selected_count_badge');
            if (countBadge) {
                countBadge.textContent = `${pendingTestCaseIds.length} selected`;
            }
            
            // Set default headless mode (use discovery run's headless setting if available)
            const headlessSelect = document.getElementById('execution_headless');
            if (headlessSelect) {
                // Default to headless=true (faster)
                headlessSelect.value = 'true';
            }
            
            // Load base URL and credentials from discovery run
            await loadDiscoveryRunDetails();
            
            // Load and display selected test case details
            await loadSelectedTestCasesDetails();
            
            // Note: loadDiscoveryCredentials is now called from loadDiscoveryRunDetails
        }
        
        async function loadSelectedTestCasesDetails() {
            const listContainer = document.getElementById('selected_test_cases_list');
            if (!listContainer || !currentRunId) return;
            
            listContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Loading test case details...</p>';
            
            try {
                // Load test cases from test_cases.json
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/test-cases`);
                if (!response.ok) {
                    throw new Error('Failed to load test cases');
                }
                
                const testCasesData = await response.json();
                const allTestCases = [];
                
                // Flatten all test cases from scenarios
                if (testCasesData.scenarios && Array.isArray(testCasesData.scenarios)) {
                    testCasesData.scenarios.forEach(scenario => {
                        if (scenario.test_cases && Array.isArray(scenario.test_cases)) {
                            scenario.test_cases.forEach(tc => {
                                allTestCases.push({
                                    ...tc,
                                    scenario_name: scenario.scenario_name || 'Unknown Scenario'
                                });
                            });
                        }
                    });
                }
                
                // Filter to only selected test cases
                const selectedDetails = [];
                pendingTestCaseIds.forEach(testCaseId => {
                    // Test ID might be in format: scenario_X_Y or just the ID
                    const found = allTestCases.find(tc => {
                        const tcId = tc.id || tc.test_id;
                        // Check if testCaseId matches tc.id, or if it's in format scenario_X_Y
                        return tcId === testCaseId || 
                               testCaseId.endsWith(`_${tcId}`) ||
                               testCaseId === `${tc.scenario_name}_${tcId}`;
                    });
                    
                    if (found) {
                        selectedDetails.push(found);
                    } else {
                        // If not found, create a basic entry
                        selectedDetails.push({
                            id: testCaseId,
                            name: testCaseId,
                            type: 'unknown',
                            priority: 'medium',
                            scenario_name: 'Unknown',
                            steps: []
                        });
                    }
                });
                
                // Display selected test cases
                if (selectedDetails.length === 0) {
                    listContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px; margin: 0;">No test case details found.</p>';
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                
                selectedDetails.forEach((tc, idx) => {
                    const statusColors = {
                        'passed': { bg: '#d1fae5', color: '#065f46', icon: '‚úÖ' },
                        'failed': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                        'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è∏Ô∏è' },
                        'running': { bg: '#dbeafe', color: '#1e40af', icon: '‚è≥' }
                    };
                    const status = tc.status || 'pending';
                    const statusStyle = statusColors[status] || statusColors['pending'];
                    const priorityColor = tc.priority === 'high' ? '#ef4444' : tc.priority === 'medium' ? '#f59e0b' : '#3b82f6';
                    
                    html += `
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                        <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">${tc.name || tc.test_name || tc.id || 'Unnamed Test'}</span>
                                        <span style="padding: 2px 8px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 8px; font-size: 10px; font-weight: 600;">
                                            ${statusStyle.icon} ${status.toUpperCase()}
                                        </span>
                                        <span style="padding: 2px 8px; background: ${priorityColor}22; color: ${priorityColor}; border-radius: 8px; font-size: 10px; font-weight: 600;">
                                            ${(tc.priority || 'medium').toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                                        <strong>ID:</strong> ${tc.id || tc.test_id || 'N/A'} | 
                                        <strong>Type:</strong> ${(tc.type || tc.test_type || 'unknown').replace(/_/g, ' ')} | 
                                        <strong>Scenario:</strong> ${tc.scenario_name || 'Unknown'}
                                    </div>
                                    ${tc.description ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">${tc.description}</div>` : ''}
                                    ${tc.steps && tc.steps.length > 0 ? `
                                        <details style="margin-top: 8px;">
                                            <summary style="font-size: 12px; color: var(--primary); cursor: pointer; font-weight: 600;">View Steps (${tc.steps.length})</summary>
                                            <ol style="margin: 8px 0 0 16px; padding-left: 8px; font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                                                ${tc.steps.map((step, stepIdx) => `<li style="margin-bottom: 4px;">${step}</li>`).join('')}
                                            </ol>
                                        </details>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                listContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Failed to load test case details:', error);
                listContainer.innerHTML = `<p style="color: #dc2626; font-size: 14px; margin: 0;">Error loading test case details: ${error.message}</p>`;
            }
        }
        
        function closeTestExecutionModal() {
            document.getElementById('test_execution_modal').style.display = 'none';
            pendingTestCaseIds = [];
        }
        
        async function loadDiscoveryRunDetails() {
            const baseUrlInput = document.getElementById('execution_base_url');
            const statusEl = document.getElementById('credentials_status');
            const infoEl = document.getElementById('credentials_info');
            const inputsDiv = document.getElementById('credentials_inputs');
            const usernameInput = document.getElementById('execution_username');
            const passwordInput = document.getElementById('execution_password');
            
            statusEl.textContent = 'Loading...';
            statusEl.style.background = '#dbeafe';
            statusEl.style.color = '#1e40af';
            
            try {
                // Get discovery run status to check for base URL and credentials
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/status`);
                if (!response.ok) throw new Error('Failed to load run status');
                
                const data = await response.json();
                
                // Pre-fill base URL from discovery run
                if (data.base_url && baseUrlInput) {
                    baseUrlInput.value = data.base_url;
                }
                
                // Check if credentials exist in discovery run
                if (data.auth && data.auth.username) {
                    // Credentials found - pre-fill
                    usernameInput.value = data.auth.username;
                    passwordInput.value = data.auth.password || '';
                    
                    statusEl.textContent = 'Found';
                    statusEl.style.background = '#d1fae5';
                    statusEl.style.color = '#065f46';
                    infoEl.textContent = `Using credentials from discovery run. You can modify if needed.`;
                    infoEl.style.color = '#059669';
                    inputsDiv.style.display = 'block';
                    
                    // Make password required only if not provided
                    if (!data.auth.password) {
                        passwordInput.required = true;
                        passwordInput.placeholder = 'Password not saved - please enter';
                    } else {
                        passwordInput.required = false;
                    }
                } else {
                    // No credentials - ask user to provide
                    statusEl.textContent = 'Not Found';
                    statusEl.style.background = '#fee2e2';
                    statusEl.style.color = '#991b1b';
                    infoEl.textContent = `No credentials found in discovery run. Please provide authentication credentials.`;
                    infoEl.style.color = '#dc2626';
                    inputsDiv.style.display = 'block';
                    usernameInput.required = true;
                    passwordInput.required = true;
                }
            } catch (error) {
                console.error('Failed to load credentials:', error);
                statusEl.textContent = 'Error';
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
                infoEl.textContent = `Could not load credentials. Please provide them below.`;
                infoEl.style.color = '#dc2626';
                inputsDiv.style.display = 'block';
                usernameInput.required = true;
                passwordInput.required = true;
            }
        }
        
        async function submitTestExecution(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit_execution_btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Starting...';
            
            try {
                // Extract actual test case IDs from the selected test cases
                // Load test cases to get the actual IDs
                let actualTestIds = pendingTestCaseIds;
                
                try {
                    const response = await fetch(`${API_BASE}/runs/${currentRunId}/test-cases`);
                    if (response.ok) {
                        const testCasesData = await response.json();
                        const allTestCases = [];
                        
                        // Flatten all test cases from scenarios
                        if (testCasesData.scenarios && Array.isArray(testCasesData.scenarios)) {
                            testCasesData.scenarios.forEach(scenario => {
                                if (scenario.test_cases && Array.isArray(scenario.test_cases)) {
                                    scenario.test_cases.forEach(tc => {
                                        allTestCases.push(tc);
                                    });
                                }
                            });
                        }
                        
                        // Map selected IDs to actual test case IDs
                        actualTestIds = [];
                        pendingTestCaseIds.forEach(testCaseId => {
                            // Try to find matching test case
                            const found = allTestCases.find(tc => {
                                const tcId = tc.id || tc.test_id;
                                // Check various formats
                                return tcId === testCaseId || 
                                       testCaseId.endsWith(`_${tcId}`) ||
                                       testCaseId === `${tc.scenario_name}_${tcId}` ||
                                       testCaseId.includes(tcId);
                            });
                            
                            if (found) {
                                // Use the actual ID from the test case
                                actualTestIds.push(found.id || found.test_id || testCaseId);
                            } else {
                                // Fallback: try to extract ID from format scenario_X_Y or feature_name_test_id
                                const parts = testCaseId.split('_');
                                if (parts.length > 1) {
                                    // Try last part as ID
                                    actualTestIds.push(parts[parts.length - 1]);
                                } else {
                                    actualTestIds.push(testCaseId);
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.warn('Could not load test cases for ID mapping, using original IDs:', e);
                    // Use original IDs, backend will try to match them
                }
                
                const baseUrlInput = document.getElementById('execution_base_url');
                if (!baseUrlInput || !baseUrlInput.value.trim()) {
                    showMessage('Please provide the application URL', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚ñ∂Ô∏è Start Execution';
                    return;
                }
                
                const executionData = {
                    test_case_ids: actualTestIds,
                    execution_name: document.getElementById('execution_name').value,
                    description: document.getElementById('execution_description').value,
                    base_url: baseUrlInput.value.trim(),
                    environment: document.getElementById('execution_environment').value,
                    username: document.getElementById('execution_username').value,
                    password: document.getElementById('execution_password').value,
                    headless: document.getElementById('execution_headless').value === 'true'
                };
                
                const response = await fetch(`${API_BASE}/runs/${currentRunId}/execute-tests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(executionData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                closeTestExecutionModal();
                showMessage(`‚úÖ Test execution started! Execution ID: ${data.execution_id}`, 'success');
                showCompletionNotification(`Test execution started! Check Test Execution History tab.`, 'success');
                
                // Switch to Test Execution History tab
                setTimeout(() => {
                    switchAppTab('execution-history');
                    loadTestExecutionHistory();
                }, 1000);
                
                // Refresh test cases
                fetchAndDisplayFeatures();
                
            } catch (error) {
                console.error('Test execution error:', error);
                showMessage(`Failed to start test execution: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '‚ñ∂Ô∏è Start Execution';
            }
        }
        
        // Close modal when clicking outside
        document.getElementById('test_execution_modal')?.addEventListener('click', function(e) {
            if (e.target.id === 'test_execution_modal') {
                closeTestExecutionModal();
            }
        });
        // AI Configuration Toggle Functions
        function toggleAIConfig() {
            const aiEnabled = document.getElementById('ai_enabled').checked;
            const aiConfigSection = document.getElementById('ai_config_section');
            if (aiConfigSection) {
                aiConfigSection.style.display = aiEnabled ? 'block' : 'none';
                if (aiEnabled) {
                    toggleProviderConfig(); // Update provider-specific config visibility
                }
            }
        }

        function toggleProviderConfig() {
            const provider = document.getElementById('ai_provider')?.value || 'none';
            const ollamaConfig = document.getElementById('ollama_config');
            const openaiConfig = document.getElementById('openai_config');
            
            if (ollamaConfig) {
                ollamaConfig.style.display = provider === 'ollama' ? 'block' : 'none';
            }
            if (openaiConfig) {
                openaiConfig.style.display = provider === 'openai' ? 'block' : 'none';
            }
        }

        // Initialize AI config visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleAIConfig();
        });

        // Show AI Capabilities Modal/Info
        function showCapabilities() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.2s;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 700;">‚ú® AI-Powered Test Generation</h2>
                            <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">√ó</button>
                        </div>
                        <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Discover how AI enhances your test coverage</p>
                    </div>
                    
                    <div style="padding: 24px;">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span>üéØ</span> What AI Adds
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="padding: 14px; background: #f8fafc; border-left: 4px solid var(--primary); border-radius: 6px;">
                                    <strong style="display: block; margin-bottom: 6px; color: var(--text-primary);">Contextual Intelligence</strong>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                                        AI understands the purpose of each page and generates tests that match real-world usage scenarios, not just generic patterns.
                                    </p>
                                </div>
                                
                                <div style="padding: 14px; background: #f8fafc; border-left: 4px solid var(--success); border-radius: 6px;">
                                    <strong style="display: block; margin-bottom: 6px; color: var(--text-primary);">Comprehensive Edge Cases</strong>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                                        Automatically identifies edge cases: special characters, empty inputs, boundary values, SQL injection attempts, unicode handling, and more.
                                    </p>
                                </div>
                                
                                <div style="padding: 14px; background: #f8fafc; border-left: 4px solid var(--info); border-radius: 6px;">
                                    <strong style="display: block; margin-bottom: 6px; color: var(--text-primary);">2-3x More Test Coverage</strong>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                                        Rule-based: ~10-15 tests per page. AI-powered: ~20-30 tests per page with better quality and edge cases.
                                    </p>
                                </div>
                                
                                <div style="padding: 14px; background: #f8fafc; border-left: 4px solid var(--warning); border-radius: 6px;">
                                    <strong style="display: block; margin-bottom: 6px; color: var(--text-primary);">Workflow Understanding</strong>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                                        Creates end-to-end test workflows (e.g., "Create VM ‚Üí Verify in list ‚Üí Edit ‚Üí Delete") instead of isolated test cases.
                                    </p>
                                </div>
                                
                                <div style="padding: 14px; background: #f8fafc; border-left: 4px solid var(--secondary); border-radius: 6px;">
                                    <strong style="display: block; margin-bottom: 6px; color: var(--text-primary);">Realistic Test Data</strong>
                                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">
                                        Generates appropriate test data: valid emails for email fields, proper date formats, realistic names, context-aware values.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.2);">
                            <h3 style="font-size: 16px; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span>üìä</span> Example Comparison
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div>
                                    <strong style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Rule-Based (5 tests):</strong>
                                    <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                                        <li>Navigate to page</li>
                                        <li>Verify table visible</li>
                                        <li>Test search with "test"</li>
                                        <li>Test pagination</li>
                                        <li>Test filters</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: var(--primary); display: block; margin-bottom: 8px;">AI-Powered (15+ tests):</strong>
                                    <ul style="margin: 0; padding-left: 20px; color: var(--text-primary); line-height: 1.8;">
                                        <li>All rule-based tests, plus:</li>
                                        <li>Search with special chars</li>
                                        <li>Search with empty string</li>
                                        <li>SQL injection attempts</li>
                                        <li>Filter combinations</li>
                                        <li>Error handling</li>
                                        <li>Workflow tests</li>
                                        <li>And more...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 16px; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <span>‚öôÔ∏è</span> How It Works
                            </h3>
                            <div style="padding: 16px; background: #f8fafc; border-radius: 8px; font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                <p style="margin-bottom: 10px;"><strong style="color: var(--text-primary);">1. Discovery Phase:</strong> QA Buddy crawls your app and collects page information (unchanged).</p>
                                <p style="margin-bottom: 10px;"><strong style="color: var(--text-primary);">2. Test Generation:</strong> If AI enabled, the system sends page details to the AI model (Ollama or OpenAI).</p>
                                <p style="margin-bottom: 10px;"><strong style="color: var(--text-primary);">3. AI Analysis:</strong> The model analyzes the page structure, features, and context to generate comprehensive test cases.</p>
                                <p style="margin-bottom: 10px;"><strong style="color: var(--text-primary);">4. Merging:</strong> In Hybrid mode, AI tests are merged with rule-based tests (removes duplicates).</p>
                                <p style="margin: 0;"><strong style="color: var(--text-primary);">5. Execution:</strong> All tests (rule-based + AI) are executed normally.</p>
                            </div>
                        </div>
                        
                        <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">
                            <p style="font-size: 13px; color: var(--text-primary); margin: 0; line-height: 1.6;">
                                <strong>‚úÖ Backward Compatible:</strong> Everything works exactly as before if AI is disabled. AI is completely optional and enhances existing functionality.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
